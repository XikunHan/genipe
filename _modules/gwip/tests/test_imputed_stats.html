

<!doctype html>


<html xmlns="http://www.w3.org/1999/xhtml">
  <head>
    <meta http-equiv="Content-Type" content="text/html; charset=utf-8" />
    
    <title>gwip.tests.test_imputed_stats &mdash; gwip 1.0.0 documentation</title>
    
    <link rel="stylesheet" href="../../../_static/bizstyle.css" type="text/css" />
    <link rel="stylesheet" href="../../../_static/pygments.css" type="text/css" />
    
    <script type="text/javascript">
      var DOCUMENTATION_OPTIONS = {
        URL_ROOT:    '../../../',
        VERSION:     '1.0.0',
        COLLAPSE_INDEX: false,
        FILE_SUFFIX: '.html',
        HAS_SOURCE:  true
      };
    </script>
    <script type="text/javascript" src="../../../_static/jquery.js"></script>
    <script type="text/javascript" src="../../../_static/underscore.js"></script>
    <script type="text/javascript" src="../../../_static/doctools.js"></script>
    <script type="text/javascript" src="https://cdn.mathjax.org/mathjax/latest/MathJax.js?config=TeX-AMS-MML_HTMLorMML"></script>
    <script type="text/javascript" src="../../../_static/bizstyle.js"></script>
    <link rel="top" title="gwip 1.0.0 documentation" href="../../../index.html" />
    <link rel="up" title="gwip" href="../../gwip.html" />
    <meta name="viewport" content="width=device-width,initial-scale=1.0">
    <!--[if lt IE 9]>
    <script type="text/javascript" src="_static/css3-mediaqueries.js"></script>
    <![endif]-->
  </head>
  <body role="document">
    <div class="related" role="navigation" aria-label="related navigation">
      <h3>Navigation</h3>
      <ul>
        <li class="right" style="margin-right: 10px">
          <a href="../../../genindex.html" title="General Index"
             accesskey="I">index</a></li>
        <li class="right" >
          <a href="../../../py-modindex.html" title="Python Module Index"
             >modules</a> |</li>
        <li class="nav-item nav-item-0"><a href="../../../index.html">gwip 1.0.0 documentation</a> &raquo;</li>
          <li class="nav-item nav-item-1"><a href="../../index.html" >Module code</a> &raquo;</li>
          <li class="nav-item nav-item-2"><a href="../../gwip.html" accesskey="U">gwip</a> &raquo;</li> 
      </ul>
    </div>
      <div class="sphinxsidebar" role="navigation" aria-label="main navigation">
        <div class="sphinxsidebarwrapper">
<div id="searchbox" style="display: none" role="search">
  <h3>Quick search</h3>
    <form class="search" action="../../../search.html" method="get">
      <input type="text" name="q" />
      <input type="submit" value="Go" />
      <input type="hidden" name="check_keywords" value="yes" />
      <input type="hidden" name="area" value="default" />
    </form>
    <p class="searchtip" style="font-size: 90%">
    Enter search terms or a module, class or function name.
    </p>
</div>
<script type="text/javascript">$('#searchbox').show(0);</script>
        </div>
      </div>

    <div class="document">
      <div class="documentwrapper">
        <div class="bodywrapper">
          <div class="body" role="main">
            
  <h1>Source code for gwip.tests.test_imputed_stats</h1><div class="highlight"><pre>
<span class="c"># This file is part of gwip.</span>
<span class="c">#</span>
<span class="c"># This work is licensed under the Creative Commons Attribution-NonCommercial</span>
<span class="c"># 4.0 International License. To view a copy of this license, visit</span>
<span class="c"># http://creativecommons.org/licenses/by-nc/4.0/ or send a letter to Creative</span>
<span class="c"># Commons, PO Box 1866, Mountain View, CA 94042, USA.</span>


<span class="kn">import</span> <span class="nn">random</span>
<span class="kn">import</span> <span class="nn">platform</span>
<span class="kn">import</span> <span class="nn">unittest</span>
<span class="kn">from</span> <span class="nn">tempfile</span> <span class="kn">import</span> <span class="n">TemporaryDirectory</span>

<span class="kn">import</span> <span class="nn">numpy</span> <span class="kn">as</span> <span class="nn">np</span>
<span class="kn">import</span> <span class="nn">pandas</span> <span class="kn">as</span> <span class="nn">pd</span>
<span class="kn">from</span> <span class="nn">pkg_resources</span> <span class="kn">import</span> <span class="n">resource_filename</span>

<span class="kn">from</span> <span class="nn">..tools.imputed_stats</span> <span class="kn">import</span> <span class="o">*</span>
<span class="kn">from</span> <span class="nn">..tools.imputed_stats</span> <span class="kn">import</span> <span class="n">_get_result_from_linear_logistic</span>

<span class="k">if</span> <span class="n">HAS_STATSMODELS</span><span class="p">:</span>
    <span class="c"># patsy is installed only if statsmodels is</span>
    <span class="kn">import</span> <span class="nn">patsy</span>


<span class="n">__author__</span> <span class="o">=</span> <span class="p">[</span><span class="s">&quot;Louis-Philippe Lemieux Perreault&quot;</span><span class="p">,</span> <span class="s">&quot;Marc-Andre Legault&quot;</span><span class="p">]</span>
<span class="n">__copyright__</span> <span class="o">=</span> <span class="s">&quot;Copyright 2014, Beaulieu-Saucier Pharmacogenomics Centre&quot;</span>
<span class="n">__license__</span> <span class="o">=</span> <span class="s">&quot;Attribution-NonCommercial 4.0 International (CC BY-NC 4.0)&quot;</span>


<span class="n">__all__</span> <span class="o">=</span> <span class="p">[</span><span class="s">&quot;TestImputedStats&quot;</span><span class="p">,</span> <span class="s">&quot;TestImputedStatsCox&quot;</span><span class="p">,</span> <span class="s">&quot;TestImputedStatsLinear&quot;</span><span class="p">,</span>
           <span class="s">&quot;TestImputedStatsLogistic&quot;</span><span class="p">]</span>


<span class="k">def</span> <span class="nf">clean_logging_handlers</span><span class="p">():</span>
    <span class="n">handlers</span> <span class="o">=</span> <span class="nb">list</span><span class="p">(</span><span class="n">logging</span><span class="o">.</span><span class="n">root</span><span class="o">.</span><span class="n">handlers</span><span class="p">)</span>
    <span class="k">for</span> <span class="n">handler</span> <span class="ow">in</span> <span class="n">handlers</span><span class="p">:</span>
        <span class="n">logging</span><span class="o">.</span><span class="n">root</span><span class="o">.</span><span class="n">removeHandler</span><span class="p">(</span><span class="n">handler</span><span class="p">)</span>


<span class="k">def</span> <span class="nf">reverse_dosage</span><span class="p">(</span><span class="n">dosage</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;Finds values for d1, d2 and d3 from dosage.&quot;&quot;&quot;</span>
    <span class="n">d1</span><span class="p">,</span> <span class="n">d2</span><span class="p">,</span> <span class="n">d3</span> <span class="o">=</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">0</span>
    <span class="k">if</span> <span class="n">np</span><span class="o">.</span><span class="n">isnan</span><span class="p">(</span><span class="n">dosage</span><span class="p">):</span>
        <span class="n">d1</span> <span class="o">=</span> <span class="n">random</span><span class="o">.</span><span class="n">uniform</span><span class="p">(</span><span class="mf">0.5</span><span class="p">,</span> <span class="mf">0.8</span><span class="p">)</span>
        <span class="n">d2</span> <span class="o">=</span> <span class="n">random</span><span class="o">.</span><span class="n">uniform</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="mf">0.2</span><span class="p">)</span>
        <span class="n">d3</span> <span class="o">=</span> <span class="mi">1</span> <span class="o">-</span> <span class="n">d1</span> <span class="o">-</span> <span class="n">d2</span>

    <span class="k">elif</span> <span class="n">dosage</span> <span class="o">==</span> <span class="mi">1</span><span class="p">:</span>
        <span class="n">d1</span> <span class="o">=</span> <span class="mi">0</span>
        <span class="n">d2</span> <span class="o">=</span> <span class="n">dosage</span>
        <span class="n">d3</span> <span class="o">=</span> <span class="mi">0</span>

    <span class="k">elif</span> <span class="n">dosage</span> <span class="o">==</span> <span class="mi">2</span><span class="p">:</span>
        <span class="n">d1</span> <span class="o">=</span> <span class="mi">0</span>
        <span class="n">d2</span> <span class="o">=</span> <span class="mi">0</span>
        <span class="n">d3</span> <span class="o">=</span> <span class="mi">1</span>

    <span class="k">elif</span> <span class="n">dosage</span> <span class="o">&lt;</span> <span class="mi">1</span><span class="p">:</span>
        <span class="n">d2</span> <span class="o">=</span> <span class="n">dosage</span>
        <span class="n">d1</span> <span class="o">=</span> <span class="mi">1</span> <span class="o">-</span> <span class="n">d2</span>
        <span class="n">d3</span> <span class="o">=</span> <span class="mi">0</span>

    <span class="k">elif</span> <span class="n">dosage</span> <span class="o">&gt;</span> <span class="mf">1.5</span><span class="p">:</span>
        <span class="n">d1</span> <span class="o">=</span> <span class="mi">0</span>
        <span class="n">d3</span> <span class="o">=</span> <span class="n">random</span><span class="o">.</span><span class="n">uniform</span><span class="p">(</span><span class="mf">0.98</span><span class="p">,</span> <span class="mi">1</span><span class="p">)</span>
        <span class="n">d2</span> <span class="o">=</span> <span class="p">((</span><span class="n">dosage</span> <span class="o">/</span> <span class="mi">2</span><span class="p">)</span> <span class="o">-</span> <span class="n">d3</span><span class="p">)</span> <span class="o">*</span> <span class="mi">2</span>

    <span class="k">else</span><span class="p">:</span>
        <span class="n">d1</span> <span class="o">=</span> <span class="mi">0</span>
        <span class="n">d2</span> <span class="o">=</span> <span class="n">random</span><span class="o">.</span><span class="n">uniform</span><span class="p">(</span><span class="mf">0.98</span><span class="p">,</span> <span class="mi">1</span><span class="p">)</span>
        <span class="n">d3</span> <span class="o">=</span> <span class="p">(</span><span class="n">dosage</span> <span class="o">-</span> <span class="n">d2</span><span class="p">)</span> <span class="o">/</span> <span class="mi">2</span>

    <span class="k">return</span> <span class="n">d1</span><span class="p">,</span> <span class="n">d2</span><span class="p">,</span> <span class="n">d3</span>


<span class="k">def</span> <span class="nf">create_input_files</span><span class="p">(</span><span class="n">i_filename</span><span class="p">,</span> <span class="n">output_dirname</span><span class="p">,</span> <span class="n">analysis_type</span><span class="p">,</span>
                       <span class="n">pheno_name</span><span class="o">=</span><span class="s">&quot;y&quot;</span><span class="p">,</span> <span class="n">tte</span><span class="o">=</span><span class="s">&quot;y&quot;</span><span class="p">,</span> <span class="n">event</span><span class="o">=</span><span class="s">&quot;y_d&quot;</span><span class="p">,</span>
                       <span class="n">interaction</span><span class="o">=</span><span class="bp">None</span><span class="p">,</span> <span class="n">nb_process</span><span class="o">=</span><span class="bp">None</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;Creates input files for the imputed_stats script.&quot;&quot;&quot;</span>
    <span class="c"># Reading the data</span>
    <span class="n">data</span> <span class="o">=</span> <span class="n">pd</span><span class="o">.</span><span class="n">read_csv</span><span class="p">(</span><span class="n">i_filename</span><span class="p">,</span> <span class="n">sep</span><span class="o">=</span><span class="s">&quot;</span><span class="se">\t</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">compression</span><span class="o">=</span><span class="s">&quot;bz2&quot;</span><span class="p">)</span>

    <span class="c"># Adding a sample column</span>
    <span class="n">data</span><span class="p">[</span><span class="s">&quot;sample_id&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="p">[</span><span class="s">&quot;sample_{}&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">i</span><span class="o">+</span><span class="mi">1</span><span class="p">)</span> <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="n">data</span><span class="p">))]</span>

    <span class="c"># Saving the phenotypes to file</span>
    <span class="n">pheno_filename</span> <span class="o">=</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">output_dirname</span><span class="p">,</span> <span class="s">&quot;phenotypes.txt&quot;</span><span class="p">)</span>
    <span class="n">data</span><span class="o">.</span><span class="n">to_csv</span><span class="p">(</span><span class="n">pheno_filename</span><span class="p">,</span> <span class="n">sep</span><span class="o">=</span><span class="s">&quot;</span><span class="se">\t</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">index</span><span class="o">=</span><span class="bp">False</span><span class="p">,</span> <span class="n">na_rep</span><span class="o">=</span><span class="s">&quot;999999&quot;</span><span class="p">)</span>

    <span class="c"># Creating the sample file</span>
    <span class="n">sample_filename</span> <span class="o">=</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">output_dirname</span><span class="p">,</span> <span class="s">&quot;samples.txt&quot;</span><span class="p">)</span>
    <span class="k">with</span> <span class="nb">open</span><span class="p">(</span><span class="n">sample_filename</span><span class="p">,</span> <span class="s">&quot;w&quot;</span><span class="p">)</span> <span class="k">as</span> <span class="n">o_file</span><span class="p">:</span>
        <span class="k">print</span><span class="p">(</span><span class="s">&quot;ID_1 ID_2 missing father mother sex plink_pheno&quot;</span><span class="p">,</span> <span class="nb">file</span><span class="o">=</span><span class="n">o_file</span><span class="p">)</span>
        <span class="k">print</span><span class="p">(</span><span class="s">&quot;0 0 0 D D D B&quot;</span><span class="p">,</span> <span class="nb">file</span><span class="o">=</span><span class="n">o_file</span><span class="p">)</span>
        <span class="k">for</span> <span class="n">sample</span><span class="p">,</span> <span class="n">gender</span> <span class="ow">in</span> <span class="n">data</span><span class="p">[[</span><span class="s">&quot;sample_id&quot;</span><span class="p">,</span> <span class="s">&quot;gender&quot;</span><span class="p">]]</span><span class="o">.</span><span class="n">values</span><span class="p">:</span>
            <span class="k">print</span><span class="p">(</span><span class="n">sample</span><span class="p">,</span> <span class="n">sample</span><span class="p">,</span> <span class="s">&quot;0&quot;</span><span class="p">,</span> <span class="s">&quot;0&quot;</span><span class="p">,</span> <span class="s">&quot;0&quot;</span><span class="p">,</span> <span class="n">gender</span><span class="p">,</span> <span class="s">&quot;-9&quot;</span><span class="p">,</span> <span class="nb">file</span><span class="o">=</span><span class="n">o_file</span><span class="p">)</span>

    <span class="c"># Creating the IMPUTE2 file</span>
    <span class="n">impute2_filename</span> <span class="o">=</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">output_dirname</span><span class="p">,</span> <span class="s">&quot;impute2.txt&quot;</span><span class="p">)</span>
    <span class="k">with</span> <span class="nb">open</span><span class="p">(</span><span class="n">impute2_filename</span><span class="p">,</span> <span class="s">&quot;w&quot;</span><span class="p">)</span> <span class="k">as</span> <span class="n">o_file</span><span class="p">:</span>
        <span class="k">print</span><span class="p">(</span><span class="s">&quot;22 marker_1 1 T C&quot;</span><span class="p">,</span> <span class="n">end</span><span class="o">=</span><span class="s">&quot;&quot;</span><span class="p">,</span> <span class="nb">file</span><span class="o">=</span><span class="n">o_file</span><span class="p">)</span>
        <span class="k">for</span> <span class="n">dosage</span> <span class="ow">in</span> <span class="n">data</span><span class="o">.</span><span class="n">snp1</span><span class="o">.</span><span class="n">values</span><span class="p">:</span>
            <span class="n">d1</span><span class="p">,</span> <span class="n">d2</span><span class="p">,</span> <span class="n">d3</span> <span class="o">=</span> <span class="n">reverse_dosage</span><span class="p">(</span><span class="n">dosage</span><span class="p">)</span>
            <span class="k">print</span><span class="p">(</span><span class="s">&quot;&quot;</span><span class="p">,</span> <span class="n">d1</span><span class="p">,</span> <span class="n">d2</span><span class="p">,</span> <span class="n">d3</span><span class="p">,</span> <span class="n">sep</span><span class="o">=</span><span class="s">&quot; &quot;</span><span class="p">,</span> <span class="n">end</span><span class="o">=</span><span class="s">&quot;&quot;</span><span class="p">,</span> <span class="nb">file</span><span class="o">=</span><span class="n">o_file</span><span class="p">)</span>
        <span class="k">print</span><span class="p">(</span><span class="nb">file</span><span class="o">=</span><span class="n">o_file</span><span class="p">)</span>

        <span class="k">print</span><span class="p">(</span><span class="s">&quot;22 marker_2 2 G A&quot;</span><span class="p">,</span> <span class="n">end</span><span class="o">=</span><span class="s">&quot;&quot;</span><span class="p">,</span> <span class="nb">file</span><span class="o">=</span><span class="n">o_file</span><span class="p">)</span>
        <span class="k">for</span> <span class="n">dosage</span> <span class="ow">in</span> <span class="n">data</span><span class="o">.</span><span class="n">snp2</span><span class="o">.</span><span class="n">values</span><span class="p">:</span>
            <span class="n">d1</span><span class="p">,</span> <span class="n">d2</span><span class="p">,</span> <span class="n">d3</span> <span class="o">=</span> <span class="n">reverse_dosage</span><span class="p">(</span><span class="n">dosage</span><span class="p">)</span>
            <span class="k">print</span><span class="p">(</span><span class="s">&quot;&quot;</span><span class="p">,</span> <span class="n">d1</span><span class="p">,</span> <span class="n">d2</span><span class="p">,</span> <span class="n">d3</span><span class="p">,</span> <span class="n">sep</span><span class="o">=</span><span class="s">&quot; &quot;</span><span class="p">,</span> <span class="n">end</span><span class="o">=</span><span class="s">&quot;&quot;</span><span class="p">,</span> <span class="nb">file</span><span class="o">=</span><span class="n">o_file</span><span class="p">)</span>
        <span class="k">print</span><span class="p">(</span><span class="nb">file</span><span class="o">=</span><span class="n">o_file</span><span class="p">)</span>

        <span class="k">print</span><span class="p">(</span><span class="s">&quot;22 marker_3 3 AT A&quot;</span><span class="p">,</span> <span class="n">end</span><span class="o">=</span><span class="s">&quot;&quot;</span><span class="p">,</span> <span class="nb">file</span><span class="o">=</span><span class="n">o_file</span><span class="p">)</span>
        <span class="k">for</span> <span class="n">dosage</span> <span class="ow">in</span> <span class="n">data</span><span class="o">.</span><span class="n">snp3</span><span class="o">.</span><span class="n">values</span><span class="p">:</span>
            <span class="n">d1</span><span class="p">,</span> <span class="n">d2</span><span class="p">,</span> <span class="n">d3</span> <span class="o">=</span> <span class="n">reverse_dosage</span><span class="p">(</span><span class="n">dosage</span><span class="p">)</span>
            <span class="k">print</span><span class="p">(</span><span class="s">&quot;&quot;</span><span class="p">,</span> <span class="n">d1</span><span class="p">,</span> <span class="n">d2</span><span class="p">,</span> <span class="n">d3</span><span class="p">,</span> <span class="n">sep</span><span class="o">=</span><span class="s">&quot; &quot;</span><span class="p">,</span> <span class="n">end</span><span class="o">=</span><span class="s">&quot;&quot;</span><span class="p">,</span> <span class="nb">file</span><span class="o">=</span><span class="n">o_file</span><span class="p">)</span>
        <span class="k">print</span><span class="p">(</span><span class="nb">file</span><span class="o">=</span><span class="n">o_file</span><span class="p">)</span>

    <span class="c"># The prefix of the output files</span>
    <span class="n">o_prefix</span> <span class="o">=</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">output_dirname</span><span class="p">,</span> <span class="s">&quot;test_imputed_stats&quot;</span><span class="p">)</span>

    <span class="c"># The tool&#39;s options</span>
    <span class="n">options</span> <span class="o">=</span> <span class="p">[</span>
        <span class="n">analysis_type</span><span class="p">,</span>
        <span class="s">&quot;--impute2&quot;</span><span class="p">,</span> <span class="n">impute2_filename</span><span class="p">,</span>
        <span class="s">&quot;--sample&quot;</span><span class="p">,</span> <span class="n">sample_filename</span><span class="p">,</span>
        <span class="s">&quot;--pheno&quot;</span><span class="p">,</span> <span class="n">pheno_filename</span><span class="p">,</span>
        <span class="s">&quot;--out&quot;</span><span class="p">,</span> <span class="n">o_prefix</span><span class="p">,</span>
        <span class="s">&quot;--gender-column&quot;</span><span class="p">,</span> <span class="s">&quot;gender&quot;</span><span class="p">,</span>
        <span class="s">&quot;--covar&quot;</span><span class="p">,</span> <span class="s">&quot;C1,C2,C3,age,gender&quot;</span><span class="p">,</span>
        <span class="s">&quot;--missing-value&quot;</span><span class="p">,</span> <span class="s">&quot;999999&quot;</span><span class="p">,</span>
        <span class="s">&quot;--sample-column&quot;</span><span class="p">,</span> <span class="s">&quot;sample_id&quot;</span><span class="p">,</span>
    <span class="p">]</span>

    <span class="c"># Is this Cox or linear?</span>
    <span class="k">if</span> <span class="n">analysis_type</span> <span class="o">==</span> <span class="s">&quot;cox&quot;</span><span class="p">:</span>
        <span class="n">options</span><span class="o">.</span><span class="n">extend</span><span class="p">([</span><span class="s">&quot;--time-to-event&quot;</span><span class="p">,</span> <span class="n">tte</span><span class="p">,</span> <span class="s">&quot;--event&quot;</span><span class="p">,</span> <span class="n">event</span><span class="p">])</span>
    <span class="k">else</span><span class="p">:</span>
        <span class="n">options</span><span class="o">.</span><span class="n">extend</span><span class="p">([</span><span class="s">&quot;--pheno-name&quot;</span><span class="p">,</span> <span class="n">pheno_name</span><span class="p">])</span>

    <span class="c"># Is there interaction?</span>
    <span class="k">if</span> <span class="n">interaction</span> <span class="ow">is</span> <span class="ow">not</span> <span class="bp">None</span><span class="p">:</span>
        <span class="n">options</span><span class="o">.</span><span class="n">extend</span><span class="p">([</span><span class="s">&quot;--interaction&quot;</span><span class="p">,</span> <span class="n">interaction</span><span class="p">])</span>

    <span class="c"># Multi processes are required?</span>
    <span class="k">if</span> <span class="n">nb_process</span> <span class="ow">is</span> <span class="ow">not</span> <span class="bp">None</span><span class="p">:</span>
        <span class="n">options</span><span class="o">.</span><span class="n">extend</span><span class="p">([</span><span class="s">&quot;--nb-process&quot;</span><span class="p">,</span> <span class="nb">str</span><span class="p">(</span><span class="n">nb_process</span><span class="p">)])</span>

    <span class="k">return</span> <span class="n">o_prefix</span><span class="p">,</span> <span class="n">options</span>


<span class="k">class</span> <span class="nc">TestImputedStats</span><span class="p">(</span><span class="n">unittest</span><span class="o">.</span><span class="n">TestCase</span><span class="p">):</span>
<div class="viewcode-block" id="TestImputedStats"><a class="viewcode-back" href="../../../module_content/gwip.tests.html#gwip.tests.test_imputed_stats.TestImputedStats">[docs]</a>
    <span class="k">def</span> <span class="nf">setUp</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
<div class="viewcode-block" id="TestImputedStats.setUp"><a class="viewcode-back" href="../../../module_content/gwip.tests.html#gwip.tests.test_imputed_stats.TestImputedStats.setUp">[docs]</a>        <span class="sd">&quot;&quot;&quot;Setup the tests.&quot;&quot;&quot;</span>
        <span class="c"># Creating the temporary directory</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">output_dir</span> <span class="o">=</span> <span class="n">TemporaryDirectory</span><span class="p">(</span><span class="n">prefix</span><span class="o">=</span><span class="s">&quot;gwip_test_&quot;</span><span class="p">)</span>

    <span class="k">def</span> <span class="nf">tearDown</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span></div>
<div class="viewcode-block" id="TestImputedStats.tearDown"><a class="viewcode-back" href="../../../module_content/gwip.tests.html#gwip.tests.test_imputed_stats.TestImputedStats.tearDown">[docs]</a>        <span class="sd">&quot;&quot;&quot;Finishes the test.&quot;&quot;&quot;</span>
        <span class="c"># Deleting the output directory</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">output_dir</span><span class="o">.</span><span class="n">cleanup</span><span class="p">()</span>

    <span class="k">def</span> <span class="nf">test_read_phenotype</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span></div>
<div class="viewcode-block" id="TestImputedStats.test_read_phenotype"><a class="viewcode-back" href="../../../module_content/gwip.tests.html#gwip.tests.test_imputed_stats.TestImputedStats.test_read_phenotype">[docs]</a>        <span class="sd">&quot;&quot;&quot;Tests the &#39;read_phenotype&#39; function.&quot;&quot;&quot;</span>
        <span class="c"># A dummy object for options</span>
        <span class="k">class</span> <span class="nc">Dummy</span><span class="p">(</span><span class="nb">object</span><span class="p">):</span>
            <span class="k">pass</span>

        <span class="c"># The content of the phenotype file</span>
        <span class="n">phenotype_content</span> <span class="o">=</span> <span class="p">(</span>
            <span class="s">&quot;sample_id</span><span class="se">\t</span><span class="s">Time_To_Event</span><span class="se">\t</span><span class="s">Event</span><span class="se">\t</span><span class="s">C1</span><span class="se">\t</span><span class="s">C2</span><span class="se">\t</span><span class="s">C3</span><span class="se">\t</span><span class="s">C4</span><span class="se">\t</span><span class="s">Gender</span><span class="se">\t</span><span class="s">&quot;</span>
            <span class="s">&quot;Pheno_Lin</span><span class="se">\t</span><span class="s">Pheno_Logit</span><span class="se">\t</span><span class="s">Inter</span><span class="se">\n</span><span class="s">&quot;</span>
            <span class="s">&quot;sample_1</span><span class="se">\t</span><span class="s">10</span><span class="se">\t</span><span class="s">0</span><span class="se">\t</span><span class="s">0.3</span><span class="se">\t</span><span class="s">0.2</span><span class="se">\t</span><span class="s">0.45</span><span class="se">\t</span><span class="s">0.01</span><span class="se">\t</span><span class="s">1</span><span class="se">\t</span><span class="s">0.01</span><span class="se">\t</span><span class="s">0</span><span class="se">\t</span><span class="s">0.00001</span><span class="se">\n</span><span class="s">&quot;</span>
            <span class="s">&quot;sample_2</span><span class="se">\t</span><span class="s">2</span><span class="se">\t</span><span class="s">1</span><span class="se">\t</span><span class="s">0.9</span><span class="se">\t</span><span class="s">0.1</span><span class="se">\t</span><span class="s">0.42</span><span class="se">\t</span><span class="s">0.012</span><span class="se">\t</span><span class="s">2</span><span class="se">\t</span><span class="s">0.15</span><span class="se">\t</span><span class="s">1</span><span class="se">\t</span><span class="s">0.00332</span><span class="se">\n</span><span class="s">&quot;</span>
            <span class="s">&quot;sample_3</span><span class="se">\t</span><span class="s">8</span><span class="se">\t</span><span class="s">1</span><span class="se">\t</span><span class="s">0.4</span><span class="se">\t</span><span class="s">0.67</span><span class="se">\t</span><span class="s">999</span><span class="se">\t</span><span class="s">0.001</span><span class="se">\t</span><span class="s">1</span><span class="se">\t</span><span class="s">0.0</span><span class="se">\t</span><span class="s">0</span><span class="se">\t</span><span class="s">0.000001</span><span class="se">\n</span><span class="s">&quot;</span>
        <span class="p">)</span>
        <span class="n">filename</span> <span class="o">=</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">output_dir</span><span class="o">.</span><span class="n">name</span><span class="p">,</span> <span class="s">&quot;phenotypes.txt&quot;</span><span class="p">)</span>
        <span class="k">with</span> <span class="nb">open</span><span class="p">(</span><span class="n">filename</span><span class="p">,</span> <span class="s">&quot;w&quot;</span><span class="p">)</span> <span class="k">as</span> <span class="n">o_file</span><span class="p">:</span>
            <span class="n">o_file</span><span class="o">.</span><span class="n">write</span><span class="p">(</span><span class="n">phenotype_content</span><span class="p">)</span>

        <span class="c"># Need an object for the function&#39;s option</span>
        <span class="n">args</span> <span class="o">=</span> <span class="n">Dummy</span><span class="p">()</span>
        <span class="n">args</span><span class="o">.</span><span class="n">missing_value</span> <span class="o">=</span> <span class="bp">None</span>
        <span class="n">args</span><span class="o">.</span><span class="n">sample_column</span> <span class="o">=</span> <span class="s">&quot;sample_id&quot;</span>
        <span class="n">args</span><span class="o">.</span><span class="n">covar</span> <span class="o">=</span> <span class="p">[</span><span class="s">&quot;C1&quot;</span><span class="p">,</span> <span class="s">&quot;C2&quot;</span><span class="p">,</span> <span class="s">&quot;C3&quot;</span><span class="p">,</span> <span class="s">&quot;Gender&quot;</span><span class="p">]</span>
        <span class="n">args</span><span class="o">.</span><span class="n">analysis_type</span> <span class="o">=</span> <span class="s">&quot;cox&quot;</span>
        <span class="n">args</span><span class="o">.</span><span class="n">tte</span> <span class="o">=</span> <span class="s">&quot;Time_To_Event&quot;</span>
        <span class="n">args</span><span class="o">.</span><span class="n">event</span> <span class="o">=</span> <span class="s">&quot;Event&quot;</span>
        <span class="n">args</span><span class="o">.</span><span class="n">interaction</span> <span class="o">=</span> <span class="bp">None</span>
        <span class="n">args</span><span class="o">.</span><span class="n">chrx</span> <span class="o">=</span> <span class="bp">False</span>
        <span class="n">args</span><span class="o">.</span><span class="n">gender_column</span> <span class="o">=</span> <span class="s">&quot;Gender&quot;</span>

        <span class="c"># The expected value</span>
        <span class="n">expected_shape</span> <span class="o">=</span> <span class="p">(</span><span class="mi">3</span><span class="p">,</span> <span class="mi">6</span><span class="p">)</span>
        <span class="n">expected_columns</span> <span class="o">=</span> <span class="p">{</span><span class="s">&quot;C1&quot;</span><span class="p">,</span> <span class="s">&quot;C2&quot;</span><span class="p">,</span> <span class="s">&quot;C3&quot;</span><span class="p">,</span> <span class="s">&quot;Gender&quot;</span><span class="p">,</span> <span class="s">&quot;Time_To_Event&quot;</span><span class="p">,</span>
                            <span class="s">&quot;Event&quot;</span><span class="p">}</span>
        <span class="n">expected_index</span> <span class="o">=</span> <span class="p">[</span><span class="s">&quot;sample_1&quot;</span><span class="p">,</span> <span class="s">&quot;sample_2&quot;</span><span class="p">,</span> <span class="s">&quot;sample_3&quot;</span><span class="p">]</span>
        <span class="n">expected_c1</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">([</span><span class="mf">0.3</span><span class="p">,</span> <span class="mf">0.9</span><span class="p">,</span> <span class="mf">0.4</span><span class="p">],</span> <span class="n">dtype</span><span class="o">=</span><span class="nb">float</span><span class="p">)</span>
        <span class="n">expected_c2</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">([</span><span class="mf">0.2</span><span class="p">,</span> <span class="mf">0.1</span><span class="p">,</span> <span class="mf">0.67</span><span class="p">],</span> <span class="n">dtype</span><span class="o">=</span><span class="nb">float</span><span class="p">)</span>
        <span class="n">expected_c3</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">([</span><span class="mf">0.45</span><span class="p">,</span> <span class="mf">0.42</span><span class="p">,</span> <span class="mi">999</span><span class="p">],</span> <span class="n">dtype</span><span class="o">=</span><span class="nb">float</span><span class="p">)</span>
        <span class="n">expected_gender</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">([</span><span class="mi">1</span><span class="p">,</span> <span class="mi">2</span><span class="p">,</span> <span class="mi">1</span><span class="p">],</span> <span class="n">dtype</span><span class="o">=</span><span class="nb">int</span><span class="p">)</span>
        <span class="n">expected_tte</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">([</span><span class="mi">10</span><span class="p">,</span> <span class="mi">2</span><span class="p">,</span> <span class="mi">8</span><span class="p">],</span> <span class="n">dtype</span><span class="o">=</span><span class="nb">int</span><span class="p">)</span>
        <span class="n">expected_event</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">([</span><span class="mi">0</span><span class="p">,</span> <span class="mi">1</span><span class="p">,</span> <span class="mi">1</span><span class="p">],</span> <span class="n">dtype</span><span class="o">=</span><span class="nb">int</span><span class="p">)</span>
        <span class="n">expected_remove_g</span> <span class="o">=</span> <span class="bp">False</span>

        <span class="c"># The observed values</span>
        <span class="n">observed_p</span><span class="p">,</span> <span class="n">observed_remove_g</span> <span class="o">=</span> <span class="n">read_phenotype</span><span class="p">(</span><span class="n">filename</span><span class="p">,</span> <span class="n">args</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">assertTrue</span><span class="p">(</span><span class="nb">isinstance</span><span class="p">(</span><span class="n">observed_p</span><span class="p">,</span> <span class="n">pd</span><span class="o">.</span><span class="n">DataFrame</span><span class="p">))</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">assertEqual</span><span class="p">(</span><span class="n">expected_shape</span><span class="p">,</span> <span class="n">observed_p</span><span class="o">.</span><span class="n">shape</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">assertEqual</span><span class="p">(</span><span class="n">expected_columns</span><span class="p">,</span> <span class="nb">set</span><span class="p">(</span><span class="n">observed_p</span><span class="o">.</span><span class="n">columns</span><span class="p">))</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">assertEqual</span><span class="p">(</span><span class="n">expected_index</span><span class="p">,</span> <span class="nb">list</span><span class="p">(</span><span class="n">observed_p</span><span class="o">.</span><span class="n">index</span><span class="p">))</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">assertTrue</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">allclose</span><span class="p">(</span><span class="n">expected_c1</span><span class="p">,</span> <span class="n">observed_p</span><span class="o">.</span><span class="n">C1</span><span class="o">.</span><span class="n">values</span><span class="p">))</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">assertTrue</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">allclose</span><span class="p">(</span><span class="n">expected_c2</span><span class="p">,</span> <span class="n">observed_p</span><span class="o">.</span><span class="n">C2</span><span class="o">.</span><span class="n">values</span><span class="p">))</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">assertTrue</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">allclose</span><span class="p">(</span><span class="n">expected_c3</span><span class="p">,</span> <span class="n">observed_p</span><span class="o">.</span><span class="n">C3</span><span class="o">.</span><span class="n">values</span><span class="p">))</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">assertTrue</span><span class="p">((</span><span class="n">expected_gender</span> <span class="o">==</span> <span class="n">observed_p</span><span class="o">.</span><span class="n">Gender</span><span class="o">.</span><span class="n">values</span><span class="p">)</span><span class="o">.</span><span class="n">all</span><span class="p">())</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">assertTrue</span><span class="p">(</span>
            <span class="p">(</span><span class="n">expected_tte</span> <span class="o">==</span> <span class="n">observed_p</span><span class="o">.</span><span class="n">Time_To_Event</span><span class="o">.</span><span class="n">values</span><span class="p">)</span><span class="o">.</span><span class="n">all</span><span class="p">()</span>
        <span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">assertTrue</span><span class="p">((</span><span class="n">expected_event</span> <span class="o">==</span> <span class="n">observed_p</span><span class="o">.</span><span class="n">Event</span><span class="o">.</span><span class="n">values</span><span class="p">)</span><span class="o">.</span><span class="n">all</span><span class="p">())</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">assertEqual</span><span class="p">(</span><span class="n">expected_remove_g</span><span class="p">,</span> <span class="n">observed_remove_g</span><span class="p">)</span>

        <span class="c"># Modifying the missing value to 999</span>
        <span class="n">args</span><span class="o">.</span><span class="n">missing_value</span> <span class="o">=</span> <span class="s">&quot;999&quot;</span>

        <span class="c"># The expected results</span>
        <span class="n">expected_shape</span> <span class="o">=</span> <span class="p">(</span><span class="mi">2</span><span class="p">,</span> <span class="mi">6</span><span class="p">)</span>

        <span class="c"># The observed values</span>
        <span class="n">observed_p</span><span class="p">,</span> <span class="n">observed_remove_g</span> <span class="o">=</span> <span class="n">read_phenotype</span><span class="p">(</span><span class="n">filename</span><span class="p">,</span> <span class="n">args</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">assertTrue</span><span class="p">(</span><span class="nb">isinstance</span><span class="p">(</span><span class="n">observed_p</span><span class="p">,</span> <span class="n">pd</span><span class="o">.</span><span class="n">DataFrame</span><span class="p">))</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">assertEqual</span><span class="p">(</span><span class="n">expected_shape</span><span class="p">,</span> <span class="n">observed_p</span><span class="o">.</span><span class="n">shape</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">assertEqual</span><span class="p">(</span><span class="n">expected_columns</span><span class="p">,</span> <span class="nb">set</span><span class="p">(</span><span class="n">observed_p</span><span class="o">.</span><span class="n">columns</span><span class="p">))</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">assertEqual</span><span class="p">(</span><span class="n">expected_index</span><span class="p">[:</span><span class="o">-</span><span class="mi">1</span><span class="p">],</span> <span class="nb">list</span><span class="p">(</span><span class="n">observed_p</span><span class="o">.</span><span class="n">index</span><span class="p">))</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">assertTrue</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">allclose</span><span class="p">(</span><span class="n">expected_c1</span><span class="p">[:</span><span class="o">-</span><span class="mi">1</span><span class="p">],</span> <span class="n">observed_p</span><span class="o">.</span><span class="n">C1</span><span class="o">.</span><span class="n">values</span><span class="p">))</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">assertTrue</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">allclose</span><span class="p">(</span><span class="n">expected_c2</span><span class="p">[:</span><span class="o">-</span><span class="mi">1</span><span class="p">],</span> <span class="n">observed_p</span><span class="o">.</span><span class="n">C2</span><span class="o">.</span><span class="n">values</span><span class="p">))</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">assertTrue</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">allclose</span><span class="p">(</span><span class="n">expected_c3</span><span class="p">[:</span><span class="o">-</span><span class="mi">1</span><span class="p">],</span> <span class="n">observed_p</span><span class="o">.</span><span class="n">C3</span><span class="o">.</span><span class="n">values</span><span class="p">))</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">assertTrue</span><span class="p">(</span>
            <span class="p">(</span><span class="n">expected_gender</span><span class="p">[:</span><span class="o">-</span><span class="mi">1</span><span class="p">]</span> <span class="o">==</span> <span class="n">observed_p</span><span class="o">.</span><span class="n">Gender</span><span class="o">.</span><span class="n">values</span><span class="p">)</span><span class="o">.</span><span class="n">all</span><span class="p">()</span>
        <span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">assertTrue</span><span class="p">(</span>
            <span class="p">(</span><span class="n">expected_tte</span><span class="p">[:</span><span class="o">-</span><span class="mi">1</span><span class="p">]</span> <span class="o">==</span> <span class="n">observed_p</span><span class="o">.</span><span class="n">Time_To_Event</span><span class="o">.</span><span class="n">values</span><span class="p">)</span><span class="o">.</span><span class="n">all</span><span class="p">()</span>
        <span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">assertTrue</span><span class="p">(</span>
            <span class="p">(</span><span class="n">expected_event</span><span class="p">[:</span><span class="o">-</span><span class="mi">1</span><span class="p">]</span> <span class="o">==</span> <span class="n">observed_p</span><span class="o">.</span><span class="n">Event</span><span class="o">.</span><span class="n">values</span><span class="p">)</span><span class="o">.</span><span class="n">all</span><span class="p">()</span>
        <span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">assertEqual</span><span class="p">(</span><span class="n">expected_remove_g</span><span class="p">,</span> <span class="n">observed_remove_g</span><span class="p">)</span>

        <span class="c"># Changing from Cox to linear should remove a column</span>
        <span class="n">args</span><span class="o">.</span><span class="n">missing_value</span> <span class="o">=</span> <span class="bp">None</span>
        <span class="n">args</span><span class="o">.</span><span class="n">analysis_type</span> <span class="o">=</span> <span class="s">&quot;linear&quot;</span>
        <span class="k">del</span> <span class="n">args</span><span class="o">.</span><span class="n">tte</span>
        <span class="k">del</span> <span class="n">args</span><span class="o">.</span><span class="n">event</span>
        <span class="n">args</span><span class="o">.</span><span class="n">pheno_name</span> <span class="o">=</span> <span class="s">&quot;Pheno_Lin&quot;</span>

        <span class="c"># The expected results</span>
        <span class="n">expected_shape</span> <span class="o">=</span> <span class="p">(</span><span class="mi">3</span><span class="p">,</span> <span class="mi">5</span><span class="p">)</span>
        <span class="n">expected_columns</span> <span class="o">=</span> <span class="p">{</span><span class="s">&quot;C1&quot;</span><span class="p">,</span> <span class="s">&quot;C2&quot;</span><span class="p">,</span> <span class="s">&quot;C3&quot;</span><span class="p">,</span> <span class="s">&quot;Gender&quot;</span><span class="p">,</span> <span class="s">&quot;Pheno_Lin&quot;</span><span class="p">}</span>
        <span class="n">expected_pheno</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">([</span><span class="mf">0.01</span><span class="p">,</span> <span class="mf">0.15</span><span class="p">,</span> <span class="mi">0</span><span class="p">],</span> <span class="n">dtype</span><span class="o">=</span><span class="nb">float</span><span class="p">)</span>

        <span class="c"># The observed values</span>
        <span class="n">observed_p</span><span class="p">,</span> <span class="n">observed_remove_g</span> <span class="o">=</span> <span class="n">read_phenotype</span><span class="p">(</span><span class="n">filename</span><span class="p">,</span> <span class="n">args</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">assertTrue</span><span class="p">(</span><span class="nb">isinstance</span><span class="p">(</span><span class="n">observed_p</span><span class="p">,</span> <span class="n">pd</span><span class="o">.</span><span class="n">DataFrame</span><span class="p">))</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">assertEqual</span><span class="p">(</span><span class="n">expected_shape</span><span class="p">,</span> <span class="n">observed_p</span><span class="o">.</span><span class="n">shape</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">assertEqual</span><span class="p">(</span><span class="n">expected_columns</span><span class="p">,</span> <span class="nb">set</span><span class="p">(</span><span class="n">observed_p</span><span class="o">.</span><span class="n">columns</span><span class="p">))</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">assertEqual</span><span class="p">(</span><span class="n">expected_index</span><span class="p">,</span> <span class="nb">list</span><span class="p">(</span><span class="n">observed_p</span><span class="o">.</span><span class="n">index</span><span class="p">))</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">assertTrue</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">allclose</span><span class="p">(</span><span class="n">expected_c1</span><span class="p">,</span> <span class="n">observed_p</span><span class="o">.</span><span class="n">C1</span><span class="o">.</span><span class="n">values</span><span class="p">))</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">assertTrue</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">allclose</span><span class="p">(</span><span class="n">expected_c2</span><span class="p">,</span> <span class="n">observed_p</span><span class="o">.</span><span class="n">C2</span><span class="o">.</span><span class="n">values</span><span class="p">))</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">assertTrue</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">allclose</span><span class="p">(</span><span class="n">expected_c3</span><span class="p">,</span> <span class="n">observed_p</span><span class="o">.</span><span class="n">C3</span><span class="o">.</span><span class="n">values</span><span class="p">))</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">assertTrue</span><span class="p">((</span><span class="n">expected_gender</span> <span class="o">==</span> <span class="n">observed_p</span><span class="o">.</span><span class="n">Gender</span><span class="o">.</span><span class="n">values</span><span class="p">)</span><span class="o">.</span><span class="n">all</span><span class="p">())</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">assertTrue</span><span class="p">((</span><span class="n">expected_pheno</span> <span class="o">==</span> <span class="n">observed_p</span><span class="o">.</span><span class="n">Pheno_Lin</span><span class="o">.</span><span class="n">values</span><span class="p">)</span><span class="o">.</span><span class="n">all</span><span class="p">())</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">assertEqual</span><span class="p">(</span><span class="n">expected_remove_g</span><span class="p">,</span> <span class="n">observed_remove_g</span><span class="p">)</span>

        <span class="c"># Changing from linear to logistic shouldn&#39;t change a thing</span>
        <span class="n">args</span><span class="o">.</span><span class="n">analysis_type</span> <span class="o">=</span> <span class="s">&quot;logistic&quot;</span>
        <span class="n">args</span><span class="o">.</span><span class="n">pheno_name</span> <span class="o">=</span> <span class="s">&quot;Pheno_Logit&quot;</span>

        <span class="c"># The expected results</span>
        <span class="n">expected_columns</span> <span class="o">=</span> <span class="p">{</span><span class="s">&quot;C1&quot;</span><span class="p">,</span> <span class="s">&quot;C2&quot;</span><span class="p">,</span> <span class="s">&quot;C3&quot;</span><span class="p">,</span> <span class="s">&quot;Gender&quot;</span><span class="p">,</span> <span class="s">&quot;Pheno_Logit&quot;</span><span class="p">}</span>
        <span class="n">expected_pheno</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">([</span><span class="mi">0</span><span class="p">,</span> <span class="mi">1</span><span class="p">,</span> <span class="mi">0</span><span class="p">],</span> <span class="n">dtype</span><span class="o">=</span><span class="nb">int</span><span class="p">)</span>

        <span class="c"># The observed values</span>
        <span class="n">observed_p</span><span class="p">,</span> <span class="n">observed_remove_g</span> <span class="o">=</span> <span class="n">read_phenotype</span><span class="p">(</span><span class="n">filename</span><span class="p">,</span> <span class="n">args</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">assertTrue</span><span class="p">(</span><span class="nb">isinstance</span><span class="p">(</span><span class="n">observed_p</span><span class="p">,</span> <span class="n">pd</span><span class="o">.</span><span class="n">DataFrame</span><span class="p">))</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">assertEqual</span><span class="p">(</span><span class="n">expected_shape</span><span class="p">,</span> <span class="n">observed_p</span><span class="o">.</span><span class="n">shape</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">assertEqual</span><span class="p">(</span><span class="n">expected_columns</span><span class="p">,</span> <span class="nb">set</span><span class="p">(</span><span class="n">observed_p</span><span class="o">.</span><span class="n">columns</span><span class="p">))</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">assertEqual</span><span class="p">(</span><span class="n">expected_index</span><span class="p">,</span> <span class="nb">list</span><span class="p">(</span><span class="n">observed_p</span><span class="o">.</span><span class="n">index</span><span class="p">))</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">assertTrue</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">allclose</span><span class="p">(</span><span class="n">expected_c1</span><span class="p">,</span> <span class="n">observed_p</span><span class="o">.</span><span class="n">C1</span><span class="o">.</span><span class="n">values</span><span class="p">))</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">assertTrue</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">allclose</span><span class="p">(</span><span class="n">expected_c2</span><span class="p">,</span> <span class="n">observed_p</span><span class="o">.</span><span class="n">C2</span><span class="o">.</span><span class="n">values</span><span class="p">))</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">assertTrue</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">allclose</span><span class="p">(</span><span class="n">expected_c3</span><span class="p">,</span> <span class="n">observed_p</span><span class="o">.</span><span class="n">C3</span><span class="o">.</span><span class="n">values</span><span class="p">))</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">assertTrue</span><span class="p">((</span><span class="n">expected_gender</span> <span class="o">==</span> <span class="n">observed_p</span><span class="o">.</span><span class="n">Gender</span><span class="o">.</span><span class="n">values</span><span class="p">)</span><span class="o">.</span><span class="n">all</span><span class="p">())</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">assertTrue</span><span class="p">(</span>
            <span class="p">(</span><span class="n">expected_pheno</span> <span class="o">==</span> <span class="n">observed_p</span><span class="o">.</span><span class="n">Pheno_Logit</span><span class="o">.</span><span class="n">values</span><span class="p">)</span><span class="o">.</span><span class="n">all</span><span class="p">()</span>
        <span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">assertEqual</span><span class="p">(</span><span class="n">expected_remove_g</span><span class="p">,</span> <span class="n">observed_remove_g</span><span class="p">)</span>

        <span class="c"># Adding an interaction</span>
        <span class="n">args</span><span class="o">.</span><span class="n">interaction</span> <span class="o">=</span> <span class="s">&quot;Inter&quot;</span>

        <span class="c"># The expected results</span>
        <span class="n">expected_shape</span> <span class="o">=</span> <span class="p">(</span><span class="mi">3</span><span class="p">,</span> <span class="mi">6</span><span class="p">)</span>
        <span class="n">expected_columns</span> <span class="o">=</span> <span class="p">{</span><span class="s">&quot;C1&quot;</span><span class="p">,</span> <span class="s">&quot;C2&quot;</span><span class="p">,</span> <span class="s">&quot;C3&quot;</span><span class="p">,</span> <span class="s">&quot;Gender&quot;</span><span class="p">,</span> <span class="s">&quot;Pheno_Logit&quot;</span><span class="p">,</span> <span class="s">&quot;Inter&quot;</span><span class="p">}</span>
        <span class="n">expected_inter</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">([</span><span class="mf">0.00001</span><span class="p">,</span> <span class="mf">0.00332</span><span class="p">,</span> <span class="mf">0.000001</span><span class="p">],</span> <span class="n">dtype</span><span class="o">=</span><span class="nb">float</span><span class="p">)</span>

        <span class="c"># The observed values</span>
        <span class="n">observed_p</span><span class="p">,</span> <span class="n">observed_remove_g</span> <span class="o">=</span> <span class="n">read_phenotype</span><span class="p">(</span><span class="n">filename</span><span class="p">,</span> <span class="n">args</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">assertTrue</span><span class="p">(</span><span class="nb">isinstance</span><span class="p">(</span><span class="n">observed_p</span><span class="p">,</span> <span class="n">pd</span><span class="o">.</span><span class="n">DataFrame</span><span class="p">))</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">assertEqual</span><span class="p">(</span><span class="n">expected_shape</span><span class="p">,</span> <span class="n">observed_p</span><span class="o">.</span><span class="n">shape</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">assertEqual</span><span class="p">(</span><span class="n">expected_columns</span><span class="p">,</span> <span class="nb">set</span><span class="p">(</span><span class="n">observed_p</span><span class="o">.</span><span class="n">columns</span><span class="p">))</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">assertEqual</span><span class="p">(</span><span class="n">expected_index</span><span class="p">,</span> <span class="nb">list</span><span class="p">(</span><span class="n">observed_p</span><span class="o">.</span><span class="n">index</span><span class="p">))</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">assertTrue</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">allclose</span><span class="p">(</span><span class="n">expected_c1</span><span class="p">,</span> <span class="n">observed_p</span><span class="o">.</span><span class="n">C1</span><span class="o">.</span><span class="n">values</span><span class="p">))</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">assertTrue</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">allclose</span><span class="p">(</span><span class="n">expected_c2</span><span class="p">,</span> <span class="n">observed_p</span><span class="o">.</span><span class="n">C2</span><span class="o">.</span><span class="n">values</span><span class="p">))</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">assertTrue</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">allclose</span><span class="p">(</span><span class="n">expected_c3</span><span class="p">,</span> <span class="n">observed_p</span><span class="o">.</span><span class="n">C3</span><span class="o">.</span><span class="n">values</span><span class="p">))</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">assertTrue</span><span class="p">((</span><span class="n">expected_gender</span> <span class="o">==</span> <span class="n">observed_p</span><span class="o">.</span><span class="n">Gender</span><span class="o">.</span><span class="n">values</span><span class="p">)</span><span class="o">.</span><span class="n">all</span><span class="p">())</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">assertTrue</span><span class="p">(</span>
            <span class="p">(</span><span class="n">expected_pheno</span> <span class="o">==</span> <span class="n">observed_p</span><span class="o">.</span><span class="n">Pheno_Logit</span><span class="o">.</span><span class="n">values</span><span class="p">)</span><span class="o">.</span><span class="n">all</span><span class="p">()</span>
        <span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">assertTrue</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">allclose</span><span class="p">(</span><span class="n">expected_inter</span><span class="p">,</span> <span class="n">observed_p</span><span class="o">.</span><span class="n">Inter</span><span class="o">.</span><span class="n">values</span><span class="p">))</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">assertEqual</span><span class="p">(</span><span class="n">expected_remove_g</span><span class="p">,</span> <span class="n">observed_remove_g</span><span class="p">)</span>

        <span class="c"># Removing the gender in the covars, but setting chrx to true</span>
        <span class="n">args</span><span class="o">.</span><span class="n">covar</span> <span class="o">=</span> <span class="p">[</span><span class="s">&quot;C1&quot;</span><span class="p">,</span> <span class="s">&quot;C2&quot;</span><span class="p">,</span> <span class="s">&quot;C3&quot;</span><span class="p">]</span>
        <span class="n">args</span><span class="o">.</span><span class="n">chrx</span> <span class="o">=</span> <span class="bp">True</span>

        <span class="c"># The expected results</span>
        <span class="n">expected_remove_g</span> <span class="o">=</span> <span class="bp">True</span>

        <span class="c"># The observed values</span>
        <span class="n">observed_p</span><span class="p">,</span> <span class="n">observed_remove_g</span> <span class="o">=</span> <span class="n">read_phenotype</span><span class="p">(</span><span class="n">filename</span><span class="p">,</span> <span class="n">args</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">assertTrue</span><span class="p">(</span><span class="nb">isinstance</span><span class="p">(</span><span class="n">observed_p</span><span class="p">,</span> <span class="n">pd</span><span class="o">.</span><span class="n">DataFrame</span><span class="p">))</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">assertEqual</span><span class="p">(</span><span class="n">expected_shape</span><span class="p">,</span> <span class="n">observed_p</span><span class="o">.</span><span class="n">shape</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">assertEqual</span><span class="p">(</span><span class="n">expected_columns</span><span class="p">,</span> <span class="nb">set</span><span class="p">(</span><span class="n">observed_p</span><span class="o">.</span><span class="n">columns</span><span class="p">))</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">assertEqual</span><span class="p">(</span><span class="n">expected_index</span><span class="p">,</span> <span class="nb">list</span><span class="p">(</span><span class="n">observed_p</span><span class="o">.</span><span class="n">index</span><span class="p">))</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">assertTrue</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">allclose</span><span class="p">(</span><span class="n">expected_c1</span><span class="p">,</span> <span class="n">observed_p</span><span class="o">.</span><span class="n">C1</span><span class="o">.</span><span class="n">values</span><span class="p">))</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">assertTrue</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">allclose</span><span class="p">(</span><span class="n">expected_c2</span><span class="p">,</span> <span class="n">observed_p</span><span class="o">.</span><span class="n">C2</span><span class="o">.</span><span class="n">values</span><span class="p">))</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">assertTrue</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">allclose</span><span class="p">(</span><span class="n">expected_c3</span><span class="p">,</span> <span class="n">observed_p</span><span class="o">.</span><span class="n">C3</span><span class="o">.</span><span class="n">values</span><span class="p">))</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">assertTrue</span><span class="p">((</span><span class="n">expected_gender</span> <span class="o">==</span> <span class="n">observed_p</span><span class="o">.</span><span class="n">Gender</span><span class="o">.</span><span class="n">values</span><span class="p">)</span><span class="o">.</span><span class="n">all</span><span class="p">())</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">assertTrue</span><span class="p">(</span>
            <span class="p">(</span><span class="n">expected_pheno</span> <span class="o">==</span> <span class="n">observed_p</span><span class="o">.</span><span class="n">Pheno_Logit</span><span class="o">.</span><span class="n">values</span><span class="p">)</span><span class="o">.</span><span class="n">all</span><span class="p">()</span>
        <span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">assertTrue</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">allclose</span><span class="p">(</span><span class="n">expected_inter</span><span class="p">,</span> <span class="n">observed_p</span><span class="o">.</span><span class="n">Inter</span><span class="o">.</span><span class="n">values</span><span class="p">))</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">assertEqual</span><span class="p">(</span><span class="n">expected_remove_g</span><span class="p">,</span> <span class="n">observed_remove_g</span><span class="p">)</span>

        <span class="c"># Adding a sample (with unknown gender) (should be included since not</span>
        <span class="c"># in covar, even though we ask for chrX)</span>
        <span class="k">with</span> <span class="nb">open</span><span class="p">(</span><span class="n">filename</span><span class="p">,</span> <span class="s">&quot;a&quot;</span><span class="p">)</span> <span class="k">as</span> <span class="n">o_file</span><span class="p">:</span>
            <span class="n">o_file</span><span class="o">.</span><span class="n">write</span><span class="p">(</span>
                <span class="s">&quot;sample_4</span><span class="se">\t</span><span class="s">8</span><span class="se">\t</span><span class="s">1</span><span class="se">\t</span><span class="s">0.4</span><span class="se">\t</span><span class="s">0.67</span><span class="se">\t</span><span class="s">999</span><span class="se">\t</span><span class="s">0.001</span><span class="se">\t</span><span class="s">0</span><span class="se">\t</span><span class="s">0.0</span><span class="se">\t</span><span class="s">0</span><span class="se">\t</span><span class="s">0.000001</span><span class="se">\n</span><span class="s">&quot;</span>
            <span class="p">)</span>

        <span class="c"># The expected values</span>
        <span class="n">expected_shape</span> <span class="o">=</span> <span class="p">(</span><span class="mi">4</span><span class="p">,</span> <span class="mi">6</span><span class="p">)</span>
        <span class="n">expected_index</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="s">&quot;sample_4&quot;</span><span class="p">)</span>
        <span class="n">expected_c1</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">([</span><span class="mf">0.3</span><span class="p">,</span> <span class="mf">0.9</span><span class="p">,</span> <span class="mf">0.4</span><span class="p">,</span> <span class="mf">0.4</span><span class="p">],</span> <span class="n">dtype</span><span class="o">=</span><span class="nb">float</span><span class="p">)</span>
        <span class="n">expected_c2</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">([</span><span class="mf">0.2</span><span class="p">,</span> <span class="mf">0.1</span><span class="p">,</span> <span class="mf">0.67</span><span class="p">,</span> <span class="mf">0.67</span><span class="p">],</span> <span class="n">dtype</span><span class="o">=</span><span class="nb">float</span><span class="p">)</span>
        <span class="n">expected_c3</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">([</span><span class="mf">0.45</span><span class="p">,</span> <span class="mf">0.42</span><span class="p">,</span> <span class="mi">999</span><span class="p">,</span> <span class="mi">999</span><span class="p">],</span> <span class="n">dtype</span><span class="o">=</span><span class="nb">float</span><span class="p">)</span>
        <span class="n">expected_gender</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">([</span><span class="mi">1</span><span class="p">,</span> <span class="mi">2</span><span class="p">,</span> <span class="mi">1</span><span class="p">,</span> <span class="mi">0</span><span class="p">],</span> <span class="n">dtype</span><span class="o">=</span><span class="nb">int</span><span class="p">)</span>
        <span class="n">expected_pheno</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">([</span><span class="mi">0</span><span class="p">,</span> <span class="mi">1</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">],</span> <span class="n">dtype</span><span class="o">=</span><span class="nb">int</span><span class="p">)</span>
        <span class="n">expected_inter</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">([</span><span class="mf">0.00001</span><span class="p">,</span> <span class="mf">0.00332</span><span class="p">,</span> <span class="mf">0.000001</span><span class="p">,</span> <span class="mf">0.000001</span><span class="p">],</span>
                                  <span class="n">dtype</span><span class="o">=</span><span class="nb">float</span><span class="p">)</span>

        <span class="c"># The observed values</span>
        <span class="n">observed_p</span><span class="p">,</span> <span class="n">observed_remove_g</span> <span class="o">=</span> <span class="n">read_phenotype</span><span class="p">(</span><span class="n">filename</span><span class="p">,</span> <span class="n">args</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">assertTrue</span><span class="p">(</span><span class="nb">isinstance</span><span class="p">(</span><span class="n">observed_p</span><span class="p">,</span> <span class="n">pd</span><span class="o">.</span><span class="n">DataFrame</span><span class="p">))</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">assertEqual</span><span class="p">(</span><span class="n">expected_shape</span><span class="p">,</span> <span class="n">observed_p</span><span class="o">.</span><span class="n">shape</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">assertEqual</span><span class="p">(</span><span class="n">expected_columns</span><span class="p">,</span> <span class="nb">set</span><span class="p">(</span><span class="n">observed_p</span><span class="o">.</span><span class="n">columns</span><span class="p">))</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">assertEqual</span><span class="p">(</span><span class="n">expected_index</span><span class="p">,</span> <span class="nb">list</span><span class="p">(</span><span class="n">observed_p</span><span class="o">.</span><span class="n">index</span><span class="p">))</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">assertTrue</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">allclose</span><span class="p">(</span><span class="n">expected_c1</span><span class="p">,</span> <span class="n">observed_p</span><span class="o">.</span><span class="n">C1</span><span class="o">.</span><span class="n">values</span><span class="p">))</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">assertTrue</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">allclose</span><span class="p">(</span><span class="n">expected_c2</span><span class="p">,</span> <span class="n">observed_p</span><span class="o">.</span><span class="n">C2</span><span class="o">.</span><span class="n">values</span><span class="p">))</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">assertTrue</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">allclose</span><span class="p">(</span><span class="n">expected_c3</span><span class="p">,</span> <span class="n">observed_p</span><span class="o">.</span><span class="n">C3</span><span class="o">.</span><span class="n">values</span><span class="p">))</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">assertTrue</span><span class="p">((</span><span class="n">expected_gender</span> <span class="o">==</span> <span class="n">observed_p</span><span class="o">.</span><span class="n">Gender</span><span class="o">.</span><span class="n">values</span><span class="p">)</span><span class="o">.</span><span class="n">all</span><span class="p">())</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">assertTrue</span><span class="p">(</span>
            <span class="p">(</span><span class="n">expected_pheno</span> <span class="o">==</span> <span class="n">observed_p</span><span class="o">.</span><span class="n">Pheno_Logit</span><span class="o">.</span><span class="n">values</span><span class="p">)</span><span class="o">.</span><span class="n">all</span><span class="p">()</span>
        <span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">assertTrue</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">allclose</span><span class="p">(</span><span class="n">expected_inter</span><span class="p">,</span> <span class="n">observed_p</span><span class="o">.</span><span class="n">Inter</span><span class="o">.</span><span class="n">values</span><span class="p">))</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">assertEqual</span><span class="p">(</span><span class="n">expected_remove_g</span><span class="p">,</span> <span class="n">observed_remove_g</span><span class="p">)</span>

        <span class="c"># Sample shouldn&#39;t be included if chrx is False, but Gender in covars</span>
        <span class="n">args</span><span class="o">.</span><span class="n">covar</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="s">&quot;Gender&quot;</span><span class="p">)</span>
        <span class="n">args</span><span class="o">.</span><span class="n">chrx</span> <span class="o">=</span> <span class="bp">False</span>

        <span class="c"># The expected values</span>
        <span class="n">expected_shape</span> <span class="o">=</span> <span class="p">(</span><span class="mi">3</span><span class="p">,</span> <span class="mi">6</span><span class="p">)</span>
        <span class="n">expected_remove_g</span> <span class="o">=</span> <span class="bp">False</span>

        <span class="c"># The observed values</span>
        <span class="n">observed_p</span><span class="p">,</span> <span class="n">observed_remove_g</span> <span class="o">=</span> <span class="n">read_phenotype</span><span class="p">(</span><span class="n">filename</span><span class="p">,</span> <span class="n">args</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">assertTrue</span><span class="p">(</span><span class="nb">isinstance</span><span class="p">(</span><span class="n">observed_p</span><span class="p">,</span> <span class="n">pd</span><span class="o">.</span><span class="n">DataFrame</span><span class="p">))</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">assertEqual</span><span class="p">(</span><span class="n">expected_shape</span><span class="p">,</span> <span class="n">observed_p</span><span class="o">.</span><span class="n">shape</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">assertEqual</span><span class="p">(</span><span class="n">expected_columns</span><span class="p">,</span> <span class="nb">set</span><span class="p">(</span><span class="n">observed_p</span><span class="o">.</span><span class="n">columns</span><span class="p">))</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">assertEqual</span><span class="p">(</span><span class="n">expected_index</span><span class="p">[:</span><span class="o">-</span><span class="mi">1</span><span class="p">],</span> <span class="nb">list</span><span class="p">(</span><span class="n">observed_p</span><span class="o">.</span><span class="n">index</span><span class="p">))</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">assertTrue</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">allclose</span><span class="p">(</span><span class="n">expected_c1</span><span class="p">[:</span><span class="o">-</span><span class="mi">1</span><span class="p">],</span> <span class="n">observed_p</span><span class="o">.</span><span class="n">C1</span><span class="o">.</span><span class="n">values</span><span class="p">))</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">assertTrue</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">allclose</span><span class="p">(</span><span class="n">expected_c2</span><span class="p">[:</span><span class="o">-</span><span class="mi">1</span><span class="p">],</span> <span class="n">observed_p</span><span class="o">.</span><span class="n">C2</span><span class="o">.</span><span class="n">values</span><span class="p">))</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">assertTrue</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">allclose</span><span class="p">(</span><span class="n">expected_c3</span><span class="p">[:</span><span class="o">-</span><span class="mi">1</span><span class="p">],</span> <span class="n">observed_p</span><span class="o">.</span><span class="n">C3</span><span class="o">.</span><span class="n">values</span><span class="p">))</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">assertTrue</span><span class="p">(</span>
            <span class="p">(</span><span class="n">expected_gender</span><span class="p">[:</span><span class="o">-</span><span class="mi">1</span><span class="p">]</span> <span class="o">==</span> <span class="n">observed_p</span><span class="o">.</span><span class="n">Gender</span><span class="o">.</span><span class="n">values</span><span class="p">)</span><span class="o">.</span><span class="n">all</span><span class="p">()</span>
        <span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">assertTrue</span><span class="p">(</span>
            <span class="p">(</span><span class="n">expected_pheno</span><span class="p">[:</span><span class="o">-</span><span class="mi">1</span><span class="p">]</span> <span class="o">==</span> <span class="n">observed_p</span><span class="o">.</span><span class="n">Pheno_Logit</span><span class="o">.</span><span class="n">values</span><span class="p">)</span><span class="o">.</span><span class="n">all</span><span class="p">()</span>
        <span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">assertTrue</span><span class="p">(</span>
            <span class="n">np</span><span class="o">.</span><span class="n">allclose</span><span class="p">(</span><span class="n">expected_inter</span><span class="p">[:</span><span class="o">-</span><span class="mi">1</span><span class="p">],</span> <span class="n">observed_p</span><span class="o">.</span><span class="n">Inter</span><span class="o">.</span><span class="n">values</span><span class="p">)</span>
        <span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">assertEqual</span><span class="p">(</span><span class="n">expected_remove_g</span><span class="p">,</span> <span class="n">observed_remove_g</span><span class="p">)</span>

        <span class="c"># Removing gender in the covar should add a sample</span>
        <span class="n">args</span><span class="o">.</span><span class="n">covar</span> <span class="o">=</span> <span class="n">args</span><span class="o">.</span><span class="n">covar</span><span class="p">[:</span><span class="o">-</span><span class="mi">1</span><span class="p">]</span>

        <span class="c"># The expected values</span>
        <span class="n">expected_shape</span> <span class="o">=</span> <span class="p">(</span><span class="mi">4</span><span class="p">,</span> <span class="mi">5</span><span class="p">)</span>
        <span class="n">expected_columns</span><span class="o">.</span><span class="n">remove</span><span class="p">(</span><span class="s">&quot;Gender&quot;</span><span class="p">)</span>

        <span class="c"># The observed values</span>
        <span class="n">observed_p</span><span class="p">,</span> <span class="n">observed_remove_g</span> <span class="o">=</span> <span class="n">read_phenotype</span><span class="p">(</span><span class="n">filename</span><span class="p">,</span> <span class="n">args</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">assertTrue</span><span class="p">(</span><span class="nb">isinstance</span><span class="p">(</span><span class="n">observed_p</span><span class="p">,</span> <span class="n">pd</span><span class="o">.</span><span class="n">DataFrame</span><span class="p">))</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">assertEqual</span><span class="p">(</span><span class="n">expected_shape</span><span class="p">,</span> <span class="n">observed_p</span><span class="o">.</span><span class="n">shape</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">assertEqual</span><span class="p">(</span><span class="n">expected_columns</span><span class="p">,</span> <span class="nb">set</span><span class="p">(</span><span class="n">observed_p</span><span class="o">.</span><span class="n">columns</span><span class="p">))</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">assertEqual</span><span class="p">(</span><span class="n">expected_index</span><span class="p">,</span> <span class="nb">list</span><span class="p">(</span><span class="n">observed_p</span><span class="o">.</span><span class="n">index</span><span class="p">))</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">assertTrue</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">allclose</span><span class="p">(</span><span class="n">expected_c1</span><span class="p">,</span> <span class="n">observed_p</span><span class="o">.</span><span class="n">C1</span><span class="o">.</span><span class="n">values</span><span class="p">))</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">assertTrue</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">allclose</span><span class="p">(</span><span class="n">expected_c2</span><span class="p">,</span> <span class="n">observed_p</span><span class="o">.</span><span class="n">C2</span><span class="o">.</span><span class="n">values</span><span class="p">))</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">assertTrue</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">allclose</span><span class="p">(</span><span class="n">expected_c3</span><span class="p">,</span> <span class="n">observed_p</span><span class="o">.</span><span class="n">C3</span><span class="o">.</span><span class="n">values</span><span class="p">))</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">assertTrue</span><span class="p">(</span>
            <span class="p">(</span><span class="n">expected_pheno</span> <span class="o">==</span> <span class="n">observed_p</span><span class="o">.</span><span class="n">Pheno_Logit</span><span class="o">.</span><span class="n">values</span><span class="p">)</span><span class="o">.</span><span class="n">all</span><span class="p">()</span>
        <span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">assertTrue</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">allclose</span><span class="p">(</span><span class="n">expected_inter</span><span class="p">,</span> <span class="n">observed_p</span><span class="o">.</span><span class="n">Inter</span><span class="o">.</span><span class="n">values</span><span class="p">))</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">assertEqual</span><span class="p">(</span><span class="n">expected_remove_g</span><span class="p">,</span> <span class="n">observed_remove_g</span><span class="p">)</span>

        <span class="c"># Setting chromosome to X should also include the sample</span>
        <span class="n">args</span><span class="o">.</span><span class="n">chrx</span> <span class="o">=</span> <span class="bp">True</span>

        <span class="c"># The expected values</span>
        <span class="n">expected_shape</span> <span class="o">=</span> <span class="p">(</span><span class="mi">4</span><span class="p">,</span> <span class="mi">6</span><span class="p">)</span>
        <span class="n">expected_columns</span><span class="o">.</span><span class="n">add</span><span class="p">(</span><span class="s">&quot;Gender&quot;</span><span class="p">)</span>
        <span class="n">expected_remove_g</span> <span class="o">=</span> <span class="bp">True</span>

        <span class="c"># The observed values</span>
        <span class="n">observed_p</span><span class="p">,</span> <span class="n">observed_remove_g</span> <span class="o">=</span> <span class="n">read_phenotype</span><span class="p">(</span><span class="n">filename</span><span class="p">,</span> <span class="n">args</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">assertTrue</span><span class="p">(</span><span class="nb">isinstance</span><span class="p">(</span><span class="n">observed_p</span><span class="p">,</span> <span class="n">pd</span><span class="o">.</span><span class="n">DataFrame</span><span class="p">))</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">assertEqual</span><span class="p">(</span><span class="n">expected_shape</span><span class="p">,</span> <span class="n">observed_p</span><span class="o">.</span><span class="n">shape</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">assertEqual</span><span class="p">(</span><span class="n">expected_columns</span><span class="p">,</span> <span class="nb">set</span><span class="p">(</span><span class="n">observed_p</span><span class="o">.</span><span class="n">columns</span><span class="p">))</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">assertEqual</span><span class="p">(</span><span class="n">expected_index</span><span class="p">,</span> <span class="nb">list</span><span class="p">(</span><span class="n">observed_p</span><span class="o">.</span><span class="n">index</span><span class="p">))</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">assertTrue</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">allclose</span><span class="p">(</span><span class="n">expected_c1</span><span class="p">,</span> <span class="n">observed_p</span><span class="o">.</span><span class="n">C1</span><span class="o">.</span><span class="n">values</span><span class="p">))</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">assertTrue</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">allclose</span><span class="p">(</span><span class="n">expected_c2</span><span class="p">,</span> <span class="n">observed_p</span><span class="o">.</span><span class="n">C2</span><span class="o">.</span><span class="n">values</span><span class="p">))</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">assertTrue</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">allclose</span><span class="p">(</span><span class="n">expected_c3</span><span class="p">,</span> <span class="n">observed_p</span><span class="o">.</span><span class="n">C3</span><span class="o">.</span><span class="n">values</span><span class="p">))</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">assertTrue</span><span class="p">(</span>
            <span class="p">(</span><span class="n">expected_pheno</span> <span class="o">==</span> <span class="n">observed_p</span><span class="o">.</span><span class="n">Pheno_Logit</span><span class="o">.</span><span class="n">values</span><span class="p">)</span><span class="o">.</span><span class="n">all</span><span class="p">()</span>
        <span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">assertTrue</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">allclose</span><span class="p">(</span><span class="n">expected_inter</span><span class="p">,</span> <span class="n">observed_p</span><span class="o">.</span><span class="n">Inter</span><span class="o">.</span><span class="n">values</span><span class="p">))</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">assertEqual</span><span class="p">(</span><span class="n">expected_remove_g</span><span class="p">,</span> <span class="n">observed_remove_g</span><span class="p">)</span>

    <span class="k">def</span> <span class="nf">test_read_samples</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span></div>
<div class="viewcode-block" id="TestImputedStats.test_read_samples"><a class="viewcode-back" href="../../../module_content/gwip.tests.html#gwip.tests.test_imputed_stats.TestImputedStats.test_read_samples">[docs]</a>        <span class="sd">&quot;&quot;&quot;Tests the &#39;read_samples&#39; function.&quot;&quot;&quot;</span>
        <span class="c"># Creating the sample file</span>
        <span class="n">sample_content</span> <span class="o">=</span> <span class="p">(</span>
            <span class="s">&quot;ID_1 ID_2 missing father mother sex plink_pheno</span><span class="se">\n</span><span class="s">&quot;</span>
            <span class="s">&quot;0 0 0 D D D B</span><span class="se">\n</span><span class="s">&quot;</span>
            <span class="s">&quot;fam_1 sample_1 0 0 0 2 -9</span><span class="se">\n</span><span class="s">&quot;</span>
            <span class="s">&quot;fam_1 sample_2 0 0 0 1 -9</span><span class="se">\n</span><span class="s">&quot;</span>
            <span class="s">&quot;fam_2 sample_3 0 0 0 2 -9</span><span class="se">\n</span><span class="s">&quot;</span>
        <span class="p">)</span>
        <span class="n">sample_filename</span> <span class="o">=</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">output_dir</span><span class="o">.</span><span class="n">name</span><span class="p">,</span> <span class="s">&quot;test.sample&quot;</span><span class="p">)</span>
        <span class="k">with</span> <span class="nb">open</span><span class="p">(</span><span class="n">sample_filename</span><span class="p">,</span> <span class="s">&quot;w&quot;</span><span class="p">)</span> <span class="k">as</span> <span class="n">o_file</span><span class="p">:</span>
            <span class="n">o_file</span><span class="o">.</span><span class="n">write</span><span class="p">(</span><span class="n">sample_content</span><span class="p">)</span>

        <span class="c"># The expected values</span>
        <span class="n">expected_columns</span> <span class="o">=</span> <span class="p">[</span><span class="s">&quot;ID_1&quot;</span><span class="p">]</span>
        <span class="n">expected_index</span> <span class="o">=</span> <span class="p">[</span><span class="s">&quot;sample_1&quot;</span><span class="p">,</span> <span class="s">&quot;sample_2&quot;</span><span class="p">,</span> <span class="s">&quot;sample_3&quot;</span><span class="p">]</span>
        <span class="n">expected_fam</span> <span class="o">=</span> <span class="p">[</span><span class="s">&quot;fam_1&quot;</span><span class="p">,</span> <span class="s">&quot;fam_1&quot;</span><span class="p">,</span> <span class="s">&quot;fam_2&quot;</span><span class="p">]</span>

        <span class="c"># The observed values</span>
        <span class="n">observed</span> <span class="o">=</span> <span class="n">read_samples</span><span class="p">(</span><span class="n">sample_filename</span><span class="p">)</span>

        <span class="c"># Checking</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">assertTrue</span><span class="p">(</span><span class="nb">isinstance</span><span class="p">(</span><span class="n">observed</span><span class="p">,</span> <span class="n">pd</span><span class="o">.</span><span class="n">DataFrame</span><span class="p">))</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">assertEqual</span><span class="p">((</span><span class="mi">3</span><span class="p">,</span> <span class="mi">1</span><span class="p">),</span> <span class="n">observed</span><span class="o">.</span><span class="n">shape</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">assertEqual</span><span class="p">(</span><span class="n">expected_columns</span><span class="p">,</span> <span class="n">observed</span><span class="o">.</span><span class="n">columns</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">assertEqual</span><span class="p">(</span><span class="n">expected_index</span><span class="p">,</span> <span class="nb">list</span><span class="p">(</span><span class="n">observed</span><span class="o">.</span><span class="n">index</span><span class="o">.</span><span class="n">values</span><span class="p">))</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">assertEqual</span><span class="p">(</span><span class="n">expected_fam</span><span class="p">,</span> <span class="nb">list</span><span class="p">(</span><span class="n">observed</span><span class="o">.</span><span class="n">ID_1</span><span class="o">.</span><span class="n">values</span><span class="p">))</span>

        <span class="c"># Having a duplicated samples will trigger an exception</span>
        <span class="n">sample_content</span> <span class="o">=</span> <span class="p">(</span>
            <span class="s">&quot;ID_1 ID_2 missing father mother sex plink_pheno</span><span class="se">\n</span><span class="s">&quot;</span>
            <span class="s">&quot;0 0 0 D D D B</span><span class="se">\n</span><span class="s">&quot;</span>
            <span class="s">&quot;fam_1 sample_1 0 0 0 2 -9</span><span class="se">\n</span><span class="s">&quot;</span>
            <span class="s">&quot;fam_1 sample_2 0 0 0 1 -9</span><span class="se">\n</span><span class="s">&quot;</span>
            <span class="s">&quot;fam_2 sample_2 0 0 0 2 -9</span><span class="se">\n</span><span class="s">&quot;</span>
        <span class="p">)</span>
        <span class="k">with</span> <span class="nb">open</span><span class="p">(</span><span class="n">sample_filename</span><span class="p">,</span> <span class="s">&quot;w&quot;</span><span class="p">)</span> <span class="k">as</span> <span class="n">o_file</span><span class="p">:</span>
            <span class="n">o_file</span><span class="o">.</span><span class="n">write</span><span class="p">(</span><span class="n">sample_content</span><span class="p">)</span>

        <span class="c"># Checking</span>
        <span class="k">with</span> <span class="bp">self</span><span class="o">.</span><span class="n">assertRaises</span><span class="p">(</span><span class="ne">ValueError</span><span class="p">)</span> <span class="k">as</span> <span class="n">cm</span><span class="p">:</span>
            <span class="n">read_samples</span><span class="p">(</span><span class="n">sample_filename</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">assertEqual</span><span class="p">(</span><span class="s">&quot;Index has duplicate keys: [&#39;sample_2&#39;]&quot;</span><span class="p">,</span>
                         <span class="nb">str</span><span class="p">(</span><span class="n">cm</span><span class="o">.</span><span class="n">exception</span><span class="p">))</span>

    <span class="k">def</span> <span class="nf">test_read_sites_to_extract</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span></div>
<div class="viewcode-block" id="TestImputedStats.test_read_sites_to_extract"><a class="viewcode-back" href="../../../module_content/gwip.tests.html#gwip.tests.test_imputed_stats.TestImputedStats.test_read_sites_to_extract">[docs]</a>        <span class="sd">&quot;&quot;&quot;Tests the &#39;test_read_sites_to_extract&#39; function.&quot;&quot;&quot;</span>
        <span class="n">file_content</span> <span class="o">=</span> <span class="p">[</span><span class="s">&quot;marker_{}&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">i</span><span class="p">)</span> <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="mi">100</span><span class="p">)]</span> <span class="o">*</span> <span class="mi">2</span>
        <span class="n">filename</span> <span class="o">=</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">output_dir</span><span class="o">.</span><span class="n">name</span><span class="p">,</span> <span class="s">&quot;markers.txt&quot;</span><span class="p">)</span>
        <span class="k">with</span> <span class="nb">open</span><span class="p">(</span><span class="n">filename</span><span class="p">,</span> <span class="s">&quot;w&quot;</span><span class="p">)</span> <span class="k">as</span> <span class="n">o_file</span><span class="p">:</span>
            <span class="n">o_file</span><span class="o">.</span><span class="n">write</span><span class="p">(</span><span class="s">&quot;</span><span class="se">\n</span><span class="s">&quot;</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">file_content</span><span class="p">)</span> <span class="o">+</span> <span class="s">&quot;</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">)</span>

        <span class="c"># The expected values</span>
        <span class="n">expected</span> <span class="o">=</span> <span class="p">{</span><span class="s">&quot;marker_{}&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">i</span><span class="p">)</span> <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="mi">100</span><span class="p">)}</span>

        <span class="c"># The observed values</span>
        <span class="n">observed</span> <span class="o">=</span> <span class="n">read_sites_to_extract</span><span class="p">(</span><span class="n">filename</span><span class="p">)</span>

        <span class="c"># Checking</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">assertEqual</span><span class="p">(</span><span class="n">expected</span><span class="p">,</span> <span class="n">observed</span><span class="p">)</span>

    <span class="nd">@unittest.skip</span><span class="p">(</span><span class="s">&quot;Test not implemented&quot;</span><span class="p">)</span></div>
    <span class="k">def</span> <span class="nf">test_compute_statistics</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
<div class="viewcode-block" id="TestImputedStats.test_compute_statistics"><a class="viewcode-back" href="../../../module_content/gwip.tests.html#gwip.tests.test_imputed_stats.TestImputedStats.test_compute_statistics">[docs]</a>        <span class="sd">&quot;&quot;&quot;Tests the &#39;compute_statistics&#39; function.&quot;&quot;&quot;</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">fail</span><span class="p">(</span><span class="s">&quot;Test not implemented&quot;</span><span class="p">)</span>

    <span class="nd">@unittest.skip</span><span class="p">(</span><span class="s">&quot;Test not implemented&quot;</span><span class="p">)</span></div>
    <span class="k">def</span> <span class="nf">test_process_impute2_site</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
<div class="viewcode-block" id="TestImputedStats.test_process_impute2_site"><a class="viewcode-back" href="../../../module_content/gwip.tests.html#gwip.tests.test_imputed_stats.TestImputedStats.test_process_impute2_site">[docs]</a>        <span class="sd">&quot;&quot;&quot;Tests the &#39;process_impute2_site&#39; function.&quot;&quot;&quot;</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">fail</span><span class="p">(</span><span class="s">&quot;Test not implemented&quot;</span><span class="p">)</span>

    <span class="k">def</span> <span class="nf">test_samples_with_hetero_calls</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span></div>
<div class="viewcode-block" id="TestImputedStats.test_samples_with_hetero_calls"><a class="viewcode-back" href="../../../module_content/gwip.tests.html#gwip.tests.test_imputed_stats.TestImputedStats.test_samples_with_hetero_calls">[docs]</a>        <span class="sd">&quot;&quot;&quot;Tests the &#39;samples_with_hetero_calls&#39; function.&quot;&quot;&quot;</span>
        <span class="n">data</span> <span class="o">=</span> <span class="p">[</span>
            <span class="p">(</span><span class="s">&quot;sample_1&quot;</span><span class="p">,</span> <span class="mf">1.0</span><span class="p">,</span> <span class="mf">0.0</span><span class="p">,</span> <span class="mf">0.0</span><span class="p">),</span>
            <span class="p">(</span><span class="s">&quot;sample_2&quot;</span><span class="p">,</span> <span class="mf">0.0</span><span class="p">,</span> <span class="mf">1.0</span><span class="p">,</span> <span class="mf">0.0</span><span class="p">),</span>
            <span class="p">(</span><span class="s">&quot;sample_3&quot;</span><span class="p">,</span> <span class="mf">0.0</span><span class="p">,</span> <span class="mf">0.0</span><span class="p">,</span> <span class="mf">1.0</span><span class="p">),</span>
            <span class="p">(</span><span class="s">&quot;sample_4&quot;</span><span class="p">,</span> <span class="mf">0.9</span><span class="p">,</span> <span class="mf">0.1</span><span class="p">,</span> <span class="mf">0.0</span><span class="p">),</span>
            <span class="p">(</span><span class="s">&quot;sample_5&quot;</span><span class="p">,</span> <span class="mf">0.1</span><span class="p">,</span> <span class="mf">0.8</span><span class="p">,</span> <span class="mf">0.1</span><span class="p">),</span>
            <span class="p">(</span><span class="s">&quot;sample_6&quot;</span><span class="p">,</span> <span class="mf">0.0</span><span class="p">,</span> <span class="mf">0.4</span><span class="p">,</span> <span class="mf">0.6</span><span class="p">),</span>
            <span class="p">(</span><span class="s">&quot;sample_7&quot;</span><span class="p">,</span> <span class="mf">0.2</span><span class="p">,</span> <span class="mf">0.5</span><span class="p">,</span> <span class="mf">0.3</span><span class="p">),</span>
            <span class="p">(</span><span class="s">&quot;sample_8&quot;</span><span class="p">,</span> <span class="mf">0.9</span><span class="p">,</span> <span class="mf">0.05</span><span class="p">,</span> <span class="mf">0.05</span><span class="p">),</span>
            <span class="p">(</span><span class="s">&quot;sample_9&quot;</span><span class="p">,</span> <span class="mf">0.0</span><span class="p">,</span> <span class="mf">1.0</span><span class="p">,</span> <span class="mf">0.0</span><span class="p">),</span>
        <span class="p">]</span>
        <span class="n">data</span> <span class="o">=</span> <span class="n">pd</span><span class="o">.</span><span class="n">DataFrame</span><span class="p">(</span><span class="n">data</span><span class="p">,</span> <span class="n">columns</span><span class="o">=</span><span class="p">[</span><span class="s">&quot;sample_id&quot;</span><span class="p">,</span> <span class="s">&quot;D1&quot;</span><span class="p">,</span> <span class="s">&quot;D2&quot;</span><span class="p">,</span> <span class="s">&quot;D3&quot;</span><span class="p">])</span>
        <span class="n">data</span> <span class="o">=</span> <span class="n">data</span><span class="o">.</span><span class="n">set_index</span><span class="p">(</span><span class="s">&quot;sample_id&quot;</span><span class="p">,</span> <span class="n">verify_integrity</span><span class="o">=</span><span class="bp">True</span><span class="p">)</span>

        <span class="c"># The expected results</span>
        <span class="n">expected</span> <span class="o">=</span> <span class="p">[</span><span class="s">&quot;sample_2&quot;</span><span class="p">,</span> <span class="s">&quot;sample_5&quot;</span><span class="p">,</span> <span class="s">&quot;sample_7&quot;</span><span class="p">,</span> <span class="s">&quot;sample_9&quot;</span><span class="p">]</span>

        <span class="c"># The observed results</span>
        <span class="n">observed</span> <span class="o">=</span> <span class="n">samples_with_hetero_calls</span><span class="p">(</span><span class="n">data</span><span class="p">,</span> <span class="s">&quot;D2&quot;</span><span class="p">)</span>

        <span class="c"># Checking</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">assertTrue</span><span class="p">(</span><span class="nb">isinstance</span><span class="p">(</span><span class="n">observed</span><span class="p">,</span> <span class="n">pd</span><span class="o">.</span><span class="n">Index</span><span class="p">))</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">assertEqual</span><span class="p">(</span><span class="n">expected</span><span class="p">,</span> <span class="nb">list</span><span class="p">(</span><span class="n">observed</span><span class="p">))</span>

    <span class="k">def</span> <span class="nf">test_get_formula</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span></div>
<div class="viewcode-block" id="TestImputedStats.test_get_formula"><a class="viewcode-back" href="../../../module_content/gwip.tests.html#gwip.tests.test_imputed_stats.TestImputedStats.test_get_formula">[docs]</a>        <span class="sd">&quot;&quot;&quot;Tests the &#39;get_formula&#39; function.&quot;&quot;&quot;</span>
        <span class="c"># Testing with only one phenotype (no covars, no interaction)</span>
        <span class="n">expected</span> <span class="o">=</span> <span class="s">&quot;pheno ~ _GenoD&quot;</span>
        <span class="n">observed</span> <span class="o">=</span> <span class="n">get_formula</span><span class="p">(</span><span class="s">&quot;pheno&quot;</span><span class="p">,</span> <span class="p">[],</span> <span class="bp">None</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">assertEqual</span><span class="p">(</span><span class="n">expected</span><span class="p">,</span> <span class="n">observed</span><span class="p">)</span>

        <span class="c"># Testing with one covar, no interaction</span>
        <span class="n">expected</span> <span class="o">=</span> <span class="s">&quot;pheno ~ _GenoD + C1&quot;</span>
        <span class="n">observed</span> <span class="o">=</span> <span class="n">get_formula</span><span class="p">(</span><span class="s">&quot;pheno&quot;</span><span class="p">,</span> <span class="p">[</span><span class="s">&quot;C1&quot;</span><span class="p">],</span> <span class="bp">None</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">assertEqual</span><span class="p">(</span><span class="n">expected</span><span class="p">,</span> <span class="n">observed</span><span class="p">)</span>

        <span class="c"># Testing with more than one covar, no interaction</span>
        <span class="n">expected</span> <span class="o">=</span> <span class="s">&quot;pheno ~ _GenoD + C1 + C2 + C3&quot;</span>
        <span class="n">observed</span> <span class="o">=</span> <span class="n">get_formula</span><span class="p">(</span><span class="s">&quot;pheno&quot;</span><span class="p">,</span> <span class="p">[</span><span class="s">&quot;C1&quot;</span><span class="p">,</span> <span class="s">&quot;C2&quot;</span><span class="p">,</span> <span class="s">&quot;C3&quot;</span><span class="p">],</span> <span class="bp">None</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">assertEqual</span><span class="p">(</span><span class="n">expected</span><span class="p">,</span> <span class="n">observed</span><span class="p">)</span>

        <span class="c"># Testing with without covar, but with interaction</span>
        <span class="n">expected</span> <span class="o">=</span> <span class="s">&quot;pheno ~ _GenoD + _GenoD*inter&quot;</span>
        <span class="n">observed</span> <span class="o">=</span> <span class="n">get_formula</span><span class="p">(</span><span class="s">&quot;pheno&quot;</span><span class="p">,</span> <span class="p">[],</span> <span class="s">&quot;inter&quot;</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">assertEqual</span><span class="p">(</span><span class="n">expected</span><span class="p">,</span> <span class="n">observed</span><span class="p">)</span>

        <span class="c"># Testing with one covar and interaction</span>
        <span class="n">expected</span> <span class="o">=</span> <span class="s">&quot;pheno ~ _GenoD + inter + _GenoD*inter&quot;</span>
        <span class="n">observed</span> <span class="o">=</span> <span class="n">get_formula</span><span class="p">(</span><span class="s">&quot;pheno&quot;</span><span class="p">,</span> <span class="p">[</span><span class="s">&quot;inter&quot;</span><span class="p">],</span> <span class="s">&quot;inter&quot;</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">assertEqual</span><span class="p">(</span><span class="n">expected</span><span class="p">,</span> <span class="n">observed</span><span class="p">)</span>

        <span class="c"># Testing with more than one covar and interaction</span>
        <span class="n">expected</span> <span class="o">=</span> <span class="s">&quot;pheno ~ _GenoD + C1 + C2 + C3 + inter + _GenoD*inter&quot;</span>
        <span class="n">observed</span> <span class="o">=</span> <span class="n">get_formula</span><span class="p">(</span><span class="s">&quot;pheno&quot;</span><span class="p">,</span> <span class="p">[</span><span class="s">&quot;C1&quot;</span><span class="p">,</span> <span class="s">&quot;C2&quot;</span><span class="p">,</span> <span class="s">&quot;C3&quot;</span><span class="p">,</span> <span class="s">&quot;inter&quot;</span><span class="p">],</span> <span class="s">&quot;inter&quot;</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">assertEqual</span><span class="p">(</span><span class="n">expected</span><span class="p">,</span> <span class="n">observed</span><span class="p">)</span>

    <span class="nd">@unittest.skip</span><span class="p">(</span><span class="s">&quot;Test not implemented&quot;</span><span class="p">)</span></div>
    <span class="k">def</span> <span class="nf">test_get_result_from_linear_logistic</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
<div class="viewcode-block" id="TestImputedStats.test_get_result_from_linear_logistic"><a class="viewcode-back" href="../../../module_content/gwip.tests.html#gwip.tests.test_imputed_stats.TestImputedStats.test_get_result_from_linear_logistic">[docs]</a>        <span class="sd">&quot;&quot;&quot;Tests the &#39;_get_result_from_linear_logistic&#39; function.&quot;&quot;&quot;</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">fail</span><span class="p">(</span><span class="s">&quot;Test not implemented&quot;</span><span class="p">)</span>

    <span class="nd">@unittest.skip</span><span class="p">(</span><span class="s">&quot;Test not implemented&quot;</span><span class="p">)</span></div>
    <span class="k">def</span> <span class="nf">test_check_args</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
<div class="viewcode-block" id="TestImputedStats.test_check_args"><a class="viewcode-back" href="../../../module_content/gwip.tests.html#gwip.tests.test_imputed_stats.TestImputedStats.test_check_args">[docs]</a>        <span class="sd">&quot;&quot;&quot;Tests the &#39;check_args&#39; function.&quot;&quot;&quot;</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">fail</span><span class="p">(</span><span class="s">&quot;Test not implemented&quot;</span><span class="p">)</span>


<span class="nd">@unittest.skipIf</span><span class="p">(</span><span class="ow">not</span> <span class="n">HAS_LIFELINES</span><span class="p">,</span></div></div>
                 <span class="s">&quot;optional requirement (lifelines) not satisfied&quot;</span><span class="p">)</span>
<span class="k">class</span> <span class="nc">TestImputedStatsCox</span><span class="p">(</span><span class="n">unittest</span><span class="o">.</span><span class="n">TestCase</span><span class="p">):</span>
<div class="viewcode-block" id="TestImputedStatsCox"><a class="viewcode-back" href="../../../module_content/gwip.tests.html#gwip.tests.test_imputed_stats.TestImputedStatsCox">[docs]</a>
    <span class="k">def</span> <span class="nf">setUp</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
<div class="viewcode-block" id="TestImputedStatsCox.setUp"><a class="viewcode-back" href="../../../module_content/gwip.tests.html#gwip.tests.test_imputed_stats.TestImputedStatsCox.setUp">[docs]</a>        <span class="sd">&quot;&quot;&quot;Setup the tests.&quot;&quot;&quot;</span>
        <span class="c"># Creating the temporary directory</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">output_dir</span> <span class="o">=</span> <span class="n">TemporaryDirectory</span><span class="p">(</span><span class="n">prefix</span><span class="o">=</span><span class="s">&quot;gwip_test_&quot;</span><span class="p">)</span>

    <span class="k">def</span> <span class="nf">tearDown</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span></div>
<div class="viewcode-block" id="TestImputedStatsCox.tearDown"><a class="viewcode-back" href="../../../module_content/gwip.tests.html#gwip.tests.test_imputed_stats.TestImputedStatsCox.tearDown">[docs]</a>        <span class="sd">&quot;&quot;&quot;Finishes the test.&quot;&quot;&quot;</span>
        <span class="c"># Deleting the output directory</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">output_dir</span><span class="o">.</span><span class="n">cleanup</span><span class="p">()</span>

    <span class="k">def</span> <span class="nf">test_fit_cox</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span></div>
<div class="viewcode-block" id="TestImputedStatsCox.test_fit_cox"><a class="viewcode-back" href="../../../module_content/gwip.tests.html#gwip.tests.test_imputed_stats.TestImputedStatsCox.test_fit_cox">[docs]</a>        <span class="sd">&quot;&quot;&quot;Tests the &#39;fit_cox&#39; function.&quot;&quot;&quot;</span>
        <span class="c"># Reading the data</span>
        <span class="n">data_filename</span> <span class="o">=</span> <span class="n">resource_filename</span><span class="p">(</span>
            <span class="n">__name__</span><span class="p">,</span>
            <span class="s">&quot;data/regression_sim.txt.bz2&quot;</span><span class="p">,</span>
        <span class="p">)</span>

        <span class="c"># This dataset contains 3 markers + 5 covariables</span>
        <span class="n">data</span> <span class="o">=</span> <span class="n">pd</span><span class="o">.</span><span class="n">read_csv</span><span class="p">(</span><span class="n">data_filename</span><span class="p">,</span> <span class="n">sep</span><span class="o">=</span><span class="s">&quot;</span><span class="se">\t</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">compression</span><span class="o">=</span><span class="s">&quot;bz2&quot;</span><span class="p">)</span>
        <span class="n">columns_to_keep</span> <span class="o">=</span> <span class="p">[</span><span class="s">&quot;y&quot;</span><span class="p">,</span> <span class="s">&quot;y_d&quot;</span><span class="p">,</span> <span class="s">&quot;snp1&quot;</span><span class="p">,</span> <span class="s">&quot;C1&quot;</span><span class="p">,</span> <span class="s">&quot;C2&quot;</span><span class="p">,</span> <span class="s">&quot;C3&quot;</span><span class="p">,</span> <span class="s">&quot;age&quot;</span><span class="p">,</span>
                           <span class="s">&quot;gender&quot;</span><span class="p">]</span>

        <span class="c"># The expected results for the first marker (according to R)</span>
        <span class="c"># P value was given by 2*pnorm(z) according to this site</span>
        <span class="c"># https://stat.ethz.ch/pipermail/r-help/2008-October/178439.html</span>
        <span class="n">expected_coef</span> <span class="o">=</span> <span class="o">-</span><span class="mf">0.9892699611323815256</span>
        <span class="n">expected_se</span> <span class="o">=</span> <span class="mf">0.0645633075569013448</span>
        <span class="n">expected_min_ci</span> <span class="o">=</span> <span class="o">-</span><span class="mf">1.11581171866669093</span>
        <span class="n">expected_max_ci</span> <span class="o">=</span> <span class="o">-</span><span class="mf">0.86272820359807223</span>
        <span class="n">expected_z</span> <span class="o">=</span> <span class="o">-</span><span class="mf">15.32247957186071652</span>
        <span class="n">expected_p</span> <span class="o">=</span> <span class="mf">5.41131727236088009e-53</span>

        <span class="c"># The observed results for the first marker</span>
        <span class="n">observed</span> <span class="o">=</span> <span class="n">fit_cox</span><span class="p">(</span>
            <span class="n">data</span><span class="o">=</span><span class="n">data</span><span class="p">[</span><span class="n">columns_to_keep</span><span class="p">]</span><span class="o">.</span><span class="n">dropna</span><span class="p">(</span><span class="n">axis</span><span class="o">=</span><span class="mi">0</span><span class="p">),</span>
            <span class="n">time_to_event</span><span class="o">=</span><span class="s">&quot;y&quot;</span><span class="p">,</span>
            <span class="n">event</span><span class="o">=</span><span class="s">&quot;y_d&quot;</span><span class="p">,</span>
            <span class="n">result_col</span><span class="o">=</span><span class="s">&quot;snp1&quot;</span><span class="p">,</span>
        <span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">assertEqual</span><span class="p">(</span><span class="mi">6</span><span class="p">,</span> <span class="nb">len</span><span class="p">(</span><span class="n">observed</span><span class="p">))</span>
        <span class="n">observed_coef</span><span class="p">,</span> <span class="n">observed_se</span><span class="p">,</span> <span class="n">observed_min_ci</span><span class="p">,</span> <span class="n">observed_max_ci</span><span class="p">,</span> \
            <span class="n">observed_z</span><span class="p">,</span> <span class="n">observed_p</span> <span class="o">=</span> <span class="n">observed</span>

        <span class="c"># Comparing the results (P is not that similar though...)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">assertAlmostEqual</span><span class="p">(</span><span class="n">expected_coef</span><span class="p">,</span> <span class="n">observed_coef</span><span class="p">,</span> <span class="n">places</span><span class="o">=</span><span class="mi">10</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">assertAlmostEqual</span><span class="p">(</span><span class="n">expected_se</span><span class="p">,</span> <span class="n">observed_se</span><span class="p">,</span> <span class="n">places</span><span class="o">=</span><span class="mi">6</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">assertAlmostEqual</span><span class="p">(</span><span class="n">expected_min_ci</span><span class="p">,</span> <span class="n">observed_min_ci</span><span class="p">,</span> <span class="n">places</span><span class="o">=</span><span class="mi">4</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">assertAlmostEqual</span><span class="p">(</span><span class="n">expected_max_ci</span><span class="p">,</span> <span class="n">observed_max_ci</span><span class="p">,</span> <span class="n">places</span><span class="o">=</span><span class="mi">4</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">assertAlmostEqual</span><span class="p">(</span><span class="n">expected_z</span><span class="p">,</span> <span class="n">observed_z</span><span class="p">,</span> <span class="n">places</span><span class="o">=</span><span class="mi">4</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">assertAlmostEqual</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">log10</span><span class="p">(</span><span class="n">expected_p</span><span class="p">),</span> <span class="n">np</span><span class="o">.</span><span class="n">log10</span><span class="p">(</span><span class="n">observed_p</span><span class="p">),</span>
                               <span class="n">places</span><span class="o">=</span><span class="mi">3</span><span class="p">)</span>

        <span class="c"># The second marker</span>
        <span class="n">columns_to_keep</span> <span class="o">=</span> <span class="p">[</span><span class="s">&quot;y&quot;</span><span class="p">,</span> <span class="s">&quot;y_d&quot;</span><span class="p">,</span> <span class="s">&quot;snp2&quot;</span><span class="p">,</span> <span class="s">&quot;C1&quot;</span><span class="p">,</span> <span class="s">&quot;C2&quot;</span><span class="p">,</span> <span class="s">&quot;C3&quot;</span><span class="p">,</span> <span class="s">&quot;age&quot;</span><span class="p">,</span>
                           <span class="s">&quot;gender&quot;</span><span class="p">]</span>

        <span class="c"># The expected results for the first marker (according to R)</span>
        <span class="n">expected_coef</span> <span class="o">=</span> <span class="mf">0.0499084338021939383</span>
        <span class="n">expected_se</span> <span class="o">=</span> <span class="mf">0.0401904025600694215</span>
        <span class="n">expected_min_ci</span> <span class="o">=</span> <span class="o">-</span><span class="mf">0.0288633077397084936</span>
        <span class="n">expected_max_ci</span> <span class="o">=</span> <span class="mf">0.12868017534409637</span>
        <span class="n">expected_z</span> <span class="o">=</span> <span class="mf">1.241799798536472599</span>
        <span class="n">expected_p</span> <span class="o">=</span> <span class="mf">0.21431043709814412423</span>

        <span class="c"># The observed results for the first marker</span>
        <span class="n">observed</span> <span class="o">=</span> <span class="n">fit_cox</span><span class="p">(</span>
            <span class="n">data</span><span class="o">=</span><span class="n">data</span><span class="p">[</span><span class="n">columns_to_keep</span><span class="p">]</span><span class="o">.</span><span class="n">dropna</span><span class="p">(</span><span class="n">axis</span><span class="o">=</span><span class="mi">0</span><span class="p">),</span>
            <span class="n">time_to_event</span><span class="o">=</span><span class="s">&quot;y&quot;</span><span class="p">,</span>
            <span class="n">event</span><span class="o">=</span><span class="s">&quot;y_d&quot;</span><span class="p">,</span>
            <span class="n">result_col</span><span class="o">=</span><span class="s">&quot;snp2&quot;</span><span class="p">,</span>
        <span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">assertEqual</span><span class="p">(</span><span class="mi">6</span><span class="p">,</span> <span class="nb">len</span><span class="p">(</span><span class="n">observed</span><span class="p">))</span>
        <span class="n">observed_coef</span><span class="p">,</span> <span class="n">observed_se</span><span class="p">,</span> <span class="n">observed_min_ci</span><span class="p">,</span> <span class="n">observed_max_ci</span><span class="p">,</span> \
            <span class="n">observed_z</span><span class="p">,</span> <span class="n">observed_p</span> <span class="o">=</span> <span class="n">observed</span>

        <span class="c"># Comparing the results (P is not that similar though...)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">assertAlmostEqual</span><span class="p">(</span><span class="n">expected_coef</span><span class="p">,</span> <span class="n">observed_coef</span><span class="p">,</span> <span class="n">places</span><span class="o">=</span><span class="mi">10</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">assertAlmostEqual</span><span class="p">(</span><span class="n">expected_se</span><span class="p">,</span> <span class="n">observed_se</span><span class="p">,</span> <span class="n">places</span><span class="o">=</span><span class="mi">9</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">assertAlmostEqual</span><span class="p">(</span><span class="n">expected_min_ci</span><span class="p">,</span> <span class="n">observed_min_ci</span><span class="p">,</span> <span class="n">places</span><span class="o">=</span><span class="mi">4</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">assertAlmostEqual</span><span class="p">(</span><span class="n">expected_max_ci</span><span class="p">,</span> <span class="n">observed_max_ci</span><span class="p">,</span> <span class="n">places</span><span class="o">=</span><span class="mi">4</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">assertAlmostEqual</span><span class="p">(</span><span class="n">expected_z</span><span class="p">,</span> <span class="n">observed_z</span><span class="p">,</span> <span class="n">places</span><span class="o">=</span><span class="mi">8</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">assertAlmostEqual</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">log10</span><span class="p">(</span><span class="n">expected_p</span><span class="p">),</span> <span class="n">np</span><span class="o">.</span><span class="n">log10</span><span class="p">(</span><span class="n">observed_p</span><span class="p">),</span>
                               <span class="n">places</span><span class="o">=</span><span class="mi">8</span><span class="p">)</span>

        <span class="c"># The third marker</span>
        <span class="n">columns_to_keep</span> <span class="o">=</span> <span class="p">[</span><span class="s">&quot;y&quot;</span><span class="p">,</span> <span class="s">&quot;y_d&quot;</span><span class="p">,</span> <span class="s">&quot;snp3&quot;</span><span class="p">,</span> <span class="s">&quot;C1&quot;</span><span class="p">,</span> <span class="s">&quot;C2&quot;</span><span class="p">,</span> <span class="s">&quot;C3&quot;</span><span class="p">,</span> <span class="s">&quot;age&quot;</span><span class="p">,</span>
                           <span class="s">&quot;gender&quot;</span><span class="p">]</span>

        <span class="c"># The expected results for the first marker (according to R)</span>
        <span class="n">expected_coef</span> <span class="o">=</span> <span class="mf">1.114732193640146418</span>
        <span class="n">expected_se</span> <span class="o">=</span> <span class="mf">0.0631205046371715733</span>
        <span class="n">expected_min_ci</span> <span class="o">=</span> <span class="mf">0.991018277865296726</span>
        <span class="n">expected_max_ci</span> <span class="o">=</span> <span class="mf">1.23844610941499611</span>
        <span class="n">expected_z</span> <span class="o">=</span> <span class="mf">17.660381520202268035</span>
        <span class="n">expected_p</span> <span class="o">=</span> <span class="mf">8.46654634146707403e-70</span>

        <span class="c"># The observed results for the first marker</span>
        <span class="n">observed</span> <span class="o">=</span> <span class="n">fit_cox</span><span class="p">(</span>
            <span class="n">data</span><span class="o">=</span><span class="n">data</span><span class="p">[</span><span class="n">columns_to_keep</span><span class="p">]</span><span class="o">.</span><span class="n">dropna</span><span class="p">(</span><span class="n">axis</span><span class="o">=</span><span class="mi">0</span><span class="p">),</span>
            <span class="n">time_to_event</span><span class="o">=</span><span class="s">&quot;y&quot;</span><span class="p">,</span>
            <span class="n">event</span><span class="o">=</span><span class="s">&quot;y_d&quot;</span><span class="p">,</span>
            <span class="n">result_col</span><span class="o">=</span><span class="s">&quot;snp3&quot;</span><span class="p">,</span>
        <span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">assertEqual</span><span class="p">(</span><span class="mi">6</span><span class="p">,</span> <span class="nb">len</span><span class="p">(</span><span class="n">observed</span><span class="p">))</span>
        <span class="n">observed_coef</span><span class="p">,</span> <span class="n">observed_se</span><span class="p">,</span> <span class="n">observed_min_ci</span><span class="p">,</span> <span class="n">observed_max_ci</span><span class="p">,</span> \
            <span class="n">observed_z</span><span class="p">,</span> <span class="n">observed_p</span> <span class="o">=</span> <span class="n">observed</span>

        <span class="c"># Comparing the results (P is not that similar though...)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">assertAlmostEqual</span><span class="p">(</span><span class="n">expected_coef</span><span class="p">,</span> <span class="n">observed_coef</span><span class="p">,</span> <span class="n">places</span><span class="o">=</span><span class="mi">10</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">assertAlmostEqual</span><span class="p">(</span><span class="n">expected_se</span><span class="p">,</span> <span class="n">observed_se</span><span class="p">,</span> <span class="n">places</span><span class="o">=</span><span class="mi">7</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">assertAlmostEqual</span><span class="p">(</span><span class="n">expected_min_ci</span><span class="p">,</span> <span class="n">observed_min_ci</span><span class="p">,</span> <span class="n">places</span><span class="o">=</span><span class="mi">4</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">assertAlmostEqual</span><span class="p">(</span><span class="n">expected_max_ci</span><span class="p">,</span> <span class="n">observed_max_ci</span><span class="p">,</span> <span class="n">places</span><span class="o">=</span><span class="mi">4</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">assertAlmostEqual</span><span class="p">(</span><span class="n">expected_z</span><span class="p">,</span> <span class="n">observed_z</span><span class="p">,</span> <span class="n">places</span><span class="o">=</span><span class="mi">5</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">assertAlmostEqual</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">log10</span><span class="p">(</span><span class="n">expected_p</span><span class="p">),</span> <span class="n">np</span><span class="o">.</span><span class="n">log10</span><span class="p">(</span><span class="n">observed_p</span><span class="p">),</span>
                               <span class="n">places</span><span class="o">=</span><span class="mi">4</span><span class="p">)</span>

    <span class="k">def</span> <span class="nf">test_fit_cox_interaction</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span></div>
<div class="viewcode-block" id="TestImputedStatsCox.test_fit_cox_interaction"><a class="viewcode-back" href="../../../module_content/gwip.tests.html#gwip.tests.test_imputed_stats.TestImputedStatsCox.test_fit_cox_interaction">[docs]</a>        <span class="sd">&quot;&quot;&quot;Tests the &#39;fit_cox&#39; function with interaction.&quot;&quot;&quot;</span>
        <span class="c"># Reading the data</span>
        <span class="n">data_filename</span> <span class="o">=</span> <span class="n">resource_filename</span><span class="p">(</span>
            <span class="n">__name__</span><span class="p">,</span>
            <span class="s">&quot;data/regression_sim_inter.txt.bz2&quot;</span><span class="p">,</span>
        <span class="p">)</span>

        <span class="c"># This dataset contains 3 markers + 5 covariables</span>
        <span class="n">data</span> <span class="o">=</span> <span class="n">pd</span><span class="o">.</span><span class="n">read_csv</span><span class="p">(</span><span class="n">data_filename</span><span class="p">,</span> <span class="n">sep</span><span class="o">=</span><span class="s">&quot;</span><span class="se">\t</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">compression</span><span class="o">=</span><span class="s">&quot;bz2&quot;</span><span class="p">)</span>

        <span class="c"># Computing the interaction</span>
        <span class="n">data</span><span class="p">[</span><span class="s">&quot;interaction&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="n">data</span><span class="o">.</span><span class="n">snp1</span> <span class="o">*</span> <span class="n">data</span><span class="o">.</span><span class="n">gender</span>
        <span class="n">columns_to_keep</span> <span class="o">=</span> <span class="p">[</span><span class="s">&quot;y&quot;</span><span class="p">,</span> <span class="s">&quot;y_d&quot;</span><span class="p">,</span> <span class="s">&quot;snp1&quot;</span><span class="p">,</span> <span class="s">&quot;C1&quot;</span><span class="p">,</span> <span class="s">&quot;C2&quot;</span><span class="p">,</span> <span class="s">&quot;C3&quot;</span><span class="p">,</span> <span class="s">&quot;age&quot;</span><span class="p">,</span>
                           <span class="s">&quot;gender&quot;</span><span class="p">,</span> <span class="s">&quot;interaction&quot;</span><span class="p">]</span>

        <span class="c"># The expected results for the first marker (according to R)</span>
        <span class="n">expected_coef</span> <span class="o">=</span> <span class="o">-</span><span class="mf">0.6446297920053343233</span>
        <span class="n">expected_se</span> <span class="o">=</span> <span class="mf">0.1430770156758568168</span>
        <span class="n">expected_min_ci</span> <span class="o">=</span> <span class="o">-</span><span class="mf">0.925055589745486406</span>
        <span class="n">expected_max_ci</span> <span class="o">=</span> <span class="o">-</span><span class="mf">0.364203994265182296</span>
        <span class="n">expected_z</span> <span class="o">=</span> <span class="o">-</span><span class="mf">4.5054741249688419202</span>
        <span class="n">expected_p</span> <span class="o">=</span> <span class="mf">6.62249088800859198e-06</span>

        <span class="c"># The observed results</span>
        <span class="n">observed</span> <span class="o">=</span> <span class="n">fit_cox</span><span class="p">(</span>
            <span class="n">data</span><span class="o">=</span><span class="n">data</span><span class="p">[</span><span class="n">columns_to_keep</span><span class="p">]</span><span class="o">.</span><span class="n">dropna</span><span class="p">(</span><span class="n">axis</span><span class="o">=</span><span class="mi">0</span><span class="p">),</span>
            <span class="n">time_to_event</span><span class="o">=</span><span class="s">&quot;y&quot;</span><span class="p">,</span>
            <span class="n">event</span><span class="o">=</span><span class="s">&quot;y_d&quot;</span><span class="p">,</span>
            <span class="n">result_col</span><span class="o">=</span><span class="s">&quot;interaction&quot;</span><span class="p">,</span>
        <span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">assertEqual</span><span class="p">(</span><span class="mi">6</span><span class="p">,</span> <span class="nb">len</span><span class="p">(</span><span class="n">observed</span><span class="p">))</span>
        <span class="n">observed_coef</span><span class="p">,</span> <span class="n">observed_se</span><span class="p">,</span> <span class="n">observed_min_ci</span><span class="p">,</span> <span class="n">observed_max_ci</span><span class="p">,</span> \
            <span class="n">observed_z</span><span class="p">,</span> <span class="n">observed_p</span> <span class="o">=</span> <span class="n">observed</span>

        <span class="c"># Comparing the results</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">assertAlmostEqual</span><span class="p">(</span><span class="n">expected_coef</span><span class="p">,</span> <span class="n">observed_coef</span><span class="p">,</span> <span class="n">places</span><span class="o">=</span><span class="mi">10</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">assertAlmostEqual</span><span class="p">(</span><span class="n">expected_se</span><span class="p">,</span> <span class="n">observed_se</span><span class="p">,</span> <span class="n">places</span><span class="o">=</span><span class="mi">7</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">assertAlmostEqual</span><span class="p">(</span><span class="n">expected_min_ci</span><span class="p">,</span> <span class="n">observed_min_ci</span><span class="p">,</span> <span class="n">places</span><span class="o">=</span><span class="mi">3</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">assertAlmostEqual</span><span class="p">(</span><span class="n">expected_max_ci</span><span class="p">,</span> <span class="n">observed_max_ci</span><span class="p">,</span> <span class="n">places</span><span class="o">=</span><span class="mi">3</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">assertAlmostEqual</span><span class="p">(</span><span class="n">expected_z</span><span class="p">,</span> <span class="n">observed_z</span><span class="p">,</span> <span class="n">places</span><span class="o">=</span><span class="mi">5</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">assertAlmostEqual</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">log10</span><span class="p">(</span><span class="n">expected_p</span><span class="p">),</span> <span class="n">np</span><span class="o">.</span><span class="n">log10</span><span class="p">(</span><span class="n">observed_p</span><span class="p">),</span>
                               <span class="n">places</span><span class="o">=</span><span class="mi">5</span><span class="p">)</span>

    <span class="k">def</span> <span class="nf">test_full_fit_cox</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span></div>
<div class="viewcode-block" id="TestImputedStatsCox.test_full_fit_cox"><a class="viewcode-back" href="../../../module_content/gwip.tests.html#gwip.tests.test_imputed_stats.TestImputedStatsCox.test_full_fit_cox">[docs]</a>        <span class="sd">&quot;&quot;&quot;Tests the full pipeline for Cox&#39;s regression.&quot;&quot;&quot;</span>
        <span class="c"># Reading the data</span>
        <span class="n">data_filename</span> <span class="o">=</span> <span class="n">resource_filename</span><span class="p">(</span>
            <span class="n">__name__</span><span class="p">,</span>
            <span class="s">&quot;data/regression_sim.txt.bz2&quot;</span><span class="p">,</span>
        <span class="p">)</span>

        <span class="c"># Creating the input files</span>
        <span class="n">o_prefix</span><span class="p">,</span> <span class="n">options</span> <span class="o">=</span> <span class="n">create_input_files</span><span class="p">(</span>
            <span class="n">i_filename</span><span class="o">=</span><span class="n">data_filename</span><span class="p">,</span>
            <span class="n">output_dirname</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">output_dir</span><span class="o">.</span><span class="n">name</span><span class="p">,</span>
            <span class="n">analysis_type</span><span class="o">=</span><span class="s">&quot;cox&quot;</span><span class="p">,</span>
            <span class="n">tte</span><span class="o">=</span><span class="s">&quot;y&quot;</span><span class="p">,</span>
            <span class="n">event</span><span class="o">=</span><span class="s">&quot;y_d&quot;</span><span class="p">,</span>
        <span class="p">)</span>

        <span class="c"># Executing the tool</span>
        <span class="n">main</span><span class="p">(</span><span class="n">args</span><span class="o">=</span><span class="n">options</span><span class="p">)</span>

        <span class="c"># Cleaning the handlers</span>
        <span class="n">clean_logging_handlers</span><span class="p">()</span>

        <span class="c"># Making sure the output file exists</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">assertTrue</span><span class="p">(</span><span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">isfile</span><span class="p">(</span><span class="n">o_prefix</span> <span class="o">+</span> <span class="s">&quot;.cox.dosage&quot;</span><span class="p">))</span>

        <span class="c"># Reading the data</span>
        <span class="n">observed</span> <span class="o">=</span> <span class="n">pd</span><span class="o">.</span><span class="n">read_csv</span><span class="p">(</span><span class="n">o_prefix</span> <span class="o">+</span> <span class="s">&quot;.cox.dosage&quot;</span><span class="p">,</span> <span class="n">sep</span><span class="o">=</span><span class="s">&quot;</span><span class="se">\t</span><span class="s">&quot;</span><span class="p">)</span>

        <span class="c"># Checking all columns are present</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">assertEqual</span><span class="p">([</span><span class="s">&quot;chr&quot;</span><span class="p">,</span> <span class="s">&quot;pos&quot;</span><span class="p">,</span> <span class="s">&quot;snp&quot;</span><span class="p">,</span> <span class="s">&quot;major&quot;</span><span class="p">,</span> <span class="s">&quot;minor&quot;</span><span class="p">,</span> <span class="s">&quot;maf&quot;</span><span class="p">,</span> <span class="s">&quot;n&quot;</span><span class="p">,</span>
                          <span class="s">&quot;coef&quot;</span><span class="p">,</span> <span class="s">&quot;se&quot;</span><span class="p">,</span> <span class="s">&quot;lower&quot;</span><span class="p">,</span> <span class="s">&quot;upper&quot;</span><span class="p">,</span> <span class="s">&quot;z&quot;</span><span class="p">,</span> <span class="s">&quot;p&quot;</span><span class="p">],</span>
                         <span class="nb">list</span><span class="p">(</span><span class="n">observed</span><span class="o">.</span><span class="n">columns</span><span class="p">))</span>

        <span class="c"># Chromosomes</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">assertEqual</span><span class="p">([</span><span class="mi">22</span><span class="p">],</span> <span class="n">observed</span><span class="o">.</span><span class="n">chr</span><span class="o">.</span><span class="n">unique</span><span class="p">())</span>

        <span class="c"># Positions</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">assertEqual</span><span class="p">([</span><span class="mi">1</span><span class="p">,</span> <span class="mi">2</span><span class="p">,</span> <span class="mi">3</span><span class="p">],</span> <span class="nb">list</span><span class="p">(</span><span class="n">observed</span><span class="o">.</span><span class="n">pos</span><span class="p">))</span>

        <span class="c"># Marker names</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">assertEqual</span><span class="p">([</span><span class="s">&quot;marker_1&quot;</span><span class="p">,</span> <span class="s">&quot;marker_2&quot;</span><span class="p">,</span> <span class="s">&quot;marker_3&quot;</span><span class="p">],</span>
                         <span class="nb">list</span><span class="p">(</span><span class="n">observed</span><span class="o">.</span><span class="n">snp</span><span class="p">))</span>

        <span class="c"># Major alleles</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">assertEqual</span><span class="p">([</span><span class="s">&quot;T&quot;</span><span class="p">,</span> <span class="s">&quot;G&quot;</span><span class="p">,</span> <span class="s">&quot;AT&quot;</span><span class="p">],</span> <span class="nb">list</span><span class="p">(</span><span class="n">observed</span><span class="o">.</span><span class="n">major</span><span class="p">))</span>

        <span class="c"># Minor alleles</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">assertEqual</span><span class="p">([</span><span class="s">&quot;C&quot;</span><span class="p">,</span> <span class="s">&quot;A&quot;</span><span class="p">,</span> <span class="s">&quot;A&quot;</span><span class="p">],</span> <span class="nb">list</span><span class="p">(</span><span class="n">observed</span><span class="o">.</span><span class="n">minor</span><span class="p">))</span>

        <span class="c"># Minor allele frequency</span>
        <span class="n">expected</span> <span class="o">=</span> <span class="p">[</span><span class="mi">1724</span> <span class="o">/</span> <span class="mi">11526</span><span class="p">,</span> <span class="mi">4604</span> <span class="o">/</span> <span class="mi">11526</span><span class="p">,</span> <span class="mi">1379</span> <span class="o">/</span> <span class="mi">11526</span><span class="p">]</span>
        <span class="k">for</span> <span class="n">expected_maf</span><span class="p">,</span> <span class="n">observed_maf</span> <span class="ow">in</span> <span class="nb">zip</span><span class="p">(</span><span class="n">expected</span><span class="p">,</span> <span class="n">observed</span><span class="o">.</span><span class="n">maf</span><span class="p">):</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">assertAlmostEqual</span><span class="p">(</span><span class="n">expected_maf</span><span class="p">,</span> <span class="n">observed_maf</span><span class="p">,</span> <span class="n">places</span><span class="o">=</span><span class="mi">10</span><span class="p">)</span>

        <span class="c"># The number of samples</span>
        <span class="n">expected</span> <span class="o">=</span> <span class="p">[</span><span class="mi">5763</span><span class="p">,</span> <span class="mi">5763</span><span class="p">,</span> <span class="mi">5763</span><span class="p">]</span>
        <span class="k">for</span> <span class="n">expected_n</span><span class="p">,</span> <span class="n">observed_n</span> <span class="ow">in</span> <span class="nb">zip</span><span class="p">(</span><span class="n">expected</span><span class="p">,</span> <span class="n">observed</span><span class="o">.</span><span class="n">n</span><span class="p">):</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">assertEqual</span><span class="p">(</span><span class="n">expected_n</span><span class="p">,</span> <span class="n">observed_n</span><span class="p">)</span>

        <span class="c"># The coefficients</span>
        <span class="n">expected</span> <span class="o">=</span> <span class="p">[</span><span class="o">-</span><span class="mf">0.9892699611323815256</span><span class="p">,</span> <span class="mf">0.0499084338021939383</span><span class="p">,</span>
                    <span class="mf">1.114732193640146418</span><span class="p">]</span>
        <span class="k">for</span> <span class="n">expected_coef</span><span class="p">,</span> <span class="n">observed_coef</span> <span class="ow">in</span> <span class="nb">zip</span><span class="p">(</span><span class="n">expected</span><span class="p">,</span> <span class="n">observed</span><span class="o">.</span><span class="n">coef</span><span class="p">):</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">assertAlmostEqual</span><span class="p">(</span><span class="n">expected_coef</span><span class="p">,</span> <span class="n">observed_coef</span><span class="p">,</span> <span class="n">places</span><span class="o">=</span><span class="mi">10</span><span class="p">)</span>

        <span class="c"># The standard error</span>
        <span class="n">expected</span> <span class="o">=</span> <span class="p">[</span><span class="mf">0.0645633075569013448</span><span class="p">,</span> <span class="mf">0.0401904025600694215</span><span class="p">,</span>
                    <span class="mf">0.0631205046371715733</span><span class="p">]</span>
        <span class="n">places</span> <span class="o">=</span> <span class="p">[</span><span class="mi">6</span><span class="p">,</span> <span class="mi">9</span><span class="p">,</span> <span class="mi">7</span><span class="p">]</span>
        <span class="n">zipped</span> <span class="o">=</span> <span class="nb">zip</span><span class="p">(</span><span class="n">expected</span><span class="p">,</span> <span class="n">observed</span><span class="o">.</span><span class="n">se</span><span class="p">,</span> <span class="n">places</span><span class="p">)</span>
        <span class="k">for</span> <span class="n">expected_se</span><span class="p">,</span> <span class="n">observed_se</span><span class="p">,</span> <span class="n">place</span> <span class="ow">in</span> <span class="n">zipped</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">assertAlmostEqual</span><span class="p">(</span><span class="n">expected_se</span><span class="p">,</span> <span class="n">observed_se</span><span class="p">,</span> <span class="n">places</span><span class="o">=</span><span class="n">place</span><span class="p">)</span>

        <span class="c"># The lower CI</span>
        <span class="n">expected</span> <span class="o">=</span> <span class="p">[</span><span class="o">-</span><span class="mf">1.11581171866669093</span><span class="p">,</span> <span class="o">-</span><span class="mf">0.0288633077397084936</span><span class="p">,</span>
                    <span class="mf">0.991018277865296726</span><span class="p">]</span>
        <span class="n">places</span> <span class="o">=</span> <span class="p">[</span><span class="mi">4</span><span class="p">,</span> <span class="mi">4</span><span class="p">,</span> <span class="mi">4</span><span class="p">]</span>
        <span class="n">zipped</span> <span class="o">=</span> <span class="nb">zip</span><span class="p">(</span><span class="n">expected</span><span class="p">,</span> <span class="n">observed</span><span class="o">.</span><span class="n">lower</span><span class="p">,</span> <span class="n">places</span><span class="p">)</span>
        <span class="k">for</span> <span class="n">expected_min_ci</span><span class="p">,</span> <span class="n">observed_min_ci</span><span class="p">,</span> <span class="n">place</span> <span class="ow">in</span> <span class="n">zipped</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">assertAlmostEqual</span><span class="p">(</span><span class="n">expected_min_ci</span><span class="p">,</span> <span class="n">observed_min_ci</span><span class="p">,</span>
                                   <span class="n">places</span><span class="o">=</span><span class="n">place</span><span class="p">)</span>

        <span class="c"># The upper CI</span>
        <span class="n">expected</span> <span class="o">=</span> <span class="p">[</span><span class="o">-</span><span class="mf">0.86272820359807223</span><span class="p">,</span> <span class="mf">0.12868017534409637</span><span class="p">,</span>
                    <span class="mf">1.23844610941499611</span><span class="p">]</span>
        <span class="n">places</span> <span class="o">=</span> <span class="p">[</span><span class="mi">4</span><span class="p">,</span> <span class="mi">4</span><span class="p">,</span> <span class="mi">4</span><span class="p">]</span>
        <span class="n">zipped</span> <span class="o">=</span> <span class="nb">zip</span><span class="p">(</span><span class="n">expected</span><span class="p">,</span> <span class="n">observed</span><span class="o">.</span><span class="n">upper</span><span class="p">,</span> <span class="n">places</span><span class="p">)</span>
        <span class="k">for</span> <span class="n">expected_max_ci</span><span class="p">,</span> <span class="n">observed_max_ci</span><span class="p">,</span> <span class="n">place</span> <span class="ow">in</span> <span class="n">zipped</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">assertAlmostEqual</span><span class="p">(</span><span class="n">expected_max_ci</span><span class="p">,</span> <span class="n">observed_max_ci</span><span class="p">,</span>
                                   <span class="n">places</span><span class="o">=</span><span class="n">place</span><span class="p">)</span>

        <span class="c"># The Z statistics</span>
        <span class="n">expected</span> <span class="o">=</span> <span class="p">[</span><span class="o">-</span><span class="mf">15.32247957186071652</span><span class="p">,</span> <span class="mf">1.241799798536472599</span><span class="p">,</span>
                    <span class="mf">17.660381520202268035</span><span class="p">]</span>
        <span class="n">places</span> <span class="o">=</span> <span class="p">[</span><span class="mi">4</span><span class="p">,</span> <span class="mi">8</span><span class="p">,</span> <span class="mi">5</span><span class="p">]</span>
        <span class="n">zipped</span> <span class="o">=</span> <span class="nb">zip</span><span class="p">(</span><span class="n">expected</span><span class="p">,</span> <span class="n">observed</span><span class="o">.</span><span class="n">z</span><span class="p">,</span> <span class="n">places</span><span class="p">)</span>
        <span class="k">for</span> <span class="n">expected_z</span><span class="p">,</span> <span class="n">observed_z</span><span class="p">,</span> <span class="n">place</span> <span class="ow">in</span> <span class="n">zipped</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">assertAlmostEqual</span><span class="p">(</span><span class="n">expected_z</span><span class="p">,</span> <span class="n">observed_z</span><span class="p">,</span> <span class="n">places</span><span class="o">=</span><span class="n">place</span><span class="p">)</span>

        <span class="c"># The p values</span>
        <span class="n">expected</span> <span class="o">=</span> <span class="p">[</span><span class="mf">5.41131727236088009e-53</span><span class="p">,</span> <span class="mf">0.21431043709814412423</span><span class="p">,</span>
                    <span class="mf">8.46654634146707403e-70</span><span class="p">]</span>
        <span class="n">places</span> <span class="o">=</span> <span class="p">[</span><span class="mi">3</span><span class="p">,</span> <span class="mi">8</span><span class="p">,</span> <span class="mi">4</span><span class="p">]</span>
        <span class="n">zipped</span> <span class="o">=</span> <span class="nb">zip</span><span class="p">(</span><span class="n">expected</span><span class="p">,</span> <span class="n">observed</span><span class="o">.</span><span class="n">p</span><span class="p">,</span> <span class="n">places</span><span class="p">)</span>
        <span class="k">for</span> <span class="n">expected_p</span><span class="p">,</span> <span class="n">observed_p</span><span class="p">,</span> <span class="n">place</span> <span class="ow">in</span> <span class="n">zipped</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">assertAlmostEqual</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">log10</span><span class="p">(</span><span class="n">expected_p</span><span class="p">),</span> <span class="n">np</span><span class="o">.</span><span class="n">log10</span><span class="p">(</span><span class="n">observed_p</span><span class="p">),</span>
                                   <span class="n">places</span><span class="o">=</span><span class="n">place</span><span class="p">)</span>

    <span class="nd">@unittest.skipIf</span><span class="p">(</span><span class="n">platform</span><span class="o">.</span><span class="n">system</span><span class="p">()</span> <span class="o">==</span> <span class="s">&quot;Darwin&quot;</span><span class="p">,</span></div>
                     <span class="s">&quot;multiprocessing not supported with Mac OS&quot;</span><span class="p">)</span>
    <span class="k">def</span> <span class="nf">test_full_fit_cox_multiprocess</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
<div class="viewcode-block" id="TestImputedStatsCox.test_full_fit_cox_multiprocess"><a class="viewcode-back" href="../../../module_content/gwip.tests.html#gwip.tests.test_imputed_stats.TestImputedStatsCox.test_full_fit_cox_multiprocess">[docs]</a>        <span class="sd">&quot;&quot;&quot;Tests the full pipeline for Cox&#39;s regression with &gt;1 processes.&quot;&quot;&quot;</span>
        <span class="c"># Reading the data</span>
        <span class="n">data_filename</span> <span class="o">=</span> <span class="n">resource_filename</span><span class="p">(</span>
            <span class="n">__name__</span><span class="p">,</span>
            <span class="s">&quot;data/regression_sim.txt.bz2&quot;</span><span class="p">,</span>
        <span class="p">)</span>

        <span class="c"># Creating the input files</span>
        <span class="n">o_prefix</span><span class="p">,</span> <span class="n">options</span> <span class="o">=</span> <span class="n">create_input_files</span><span class="p">(</span>
            <span class="n">i_filename</span><span class="o">=</span><span class="n">data_filename</span><span class="p">,</span>
            <span class="n">output_dirname</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">output_dir</span><span class="o">.</span><span class="n">name</span><span class="p">,</span>
            <span class="n">analysis_type</span><span class="o">=</span><span class="s">&quot;cox&quot;</span><span class="p">,</span>
            <span class="n">tte</span><span class="o">=</span><span class="s">&quot;y&quot;</span><span class="p">,</span>
            <span class="n">event</span><span class="o">=</span><span class="s">&quot;y_d&quot;</span><span class="p">,</span>
            <span class="n">nb_process</span><span class="o">=</span><span class="mi">2</span><span class="p">,</span>
        <span class="p">)</span>

        <span class="c"># Executing the tool</span>
        <span class="n">main</span><span class="p">(</span><span class="n">args</span><span class="o">=</span><span class="n">options</span><span class="p">)</span>

        <span class="c"># Cleaning the handlers</span>
        <span class="n">clean_logging_handlers</span><span class="p">()</span>

        <span class="c"># Making sure the output file exists</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">assertTrue</span><span class="p">(</span><span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">isfile</span><span class="p">(</span><span class="n">o_prefix</span> <span class="o">+</span> <span class="s">&quot;.cox.dosage&quot;</span><span class="p">))</span>

        <span class="c"># Reading the data</span>
        <span class="n">observed</span> <span class="o">=</span> <span class="n">pd</span><span class="o">.</span><span class="n">read_csv</span><span class="p">(</span><span class="n">o_prefix</span> <span class="o">+</span> <span class="s">&quot;.cox.dosage&quot;</span><span class="p">,</span> <span class="n">sep</span><span class="o">=</span><span class="s">&quot;</span><span class="se">\t</span><span class="s">&quot;</span><span class="p">)</span>

        <span class="c"># Checking all columns are present</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">assertEqual</span><span class="p">([</span><span class="s">&quot;chr&quot;</span><span class="p">,</span> <span class="s">&quot;pos&quot;</span><span class="p">,</span> <span class="s">&quot;snp&quot;</span><span class="p">,</span> <span class="s">&quot;major&quot;</span><span class="p">,</span> <span class="s">&quot;minor&quot;</span><span class="p">,</span> <span class="s">&quot;maf&quot;</span><span class="p">,</span> <span class="s">&quot;n&quot;</span><span class="p">,</span>
                          <span class="s">&quot;coef&quot;</span><span class="p">,</span> <span class="s">&quot;se&quot;</span><span class="p">,</span> <span class="s">&quot;lower&quot;</span><span class="p">,</span> <span class="s">&quot;upper&quot;</span><span class="p">,</span> <span class="s">&quot;z&quot;</span><span class="p">,</span> <span class="s">&quot;p&quot;</span><span class="p">],</span>
                         <span class="nb">list</span><span class="p">(</span><span class="n">observed</span><span class="o">.</span><span class="n">columns</span><span class="p">))</span>

        <span class="c"># Chromosomes</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">assertEqual</span><span class="p">([</span><span class="mi">22</span><span class="p">],</span> <span class="n">observed</span><span class="o">.</span><span class="n">chr</span><span class="o">.</span><span class="n">unique</span><span class="p">())</span>

        <span class="c"># Positions</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">assertEqual</span><span class="p">([</span><span class="mi">1</span><span class="p">,</span> <span class="mi">2</span><span class="p">,</span> <span class="mi">3</span><span class="p">],</span> <span class="nb">list</span><span class="p">(</span><span class="n">observed</span><span class="o">.</span><span class="n">pos</span><span class="p">))</span>

        <span class="c"># Marker names</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">assertEqual</span><span class="p">([</span><span class="s">&quot;marker_1&quot;</span><span class="p">,</span> <span class="s">&quot;marker_2&quot;</span><span class="p">,</span> <span class="s">&quot;marker_3&quot;</span><span class="p">],</span>
                         <span class="nb">list</span><span class="p">(</span><span class="n">observed</span><span class="o">.</span><span class="n">snp</span><span class="p">))</span>

        <span class="c"># Major alleles</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">assertEqual</span><span class="p">([</span><span class="s">&quot;T&quot;</span><span class="p">,</span> <span class="s">&quot;G&quot;</span><span class="p">,</span> <span class="s">&quot;AT&quot;</span><span class="p">],</span> <span class="nb">list</span><span class="p">(</span><span class="n">observed</span><span class="o">.</span><span class="n">major</span><span class="p">))</span>

        <span class="c"># Minor alleles</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">assertEqual</span><span class="p">([</span><span class="s">&quot;C&quot;</span><span class="p">,</span> <span class="s">&quot;A&quot;</span><span class="p">,</span> <span class="s">&quot;A&quot;</span><span class="p">],</span> <span class="nb">list</span><span class="p">(</span><span class="n">observed</span><span class="o">.</span><span class="n">minor</span><span class="p">))</span>

        <span class="c"># Minor allele frequency</span>
        <span class="n">expected</span> <span class="o">=</span> <span class="p">[</span><span class="mi">1724</span> <span class="o">/</span> <span class="mi">11526</span><span class="p">,</span> <span class="mi">4604</span> <span class="o">/</span> <span class="mi">11526</span><span class="p">,</span> <span class="mi">1379</span> <span class="o">/</span> <span class="mi">11526</span><span class="p">]</span>
        <span class="k">for</span> <span class="n">expected_maf</span><span class="p">,</span> <span class="n">observed_maf</span> <span class="ow">in</span> <span class="nb">zip</span><span class="p">(</span><span class="n">expected</span><span class="p">,</span> <span class="n">observed</span><span class="o">.</span><span class="n">maf</span><span class="p">):</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">assertAlmostEqual</span><span class="p">(</span><span class="n">expected_maf</span><span class="p">,</span> <span class="n">observed_maf</span><span class="p">,</span> <span class="n">places</span><span class="o">=</span><span class="mi">10</span><span class="p">)</span>

        <span class="c"># The number of samples</span>
        <span class="n">expected</span> <span class="o">=</span> <span class="p">[</span><span class="mi">5763</span><span class="p">,</span> <span class="mi">5763</span><span class="p">,</span> <span class="mi">5763</span><span class="p">]</span>
        <span class="k">for</span> <span class="n">expected_n</span><span class="p">,</span> <span class="n">observed_n</span> <span class="ow">in</span> <span class="nb">zip</span><span class="p">(</span><span class="n">expected</span><span class="p">,</span> <span class="n">observed</span><span class="o">.</span><span class="n">n</span><span class="p">):</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">assertEqual</span><span class="p">(</span><span class="n">expected_n</span><span class="p">,</span> <span class="n">observed_n</span><span class="p">)</span>

        <span class="c"># The coefficients</span>
        <span class="n">expected</span> <span class="o">=</span> <span class="p">[</span><span class="o">-</span><span class="mf">0.9892699611323815256</span><span class="p">,</span> <span class="mf">0.0499084338021939383</span><span class="p">,</span>
                    <span class="mf">1.114732193640146418</span><span class="p">]</span>
        <span class="k">for</span> <span class="n">expected_coef</span><span class="p">,</span> <span class="n">observed_coef</span> <span class="ow">in</span> <span class="nb">zip</span><span class="p">(</span><span class="n">expected</span><span class="p">,</span> <span class="n">observed</span><span class="o">.</span><span class="n">coef</span><span class="p">):</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">assertAlmostEqual</span><span class="p">(</span><span class="n">expected_coef</span><span class="p">,</span> <span class="n">observed_coef</span><span class="p">,</span> <span class="n">places</span><span class="o">=</span><span class="mi">10</span><span class="p">)</span>

        <span class="c"># The standard error</span>
        <span class="n">expected</span> <span class="o">=</span> <span class="p">[</span><span class="mf">0.0645633075569013448</span><span class="p">,</span> <span class="mf">0.0401904025600694215</span><span class="p">,</span>
                    <span class="mf">0.0631205046371715733</span><span class="p">]</span>
        <span class="n">places</span> <span class="o">=</span> <span class="p">[</span><span class="mi">6</span><span class="p">,</span> <span class="mi">9</span><span class="p">,</span> <span class="mi">7</span><span class="p">]</span>
        <span class="n">zipped</span> <span class="o">=</span> <span class="nb">zip</span><span class="p">(</span><span class="n">expected</span><span class="p">,</span> <span class="n">observed</span><span class="o">.</span><span class="n">se</span><span class="p">,</span> <span class="n">places</span><span class="p">)</span>
        <span class="k">for</span> <span class="n">expected_se</span><span class="p">,</span> <span class="n">observed_se</span><span class="p">,</span> <span class="n">place</span> <span class="ow">in</span> <span class="n">zipped</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">assertAlmostEqual</span><span class="p">(</span><span class="n">expected_se</span><span class="p">,</span> <span class="n">observed_se</span><span class="p">,</span> <span class="n">places</span><span class="o">=</span><span class="n">place</span><span class="p">)</span>

        <span class="c"># The lower CI</span>
        <span class="n">expected</span> <span class="o">=</span> <span class="p">[</span><span class="o">-</span><span class="mf">1.11581171866669093</span><span class="p">,</span> <span class="o">-</span><span class="mf">0.0288633077397084936</span><span class="p">,</span>
                    <span class="mf">0.991018277865296726</span><span class="p">]</span>
        <span class="n">places</span> <span class="o">=</span> <span class="p">[</span><span class="mi">4</span><span class="p">,</span> <span class="mi">4</span><span class="p">,</span> <span class="mi">4</span><span class="p">]</span>
        <span class="n">zipped</span> <span class="o">=</span> <span class="nb">zip</span><span class="p">(</span><span class="n">expected</span><span class="p">,</span> <span class="n">observed</span><span class="o">.</span><span class="n">lower</span><span class="p">,</span> <span class="n">places</span><span class="p">)</span>
        <span class="k">for</span> <span class="n">expected_min_ci</span><span class="p">,</span> <span class="n">observed_min_ci</span><span class="p">,</span> <span class="n">place</span> <span class="ow">in</span> <span class="n">zipped</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">assertAlmostEqual</span><span class="p">(</span><span class="n">expected_min_ci</span><span class="p">,</span> <span class="n">observed_min_ci</span><span class="p">,</span>
                                   <span class="n">places</span><span class="o">=</span><span class="n">place</span><span class="p">)</span>

        <span class="c"># The upper CI</span>
        <span class="n">expected</span> <span class="o">=</span> <span class="p">[</span><span class="o">-</span><span class="mf">0.86272820359807223</span><span class="p">,</span> <span class="mf">0.12868017534409637</span><span class="p">,</span>
                    <span class="mf">1.23844610941499611</span><span class="p">]</span>
        <span class="n">places</span> <span class="o">=</span> <span class="p">[</span><span class="mi">4</span><span class="p">,</span> <span class="mi">4</span><span class="p">,</span> <span class="mi">4</span><span class="p">]</span>
        <span class="n">zipped</span> <span class="o">=</span> <span class="nb">zip</span><span class="p">(</span><span class="n">expected</span><span class="p">,</span> <span class="n">observed</span><span class="o">.</span><span class="n">upper</span><span class="p">,</span> <span class="n">places</span><span class="p">)</span>
        <span class="k">for</span> <span class="n">expected_max_ci</span><span class="p">,</span> <span class="n">observed_max_ci</span><span class="p">,</span> <span class="n">place</span> <span class="ow">in</span> <span class="n">zipped</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">assertAlmostEqual</span><span class="p">(</span><span class="n">expected_max_ci</span><span class="p">,</span> <span class="n">observed_max_ci</span><span class="p">,</span>
                                   <span class="n">places</span><span class="o">=</span><span class="n">place</span><span class="p">)</span>

        <span class="c"># The Z statistics</span>
        <span class="n">expected</span> <span class="o">=</span> <span class="p">[</span><span class="o">-</span><span class="mf">15.32247957186071652</span><span class="p">,</span> <span class="mf">1.241799798536472599</span><span class="p">,</span>
                    <span class="mf">17.660381520202268035</span><span class="p">]</span>
        <span class="n">places</span> <span class="o">=</span> <span class="p">[</span><span class="mi">4</span><span class="p">,</span> <span class="mi">8</span><span class="p">,</span> <span class="mi">5</span><span class="p">]</span>
        <span class="n">zipped</span> <span class="o">=</span> <span class="nb">zip</span><span class="p">(</span><span class="n">expected</span><span class="p">,</span> <span class="n">observed</span><span class="o">.</span><span class="n">z</span><span class="p">,</span> <span class="n">places</span><span class="p">)</span>
        <span class="k">for</span> <span class="n">expected_z</span><span class="p">,</span> <span class="n">observed_z</span><span class="p">,</span> <span class="n">place</span> <span class="ow">in</span> <span class="n">zipped</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">assertAlmostEqual</span><span class="p">(</span><span class="n">expected_z</span><span class="p">,</span> <span class="n">observed_z</span><span class="p">,</span> <span class="n">places</span><span class="o">=</span><span class="n">place</span><span class="p">)</span>

        <span class="c"># The p values</span>
        <span class="n">expected</span> <span class="o">=</span> <span class="p">[</span><span class="mf">5.41131727236088009e-53</span><span class="p">,</span> <span class="mf">0.21431043709814412423</span><span class="p">,</span>
                    <span class="mf">8.46654634146707403e-70</span><span class="p">]</span>
        <span class="n">places</span> <span class="o">=</span> <span class="p">[</span><span class="mi">3</span><span class="p">,</span> <span class="mi">8</span><span class="p">,</span> <span class="mi">4</span><span class="p">]</span>
        <span class="n">zipped</span> <span class="o">=</span> <span class="nb">zip</span><span class="p">(</span><span class="n">expected</span><span class="p">,</span> <span class="n">observed</span><span class="o">.</span><span class="n">p</span><span class="p">,</span> <span class="n">places</span><span class="p">)</span>
        <span class="k">for</span> <span class="n">expected_p</span><span class="p">,</span> <span class="n">observed_p</span><span class="p">,</span> <span class="n">place</span> <span class="ow">in</span> <span class="n">zipped</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">assertAlmostEqual</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">log10</span><span class="p">(</span><span class="n">expected_p</span><span class="p">),</span> <span class="n">np</span><span class="o">.</span><span class="n">log10</span><span class="p">(</span><span class="n">observed_p</span><span class="p">),</span>
                                   <span class="n">places</span><span class="o">=</span><span class="n">place</span><span class="p">)</span>

    <span class="k">def</span> <span class="nf">test_full_fit_cox_interaction</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span></div>
<div class="viewcode-block" id="TestImputedStatsCox.test_full_fit_cox_interaction"><a class="viewcode-back" href="../../../module_content/gwip.tests.html#gwip.tests.test_imputed_stats.TestImputedStatsCox.test_full_fit_cox_interaction">[docs]</a>        <span class="sd">&quot;&quot;&quot;Tests the full pipeline for Cox&#39;s regression with interaction.&quot;&quot;&quot;</span>
        <span class="c"># Reading the data</span>
        <span class="n">data_filename</span> <span class="o">=</span> <span class="n">resource_filename</span><span class="p">(</span>
            <span class="n">__name__</span><span class="p">,</span>
            <span class="s">&quot;data/regression_sim_inter.txt.bz2&quot;</span><span class="p">,</span>
        <span class="p">)</span>

        <span class="c"># Creating the input files</span>
        <span class="n">o_prefix</span><span class="p">,</span> <span class="n">options</span> <span class="o">=</span> <span class="n">create_input_files</span><span class="p">(</span>
            <span class="n">i_filename</span><span class="o">=</span><span class="n">data_filename</span><span class="p">,</span>
            <span class="n">output_dirname</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">output_dir</span><span class="o">.</span><span class="n">name</span><span class="p">,</span>
            <span class="n">analysis_type</span><span class="o">=</span><span class="s">&quot;cox&quot;</span><span class="p">,</span>
            <span class="n">tte</span><span class="o">=</span><span class="s">&quot;y&quot;</span><span class="p">,</span>
            <span class="n">event</span><span class="o">=</span><span class="s">&quot;y_d&quot;</span><span class="p">,</span>
            <span class="n">interaction</span><span class="o">=</span><span class="s">&quot;gender&quot;</span><span class="p">,</span>
        <span class="p">)</span>

        <span class="c"># Executing the tool</span>
        <span class="n">main</span><span class="p">(</span><span class="n">args</span><span class="o">=</span><span class="n">options</span><span class="p">)</span>

        <span class="c"># Cleaning the handlers</span>
        <span class="n">clean_logging_handlers</span><span class="p">()</span>

        <span class="c"># Making sure the output file exists</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">assertTrue</span><span class="p">(</span><span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">isfile</span><span class="p">(</span><span class="n">o_prefix</span> <span class="o">+</span> <span class="s">&quot;.cox.dosage&quot;</span><span class="p">))</span>

        <span class="c"># Reading the data</span>
        <span class="n">observed</span> <span class="o">=</span> <span class="n">pd</span><span class="o">.</span><span class="n">read_csv</span><span class="p">(</span><span class="n">o_prefix</span> <span class="o">+</span> <span class="s">&quot;.cox.dosage&quot;</span><span class="p">,</span> <span class="n">sep</span><span class="o">=</span><span class="s">&quot;</span><span class="se">\t</span><span class="s">&quot;</span><span class="p">)</span>

        <span class="c"># Checking all columns are present</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">assertEqual</span><span class="p">([</span><span class="s">&quot;chr&quot;</span><span class="p">,</span> <span class="s">&quot;pos&quot;</span><span class="p">,</span> <span class="s">&quot;snp&quot;</span><span class="p">,</span> <span class="s">&quot;major&quot;</span><span class="p">,</span> <span class="s">&quot;minor&quot;</span><span class="p">,</span> <span class="s">&quot;maf&quot;</span><span class="p">,</span> <span class="s">&quot;n&quot;</span><span class="p">,</span>
                          <span class="s">&quot;coef&quot;</span><span class="p">,</span> <span class="s">&quot;se&quot;</span><span class="p">,</span> <span class="s">&quot;lower&quot;</span><span class="p">,</span> <span class="s">&quot;upper&quot;</span><span class="p">,</span> <span class="s">&quot;z&quot;</span><span class="p">,</span> <span class="s">&quot;p&quot;</span><span class="p">],</span>
                         <span class="nb">list</span><span class="p">(</span><span class="n">observed</span><span class="o">.</span><span class="n">columns</span><span class="p">))</span>

        <span class="c"># Chromosomes</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">assertEqual</span><span class="p">([</span><span class="mi">22</span><span class="p">],</span> <span class="n">observed</span><span class="o">.</span><span class="n">chr</span><span class="o">.</span><span class="n">unique</span><span class="p">())</span>

        <span class="c"># Positions</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">assertEqual</span><span class="p">([</span><span class="mi">1</span><span class="p">,</span> <span class="mi">2</span><span class="p">,</span> <span class="mi">3</span><span class="p">],</span> <span class="nb">list</span><span class="p">(</span><span class="n">observed</span><span class="o">.</span><span class="n">pos</span><span class="p">))</span>

        <span class="c"># Marker names</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">assertEqual</span><span class="p">([</span><span class="s">&quot;marker_1&quot;</span><span class="p">,</span> <span class="s">&quot;marker_2&quot;</span><span class="p">,</span> <span class="s">&quot;marker_3&quot;</span><span class="p">],</span>
                         <span class="nb">list</span><span class="p">(</span><span class="n">observed</span><span class="o">.</span><span class="n">snp</span><span class="p">))</span>

        <span class="c"># Major alleles</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">assertEqual</span><span class="p">([</span><span class="s">&quot;T&quot;</span><span class="p">,</span> <span class="s">&quot;G&quot;</span><span class="p">,</span> <span class="s">&quot;AT&quot;</span><span class="p">],</span> <span class="nb">list</span><span class="p">(</span><span class="n">observed</span><span class="o">.</span><span class="n">major</span><span class="p">))</span>

        <span class="c"># Minor alleles</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">assertEqual</span><span class="p">([</span><span class="s">&quot;C&quot;</span><span class="p">,</span> <span class="s">&quot;A&quot;</span><span class="p">,</span> <span class="s">&quot;A&quot;</span><span class="p">],</span> <span class="nb">list</span><span class="p">(</span><span class="n">observed</span><span class="o">.</span><span class="n">minor</span><span class="p">))</span>

        <span class="c"># Minor allele frequency</span>
        <span class="n">expected</span> <span class="o">=</span> <span class="p">[</span><span class="mi">1724</span> <span class="o">/</span> <span class="mi">11526</span><span class="p">,</span> <span class="mi">4604</span> <span class="o">/</span> <span class="mi">11526</span><span class="p">,</span> <span class="mi">1379</span> <span class="o">/</span> <span class="mi">11526</span><span class="p">]</span>
        <span class="k">for</span> <span class="n">expected_maf</span><span class="p">,</span> <span class="n">observed_maf</span> <span class="ow">in</span> <span class="nb">zip</span><span class="p">(</span><span class="n">expected</span><span class="p">,</span> <span class="n">observed</span><span class="o">.</span><span class="n">maf</span><span class="p">):</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">assertAlmostEqual</span><span class="p">(</span><span class="n">expected_maf</span><span class="p">,</span> <span class="n">observed_maf</span><span class="p">,</span> <span class="n">places</span><span class="o">=</span><span class="mi">10</span><span class="p">)</span>

        <span class="c"># The number of samples</span>
        <span class="n">expected</span> <span class="o">=</span> <span class="p">[</span><span class="mi">5763</span><span class="p">,</span> <span class="mi">5763</span><span class="p">,</span> <span class="mi">5763</span><span class="p">]</span>
        <span class="k">for</span> <span class="n">expected_n</span><span class="p">,</span> <span class="n">observed_n</span> <span class="ow">in</span> <span class="nb">zip</span><span class="p">(</span><span class="n">expected</span><span class="p">,</span> <span class="n">observed</span><span class="o">.</span><span class="n">n</span><span class="p">):</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">assertEqual</span><span class="p">(</span><span class="n">expected_n</span><span class="p">,</span> <span class="n">observed_n</span><span class="p">)</span>

        <span class="c"># The coefficients</span>
        <span class="n">expected</span> <span class="o">=</span> <span class="p">[</span><span class="o">-</span><span class="mf">0.6446297920053343233</span><span class="p">,</span> <span class="o">-</span><span class="mf">0.00626679211298179859</span><span class="p">,</span>
                    <span class="o">-</span><span class="mf">0.468685693217335109</span><span class="p">]</span>
        <span class="n">places</span> <span class="o">=</span> <span class="p">[</span><span class="mi">10</span><span class="p">,</span> <span class="mi">8</span><span class="p">,</span> <span class="mi">8</span><span class="p">]</span>
        <span class="n">zipped</span> <span class="o">=</span> <span class="nb">zip</span><span class="p">(</span><span class="n">expected</span><span class="p">,</span> <span class="n">observed</span><span class="o">.</span><span class="n">coef</span><span class="p">,</span> <span class="n">places</span><span class="p">)</span>
        <span class="k">for</span> <span class="n">expected_coef</span><span class="p">,</span> <span class="n">observed_coef</span><span class="p">,</span> <span class="n">place</span> <span class="ow">in</span> <span class="n">zipped</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">assertAlmostEqual</span><span class="p">(</span><span class="n">expected_coef</span><span class="p">,</span> <span class="n">observed_coef</span><span class="p">,</span> <span class="n">places</span><span class="o">=</span><span class="n">place</span><span class="p">)</span>

        <span class="c"># The standard error</span>
        <span class="n">expected</span> <span class="o">=</span> <span class="p">[</span><span class="mf">0.1430770156758568168</span><span class="p">,</span> <span class="mf">0.0834709381328159472</span><span class="p">,</span>
                    <span class="mf">0.1209229684191305970</span><span class="p">]</span>
        <span class="n">places</span> <span class="o">=</span> <span class="p">[</span><span class="mi">7</span><span class="p">,</span> <span class="mi">10</span><span class="p">,</span> <span class="mi">10</span><span class="p">]</span>
        <span class="n">zipped</span> <span class="o">=</span> <span class="nb">zip</span><span class="p">(</span><span class="n">expected</span><span class="p">,</span> <span class="n">observed</span><span class="o">.</span><span class="n">se</span><span class="p">,</span> <span class="n">places</span><span class="p">)</span>
        <span class="k">for</span> <span class="n">expected_se</span><span class="p">,</span> <span class="n">observed_se</span><span class="p">,</span> <span class="n">place</span> <span class="ow">in</span> <span class="n">zipped</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">assertAlmostEqual</span><span class="p">(</span><span class="n">expected_se</span><span class="p">,</span> <span class="n">observed_se</span><span class="p">,</span> <span class="n">places</span><span class="o">=</span><span class="n">place</span><span class="p">)</span>

        <span class="c"># The lower CI</span>
        <span class="n">expected</span> <span class="o">=</span> <span class="p">[</span><span class="o">-</span><span class="mf">0.925055589745486406</span><span class="p">,</span> <span class="o">-</span><span class="mf">0.16986682460907207</span><span class="p">,</span>
                    <span class="o">-</span><span class="mf">0.705690356222505422</span><span class="p">]</span>
        <span class="n">places</span> <span class="o">=</span> <span class="p">[</span><span class="mi">3</span><span class="p">,</span> <span class="mi">4</span><span class="p">,</span> <span class="mi">3</span><span class="p">]</span>
        <span class="n">zipped</span> <span class="o">=</span> <span class="nb">zip</span><span class="p">(</span><span class="n">expected</span><span class="p">,</span> <span class="n">observed</span><span class="o">.</span><span class="n">lower</span><span class="p">,</span> <span class="n">places</span><span class="p">)</span>
        <span class="k">for</span> <span class="n">expected_min_ci</span><span class="p">,</span> <span class="n">observed_min_ci</span><span class="p">,</span> <span class="n">place</span> <span class="ow">in</span> <span class="n">zipped</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">assertAlmostEqual</span><span class="p">(</span><span class="n">expected_min_ci</span><span class="p">,</span> <span class="n">observed_min_ci</span><span class="p">,</span>
                                   <span class="n">places</span><span class="o">=</span><span class="n">place</span><span class="p">)</span>

        <span class="c"># The upper CI</span>
        <span class="n">expected</span> <span class="o">=</span> <span class="p">[</span><span class="o">-</span><span class="mf">0.364203994265182296</span><span class="p">,</span> <span class="mf">0.157333240383108447</span><span class="p">,</span>
                    <span class="o">-</span><span class="mf">0.231681030212164824</span><span class="p">]</span>
        <span class="n">places</span> <span class="o">=</span> <span class="p">[</span><span class="mi">3</span><span class="p">,</span> <span class="mi">4</span><span class="p">,</span> <span class="mi">3</span><span class="p">]</span>
        <span class="n">zipped</span> <span class="o">=</span> <span class="nb">zip</span><span class="p">(</span><span class="n">expected</span><span class="p">,</span> <span class="n">observed</span><span class="o">.</span><span class="n">upper</span><span class="p">,</span> <span class="n">places</span><span class="p">)</span>
        <span class="k">for</span> <span class="n">expected_max_ci</span><span class="p">,</span> <span class="n">observed_max_ci</span><span class="p">,</span> <span class="n">place</span> <span class="ow">in</span> <span class="n">zipped</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">assertAlmostEqual</span><span class="p">(</span><span class="n">expected_max_ci</span><span class="p">,</span> <span class="n">observed_max_ci</span><span class="p">,</span>
                                   <span class="n">places</span><span class="o">=</span><span class="n">place</span><span class="p">)</span>

        <span class="c"># The Z statistics</span>
        <span class="n">expected</span> <span class="o">=</span> <span class="p">[</span><span class="o">-</span><span class="mf">4.5054741249688419202</span><span class="p">,</span> <span class="o">-</span><span class="mf">0.0750775330092768867</span><span class="p">,</span>
                    <span class="o">-</span><span class="mf">3.875902976453783122</span><span class="p">]</span>
        <span class="n">places</span> <span class="o">=</span> <span class="p">[</span><span class="mi">5</span><span class="p">,</span> <span class="mi">7</span><span class="p">,</span> <span class="mi">7</span><span class="p">]</span>
        <span class="n">zipped</span> <span class="o">=</span> <span class="nb">zip</span><span class="p">(</span><span class="n">expected</span><span class="p">,</span> <span class="n">observed</span><span class="o">.</span><span class="n">z</span><span class="p">,</span> <span class="n">places</span><span class="p">)</span>
        <span class="k">for</span> <span class="n">expected_z</span><span class="p">,</span> <span class="n">observed_z</span><span class="p">,</span> <span class="n">place</span> <span class="ow">in</span> <span class="n">zipped</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">assertAlmostEqual</span><span class="p">(</span><span class="n">expected_z</span><span class="p">,</span> <span class="n">observed_z</span><span class="p">,</span> <span class="n">places</span><span class="o">=</span><span class="n">place</span><span class="p">)</span>

        <span class="c"># The p values</span>
        <span class="n">expected</span> <span class="o">=</span> <span class="p">[</span><span class="mf">6.62249088800859198e-06</span><span class="p">,</span> <span class="mf">9.40153023426109735e-01</span><span class="p">,</span>
                    <span class="mf">1.06230010246344264e-04</span><span class="p">]</span>
        <span class="n">places</span> <span class="o">=</span> <span class="p">[</span><span class="mi">5</span><span class="p">,</span> <span class="mi">8</span><span class="p">,</span> <span class="mi">7</span><span class="p">]</span>
        <span class="n">zipped</span> <span class="o">=</span> <span class="nb">zip</span><span class="p">(</span><span class="n">expected</span><span class="p">,</span> <span class="n">observed</span><span class="o">.</span><span class="n">p</span><span class="p">,</span> <span class="n">places</span><span class="p">)</span>
        <span class="k">for</span> <span class="n">expected_p</span><span class="p">,</span> <span class="n">observed_p</span><span class="p">,</span> <span class="n">place</span> <span class="ow">in</span> <span class="n">zipped</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">assertAlmostEqual</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">log10</span><span class="p">(</span><span class="n">expected_p</span><span class="p">),</span> <span class="n">np</span><span class="o">.</span><span class="n">log10</span><span class="p">(</span><span class="n">observed_p</span><span class="p">),</span>
                                   <span class="n">places</span><span class="o">=</span><span class="n">place</span><span class="p">)</span>


<span class="nd">@unittest.skipIf</span><span class="p">(</span><span class="ow">not</span> <span class="n">HAS_STATSMODELS</span><span class="p">,</span></div></div>
                 <span class="s">&quot;optional requirement (statsmodels) not satisfied&quot;</span><span class="p">)</span>
<span class="k">class</span> <span class="nc">TestImputedStatsLinear</span><span class="p">(</span><span class="n">unittest</span><span class="o">.</span><span class="n">TestCase</span><span class="p">):</span>
<div class="viewcode-block" id="TestImputedStatsLinear"><a class="viewcode-back" href="../../../module_content/gwip.tests.html#gwip.tests.test_imputed_stats.TestImputedStatsLinear">[docs]</a>
    <span class="k">def</span> <span class="nf">setUp</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
<div class="viewcode-block" id="TestImputedStatsLinear.setUp"><a class="viewcode-back" href="../../../module_content/gwip.tests.html#gwip.tests.test_imputed_stats.TestImputedStatsLinear.setUp">[docs]</a>        <span class="sd">&quot;&quot;&quot;Setup the tests.&quot;&quot;&quot;</span>
        <span class="c"># Creating the temporary directory</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">output_dir</span> <span class="o">=</span> <span class="n">TemporaryDirectory</span><span class="p">(</span><span class="n">prefix</span><span class="o">=</span><span class="s">&quot;gwip_test_&quot;</span><span class="p">)</span>

    <span class="k">def</span> <span class="nf">tearDown</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span></div>
<div class="viewcode-block" id="TestImputedStatsLinear.tearDown"><a class="viewcode-back" href="../../../module_content/gwip.tests.html#gwip.tests.test_imputed_stats.TestImputedStatsLinear.tearDown">[docs]</a>        <span class="sd">&quot;&quot;&quot;Finishes the test.&quot;&quot;&quot;</span>
        <span class="c"># Deleting the output directory</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">output_dir</span><span class="o">.</span><span class="n">cleanup</span><span class="p">()</span>

    <span class="k">def</span> <span class="nf">test_fit_linear</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span></div>
<div class="viewcode-block" id="TestImputedStatsLinear.test_fit_linear"><a class="viewcode-back" href="../../../module_content/gwip.tests.html#gwip.tests.test_imputed_stats.TestImputedStatsLinear.test_fit_linear">[docs]</a>        <span class="sd">&quot;&quot;&quot;Tests the &#39;fit_linear&#39; function.&quot;&quot;&quot;</span>
        <span class="c"># Reading the data</span>
        <span class="n">data_filename</span> <span class="o">=</span> <span class="n">resource_filename</span><span class="p">(</span>
            <span class="n">__name__</span><span class="p">,</span>
            <span class="s">&quot;data/regression_sim.txt.bz2&quot;</span><span class="p">,</span>
        <span class="p">)</span>

        <span class="c"># This dataset contains 3 markers + 5 covariables</span>
        <span class="n">data</span> <span class="o">=</span> <span class="n">pd</span><span class="o">.</span><span class="n">read_csv</span><span class="p">(</span><span class="n">data_filename</span><span class="p">,</span> <span class="n">sep</span><span class="o">=</span><span class="s">&quot;</span><span class="se">\t</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">compression</span><span class="o">=</span><span class="s">&quot;bz2&quot;</span><span class="p">)</span>

        <span class="c"># The formula for the first marker</span>
        <span class="n">formula</span> <span class="o">=</span> <span class="s">&quot;y ~ snp1 + C1 + C2 + C3 + age + gender&quot;</span>
        <span class="n">columns_to_keep</span> <span class="o">=</span> <span class="p">[</span><span class="s">&quot;y&quot;</span><span class="p">,</span> <span class="s">&quot;snp1&quot;</span><span class="p">,</span> <span class="s">&quot;C1&quot;</span><span class="p">,</span> <span class="s">&quot;C2&quot;</span><span class="p">,</span> <span class="s">&quot;C3&quot;</span><span class="p">,</span> <span class="s">&quot;age&quot;</span><span class="p">,</span> <span class="s">&quot;gender&quot;</span><span class="p">]</span>

        <span class="c"># The expected results for the first marker (according to R)</span>
        <span class="c"># The data was simulated so that snp1 had a coefficient of 0.1</span>
        <span class="n">expected_coef</span> <span class="o">=</span> <span class="mf">0.09930262321654575</span>
        <span class="n">expected_se</span> <span class="o">=</span> <span class="mf">0.00302135517743109</span>
        <span class="n">expected_min_ci</span> <span class="o">=</span> <span class="mf">0.09337963040899197</span>
        <span class="n">expected_max_ci</span> <span class="o">=</span> <span class="mf">0.10522561602409949</span>
        <span class="n">expected_t</span> <span class="o">=</span> <span class="mf">32.866914806414108</span>
        <span class="n">expected_p</span> <span class="o">=</span> <span class="mf">2.7965174627917724e-217</span>

        <span class="c"># The observed results for the first marker</span>
        <span class="n">observed</span> <span class="o">=</span> <span class="n">fit_linear</span><span class="p">(</span>
            <span class="n">data</span><span class="o">=</span><span class="n">data</span><span class="p">[</span><span class="n">columns_to_keep</span><span class="p">]</span><span class="o">.</span><span class="n">dropna</span><span class="p">(</span><span class="n">axis</span><span class="o">=</span><span class="mi">0</span><span class="p">),</span>
            <span class="n">formula</span><span class="o">=</span><span class="n">formula</span><span class="p">,</span>
            <span class="n">result_col</span><span class="o">=</span><span class="s">&quot;snp1&quot;</span><span class="p">,</span>
        <span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">assertEqual</span><span class="p">(</span><span class="mi">6</span><span class="p">,</span> <span class="nb">len</span><span class="p">(</span><span class="n">observed</span><span class="p">))</span>
        <span class="n">observed_coef</span><span class="p">,</span> <span class="n">observed_se</span><span class="p">,</span> <span class="n">observed_min_ci</span><span class="p">,</span> <span class="n">observed_max_ci</span><span class="p">,</span> \
            <span class="n">observed_t</span><span class="p">,</span> <span class="n">observed_p</span> <span class="o">=</span> <span class="n">observed</span>

        <span class="c"># Comparing the results</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">assertAlmostEqual</span><span class="p">(</span><span class="n">expected_coef</span><span class="p">,</span> <span class="n">observed_coef</span><span class="p">,</span> <span class="n">places</span><span class="o">=</span><span class="mi">10</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">assertAlmostEqual</span><span class="p">(</span><span class="n">expected_se</span><span class="p">,</span> <span class="n">observed_se</span><span class="p">,</span> <span class="n">places</span><span class="o">=</span><span class="mi">10</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">assertAlmostEqual</span><span class="p">(</span><span class="n">expected_min_ci</span><span class="p">,</span> <span class="n">observed_min_ci</span><span class="p">,</span> <span class="n">places</span><span class="o">=</span><span class="mi">10</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">assertAlmostEqual</span><span class="p">(</span><span class="n">expected_max_ci</span><span class="p">,</span> <span class="n">observed_max_ci</span><span class="p">,</span> <span class="n">places</span><span class="o">=</span><span class="mi">10</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">assertAlmostEqual</span><span class="p">(</span><span class="n">expected_t</span><span class="p">,</span> <span class="n">observed_t</span><span class="p">,</span> <span class="n">places</span><span class="o">=</span><span class="mi">10</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">assertAlmostEqual</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">log10</span><span class="p">(</span><span class="n">expected_p</span><span class="p">),</span> <span class="n">np</span><span class="o">.</span><span class="n">log10</span><span class="p">(</span><span class="n">observed_p</span><span class="p">),</span>
                               <span class="n">places</span><span class="o">=</span><span class="mi">10</span><span class="p">)</span>

        <span class="c"># The formula for the second marker</span>
        <span class="n">formula</span> <span class="o">=</span> <span class="s">&quot;y ~ snp2 + C1 + C2 + C3 + age + gender&quot;</span>
        <span class="n">columns_to_keep</span> <span class="o">=</span> <span class="p">[</span><span class="s">&quot;y&quot;</span><span class="p">,</span> <span class="s">&quot;snp2&quot;</span><span class="p">,</span> <span class="s">&quot;C1&quot;</span><span class="p">,</span> <span class="s">&quot;C2&quot;</span><span class="p">,</span> <span class="s">&quot;C3&quot;</span><span class="p">,</span> <span class="s">&quot;age&quot;</span><span class="p">,</span> <span class="s">&quot;gender&quot;</span><span class="p">]</span>

        <span class="c"># The expected results for the second marker (according to R)</span>
        <span class="c"># The data was simulated so that snp1 had a coefficient of 0</span>
        <span class="n">expected_coef</span> <span class="o">=</span> <span class="o">-</span><span class="mf">0.00279702443754753</span>
        <span class="n">expected_se</span> <span class="o">=</span> <span class="mf">0.00240385609310785</span>
        <span class="n">expected_min_ci</span> <span class="o">=</span> <span class="o">-</span><span class="mf">0.0075094867313642991</span>
        <span class="n">expected_max_ci</span> <span class="o">=</span> <span class="mf">0.0019154378562692411</span>
        <span class="n">expected_t</span> <span class="o">=</span> <span class="o">-</span><span class="mf">1.1635573550209353</span>
        <span class="n">expected_p</span> <span class="o">=</span> <span class="mf">0.24465167231462448</span>

        <span class="c"># The observed results for the first marker</span>
        <span class="n">observed</span> <span class="o">=</span> <span class="n">fit_linear</span><span class="p">(</span>
            <span class="n">data</span><span class="o">=</span><span class="n">data</span><span class="p">[</span><span class="n">columns_to_keep</span><span class="p">]</span><span class="o">.</span><span class="n">dropna</span><span class="p">(</span><span class="n">axis</span><span class="o">=</span><span class="mi">0</span><span class="p">),</span>
            <span class="n">formula</span><span class="o">=</span><span class="n">formula</span><span class="p">,</span>
            <span class="n">result_col</span><span class="o">=</span><span class="s">&quot;snp2&quot;</span><span class="p">,</span>
        <span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">assertEqual</span><span class="p">(</span><span class="mi">6</span><span class="p">,</span> <span class="nb">len</span><span class="p">(</span><span class="n">observed</span><span class="p">))</span>
        <span class="n">observed_coef</span><span class="p">,</span> <span class="n">observed_se</span><span class="p">,</span> <span class="n">observed_min_ci</span><span class="p">,</span> <span class="n">observed_max_ci</span><span class="p">,</span> \
            <span class="n">observed_t</span><span class="p">,</span> <span class="n">observed_p</span> <span class="o">=</span> <span class="n">observed</span>

        <span class="c"># Comparing the results</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">assertAlmostEqual</span><span class="p">(</span><span class="n">expected_coef</span><span class="p">,</span> <span class="n">observed_coef</span><span class="p">,</span> <span class="n">places</span><span class="o">=</span><span class="mi">10</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">assertAlmostEqual</span><span class="p">(</span><span class="n">expected_se</span><span class="p">,</span> <span class="n">observed_se</span><span class="p">,</span> <span class="n">places</span><span class="o">=</span><span class="mi">10</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">assertAlmostEqual</span><span class="p">(</span><span class="n">expected_min_ci</span><span class="p">,</span> <span class="n">observed_min_ci</span><span class="p">,</span> <span class="n">places</span><span class="o">=</span><span class="mi">10</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">assertAlmostEqual</span><span class="p">(</span><span class="n">expected_max_ci</span><span class="p">,</span> <span class="n">observed_max_ci</span><span class="p">,</span> <span class="n">places</span><span class="o">=</span><span class="mi">10</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">assertAlmostEqual</span><span class="p">(</span><span class="n">expected_t</span><span class="p">,</span> <span class="n">observed_t</span><span class="p">,</span> <span class="n">places</span><span class="o">=</span><span class="mi">10</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">assertAlmostEqual</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">log10</span><span class="p">(</span><span class="n">expected_p</span><span class="p">),</span> <span class="n">np</span><span class="o">.</span><span class="n">log10</span><span class="p">(</span><span class="n">observed_p</span><span class="p">),</span>
                               <span class="n">places</span><span class="o">=</span><span class="mi">10</span><span class="p">)</span>

        <span class="c"># The formula for the third (and last) marker</span>
        <span class="n">formula</span> <span class="o">=</span> <span class="s">&quot;y ~ snp3 + C1 + C2 + C3 + age + gender&quot;</span>
        <span class="n">columns_to_keep</span> <span class="o">=</span> <span class="p">[</span><span class="s">&quot;y&quot;</span><span class="p">,</span> <span class="s">&quot;snp3&quot;</span><span class="p">,</span> <span class="s">&quot;C1&quot;</span><span class="p">,</span> <span class="s">&quot;C2&quot;</span><span class="p">,</span> <span class="s">&quot;C3&quot;</span><span class="p">,</span> <span class="s">&quot;age&quot;</span><span class="p">,</span> <span class="s">&quot;gender&quot;</span><span class="p">]</span>

        <span class="c"># The expected results for the second marker (according to R)</span>
        <span class="c"># The data was simulated so that snp1 had a coefficient of -0.12</span>
        <span class="n">expected_coef</span> <span class="o">=</span> <span class="o">-</span><span class="mf">0.11731595824657762</span>
        <span class="n">expected_se</span> <span class="o">=</span> <span class="mf">0.00327175651867383</span>
        <span class="n">expected_min_ci</span> <span class="o">=</span> <span class="o">-</span><span class="mf">0.12372983188610413</span>
        <span class="n">expected_max_ci</span> <span class="o">=</span> <span class="o">-</span><span class="mf">0.1109020846070511</span>
        <span class="n">expected_t</span> <span class="o">=</span> <span class="o">-</span><span class="mf">35.857178728608552</span>
        <span class="n">expected_p</span> <span class="o">=</span> <span class="mf">2.4882495142044017e-254</span>

        <span class="c"># The observed results for the first marker</span>
        <span class="n">observed</span> <span class="o">=</span> <span class="n">fit_linear</span><span class="p">(</span>
            <span class="n">data</span><span class="o">=</span><span class="n">data</span><span class="p">[</span><span class="n">columns_to_keep</span><span class="p">]</span><span class="o">.</span><span class="n">dropna</span><span class="p">(</span><span class="n">axis</span><span class="o">=</span><span class="mi">0</span><span class="p">),</span>
            <span class="n">formula</span><span class="o">=</span><span class="n">formula</span><span class="p">,</span>
            <span class="n">result_col</span><span class="o">=</span><span class="s">&quot;snp3&quot;</span><span class="p">,</span>
        <span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">assertEqual</span><span class="p">(</span><span class="mi">6</span><span class="p">,</span> <span class="nb">len</span><span class="p">(</span><span class="n">observed</span><span class="p">))</span>
        <span class="n">observed_coef</span><span class="p">,</span> <span class="n">observed_se</span><span class="p">,</span> <span class="n">observed_min_ci</span><span class="p">,</span> <span class="n">observed_max_ci</span><span class="p">,</span> \
            <span class="n">observed_t</span><span class="p">,</span> <span class="n">observed_p</span> <span class="o">=</span> <span class="n">observed</span>

        <span class="c"># Comparing the results</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">assertAlmostEqual</span><span class="p">(</span><span class="n">expected_coef</span><span class="p">,</span> <span class="n">observed_coef</span><span class="p">,</span> <span class="n">places</span><span class="o">=</span><span class="mi">10</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">assertAlmostEqual</span><span class="p">(</span><span class="n">expected_se</span><span class="p">,</span> <span class="n">observed_se</span><span class="p">,</span> <span class="n">places</span><span class="o">=</span><span class="mi">10</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">assertAlmostEqual</span><span class="p">(</span><span class="n">expected_min_ci</span><span class="p">,</span> <span class="n">observed_min_ci</span><span class="p">,</span> <span class="n">places</span><span class="o">=</span><span class="mi">10</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">assertAlmostEqual</span><span class="p">(</span><span class="n">expected_max_ci</span><span class="p">,</span> <span class="n">observed_max_ci</span><span class="p">,</span> <span class="n">places</span><span class="o">=</span><span class="mi">10</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">assertAlmostEqual</span><span class="p">(</span><span class="n">expected_t</span><span class="p">,</span> <span class="n">observed_t</span><span class="p">,</span> <span class="n">places</span><span class="o">=</span><span class="mi">10</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">assertAlmostEqual</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">log10</span><span class="p">(</span><span class="n">expected_p</span><span class="p">),</span> <span class="n">np</span><span class="o">.</span><span class="n">log10</span><span class="p">(</span><span class="n">observed_p</span><span class="p">),</span>
                               <span class="n">places</span><span class="o">=</span><span class="mi">10</span><span class="p">)</span>

        <span class="c"># Asking for an invalid column should raise a KeyError</span>
        <span class="k">with</span> <span class="bp">self</span><span class="o">.</span><span class="n">assertRaises</span><span class="p">(</span><span class="ne">KeyError</span><span class="p">)</span> <span class="k">as</span> <span class="n">cm</span><span class="p">:</span>
            <span class="n">fit_linear</span><span class="p">(</span>
                <span class="n">data</span><span class="o">=</span><span class="n">data</span><span class="p">[</span><span class="n">columns_to_keep</span><span class="p">]</span><span class="o">.</span><span class="n">dropna</span><span class="p">(</span><span class="n">axis</span><span class="o">=</span><span class="mi">0</span><span class="p">),</span>
                <span class="n">formula</span><span class="o">=</span><span class="n">formula</span><span class="p">,</span>
                <span class="n">result_col</span><span class="o">=</span><span class="s">&quot;unknown&quot;</span><span class="p">,</span>
            <span class="p">)</span>

        <span class="k">with</span> <span class="bp">self</span><span class="o">.</span><span class="n">assertRaises</span><span class="p">(</span><span class="n">patsy</span><span class="o">.</span><span class="n">PatsyError</span><span class="p">)</span> <span class="k">as</span> <span class="n">cm</span><span class="p">:</span>
            <span class="n">fit_linear</span><span class="p">(</span>
                <span class="n">data</span><span class="o">=</span><span class="n">data</span><span class="p">[</span><span class="n">columns_to_keep</span><span class="p">]</span><span class="o">.</span><span class="n">dropna</span><span class="p">(</span><span class="n">axis</span><span class="o">=</span><span class="mi">0</span><span class="p">),</span>
                <span class="n">formula</span><span class="o">=</span><span class="n">formula</span> <span class="o">+</span> <span class="s">&quot; + unknown&quot;</span><span class="p">,</span>
                <span class="n">result_col</span><span class="o">=</span><span class="s">&quot;snp4&quot;</span><span class="p">,</span>
            <span class="p">)</span>

    <span class="k">def</span> <span class="nf">test_fit_linear_interaction</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span></div>
<div class="viewcode-block" id="TestImputedStatsLinear.test_fit_linear_interaction"><a class="viewcode-back" href="../../../module_content/gwip.tests.html#gwip.tests.test_imputed_stats.TestImputedStatsLinear.test_fit_linear_interaction">[docs]</a>        <span class="sd">&quot;&quot;&quot;Tests the &#39;fit_linear&#39; function with interaction.&quot;&quot;&quot;</span>
        <span class="c"># Reading the data</span>
        <span class="n">data_filename</span> <span class="o">=</span> <span class="n">resource_filename</span><span class="p">(</span>
            <span class="n">__name__</span><span class="p">,</span>
            <span class="s">&quot;data/regression_sim_inter.txt.bz2&quot;</span><span class="p">,</span>
        <span class="p">)</span>

        <span class="c"># This dataset contains 3 markers + 5 covariables</span>
        <span class="n">data</span> <span class="o">=</span> <span class="n">pd</span><span class="o">.</span><span class="n">read_csv</span><span class="p">(</span><span class="n">data_filename</span><span class="p">,</span> <span class="n">sep</span><span class="o">=</span><span class="s">&quot;</span><span class="se">\t</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">compression</span><span class="o">=</span><span class="s">&quot;bz2&quot;</span><span class="p">)</span>

        <span class="c"># The formula for the first marker</span>
        <span class="n">formula</span> <span class="o">=</span> <span class="s">&quot;y ~ snp1 + C1 + C2 + C3 + age + gender + snp1*gender&quot;</span>
        <span class="n">columns_to_keep</span> <span class="o">=</span> <span class="p">[</span><span class="s">&quot;y&quot;</span><span class="p">,</span> <span class="s">&quot;snp1&quot;</span><span class="p">,</span> <span class="s">&quot;C1&quot;</span><span class="p">,</span> <span class="s">&quot;C2&quot;</span><span class="p">,</span> <span class="s">&quot;C3&quot;</span><span class="p">,</span> <span class="s">&quot;age&quot;</span><span class="p">,</span> <span class="s">&quot;gender&quot;</span><span class="p">]</span>

        <span class="c"># The expected results for the first marker (according to R)</span>
        <span class="c"># The data was simulated so that snp1 had a coefficient of 0.1</span>
        <span class="n">expected_coef</span> <span class="o">=</span> <span class="mf">0.101959570845217173</span>
        <span class="n">expected_se</span> <span class="o">=</span> <span class="mf">0.00588764130382715949</span>
        <span class="n">expected_min_ci</span> <span class="o">=</span> <span class="mf">0.090417578486636035</span>
        <span class="n">expected_max_ci</span> <span class="o">=</span> <span class="mf">0.11350156320379831</span>
        <span class="n">expected_t</span> <span class="o">=</span> <span class="mf">17.3175581839437314</span>
        <span class="n">expected_p</span> <span class="o">=</span> <span class="mf">1.5527088106478929e-65</span>

        <span class="c"># The observed results</span>
        <span class="n">observed</span> <span class="o">=</span> <span class="n">fit_linear</span><span class="p">(</span>
            <span class="n">data</span><span class="o">=</span><span class="n">data</span><span class="p">[</span><span class="n">columns_to_keep</span><span class="p">]</span><span class="o">.</span><span class="n">dropna</span><span class="p">(</span><span class="n">axis</span><span class="o">=</span><span class="mi">0</span><span class="p">),</span>
            <span class="n">formula</span><span class="o">=</span><span class="n">formula</span><span class="p">,</span>
            <span class="n">result_col</span><span class="o">=</span><span class="s">&quot;snp1:gender&quot;</span><span class="p">,</span>
        <span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">assertEqual</span><span class="p">(</span><span class="mi">6</span><span class="p">,</span> <span class="nb">len</span><span class="p">(</span><span class="n">observed</span><span class="p">))</span>
        <span class="n">observed_coef</span><span class="p">,</span> <span class="n">observed_se</span><span class="p">,</span> <span class="n">observed_min_ci</span><span class="p">,</span> <span class="n">observed_max_ci</span><span class="p">,</span> \
            <span class="n">observed_t</span><span class="p">,</span> <span class="n">observed_p</span> <span class="o">=</span> <span class="n">observed</span>

        <span class="c"># Comparing the results</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">assertAlmostEqual</span><span class="p">(</span><span class="n">expected_coef</span><span class="p">,</span> <span class="n">observed_coef</span><span class="p">,</span> <span class="n">places</span><span class="o">=</span><span class="mi">10</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">assertAlmostEqual</span><span class="p">(</span><span class="n">expected_se</span><span class="p">,</span> <span class="n">observed_se</span><span class="p">,</span> <span class="n">places</span><span class="o">=</span><span class="mi">10</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">assertAlmostEqual</span><span class="p">(</span><span class="n">expected_min_ci</span><span class="p">,</span> <span class="n">observed_min_ci</span><span class="p">,</span> <span class="n">places</span><span class="o">=</span><span class="mi">10</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">assertAlmostEqual</span><span class="p">(</span><span class="n">expected_max_ci</span><span class="p">,</span> <span class="n">observed_max_ci</span><span class="p">,</span> <span class="n">places</span><span class="o">=</span><span class="mi">10</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">assertAlmostEqual</span><span class="p">(</span><span class="n">expected_t</span><span class="p">,</span> <span class="n">observed_t</span><span class="p">,</span> <span class="n">places</span><span class="o">=</span><span class="mi">10</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">assertAlmostEqual</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">log10</span><span class="p">(</span><span class="n">expected_p</span><span class="p">),</span> <span class="n">np</span><span class="o">.</span><span class="n">log10</span><span class="p">(</span><span class="n">observed_p</span><span class="p">),</span>
                               <span class="n">places</span><span class="o">=</span><span class="mi">10</span><span class="p">)</span>

    <span class="k">def</span> <span class="nf">test_full_fit_linear</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span></div>
<div class="viewcode-block" id="TestImputedStatsLinear.test_full_fit_linear"><a class="viewcode-back" href="../../../module_content/gwip.tests.html#gwip.tests.test_imputed_stats.TestImputedStatsLinear.test_full_fit_linear">[docs]</a>        <span class="sd">&quot;&quot;&quot;Tests the full pipeline for linear regression.&quot;&quot;&quot;</span>
        <span class="c"># Reading the data</span>
        <span class="n">data_filename</span> <span class="o">=</span> <span class="n">resource_filename</span><span class="p">(</span>
            <span class="n">__name__</span><span class="p">,</span>
            <span class="s">&quot;data/regression_sim.txt.bz2&quot;</span><span class="p">,</span>
        <span class="p">)</span>

        <span class="c"># Creating the input files</span>
        <span class="n">o_prefix</span><span class="p">,</span> <span class="n">options</span> <span class="o">=</span> <span class="n">create_input_files</span><span class="p">(</span>
            <span class="n">i_filename</span><span class="o">=</span><span class="n">data_filename</span><span class="p">,</span>
            <span class="n">output_dirname</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">output_dir</span><span class="o">.</span><span class="n">name</span><span class="p">,</span>
            <span class="n">analysis_type</span><span class="o">=</span><span class="s">&quot;linear&quot;</span><span class="p">,</span>
        <span class="p">)</span>

        <span class="c"># Executing the tool</span>
        <span class="n">main</span><span class="p">(</span><span class="n">args</span><span class="o">=</span><span class="n">options</span><span class="p">)</span>

        <span class="c"># Cleaning the handlers</span>
        <span class="n">clean_logging_handlers</span><span class="p">()</span>

        <span class="c"># Making sure the output file exists</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">assertTrue</span><span class="p">(</span><span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">isfile</span><span class="p">(</span><span class="n">o_prefix</span> <span class="o">+</span> <span class="s">&quot;.linear.dosage&quot;</span><span class="p">))</span>

        <span class="c"># Reading the data</span>
        <span class="n">observed</span> <span class="o">=</span> <span class="n">pd</span><span class="o">.</span><span class="n">read_csv</span><span class="p">(</span><span class="n">o_prefix</span> <span class="o">+</span> <span class="s">&quot;.linear.dosage&quot;</span><span class="p">,</span> <span class="n">sep</span><span class="o">=</span><span class="s">&quot;</span><span class="se">\t</span><span class="s">&quot;</span><span class="p">)</span>

        <span class="c"># Checking all columns are present</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">assertEqual</span><span class="p">([</span><span class="s">&quot;chr&quot;</span><span class="p">,</span> <span class="s">&quot;pos&quot;</span><span class="p">,</span> <span class="s">&quot;snp&quot;</span><span class="p">,</span> <span class="s">&quot;major&quot;</span><span class="p">,</span> <span class="s">&quot;minor&quot;</span><span class="p">,</span> <span class="s">&quot;maf&quot;</span><span class="p">,</span> <span class="s">&quot;n&quot;</span><span class="p">,</span>
                          <span class="s">&quot;coef&quot;</span><span class="p">,</span> <span class="s">&quot;se&quot;</span><span class="p">,</span> <span class="s">&quot;lower&quot;</span><span class="p">,</span> <span class="s">&quot;upper&quot;</span><span class="p">,</span> <span class="s">&quot;t&quot;</span><span class="p">,</span> <span class="s">&quot;p&quot;</span><span class="p">],</span>
                         <span class="nb">list</span><span class="p">(</span><span class="n">observed</span><span class="o">.</span><span class="n">columns</span><span class="p">))</span>

        <span class="c"># Chromosomes</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">assertEqual</span><span class="p">([</span><span class="mi">22</span><span class="p">],</span> <span class="n">observed</span><span class="o">.</span><span class="n">chr</span><span class="o">.</span><span class="n">unique</span><span class="p">())</span>

        <span class="c"># Positions</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">assertEqual</span><span class="p">([</span><span class="mi">1</span><span class="p">,</span> <span class="mi">2</span><span class="p">,</span> <span class="mi">3</span><span class="p">],</span> <span class="nb">list</span><span class="p">(</span><span class="n">observed</span><span class="o">.</span><span class="n">pos</span><span class="p">))</span>

        <span class="c"># Marker names</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">assertEqual</span><span class="p">([</span><span class="s">&quot;marker_1&quot;</span><span class="p">,</span> <span class="s">&quot;marker_2&quot;</span><span class="p">,</span> <span class="s">&quot;marker_3&quot;</span><span class="p">],</span>
                         <span class="nb">list</span><span class="p">(</span><span class="n">observed</span><span class="o">.</span><span class="n">snp</span><span class="p">))</span>

        <span class="c"># Major alleles</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">assertEqual</span><span class="p">([</span><span class="s">&quot;T&quot;</span><span class="p">,</span> <span class="s">&quot;G&quot;</span><span class="p">,</span> <span class="s">&quot;AT&quot;</span><span class="p">],</span> <span class="nb">list</span><span class="p">(</span><span class="n">observed</span><span class="o">.</span><span class="n">major</span><span class="p">))</span>

        <span class="c"># Minor alleles</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">assertEqual</span><span class="p">([</span><span class="s">&quot;C&quot;</span><span class="p">,</span> <span class="s">&quot;A&quot;</span><span class="p">,</span> <span class="s">&quot;A&quot;</span><span class="p">],</span> <span class="nb">list</span><span class="p">(</span><span class="n">observed</span><span class="o">.</span><span class="n">minor</span><span class="p">))</span>

        <span class="c"># Minor allele frequency</span>
        <span class="n">expected</span> <span class="o">=</span> <span class="p">[</span><span class="mi">1724</span> <span class="o">/</span> <span class="mi">11526</span><span class="p">,</span> <span class="mi">4604</span> <span class="o">/</span> <span class="mi">11526</span><span class="p">,</span> <span class="mi">1379</span> <span class="o">/</span> <span class="mi">11526</span><span class="p">]</span>
        <span class="k">for</span> <span class="n">expected_maf</span><span class="p">,</span> <span class="n">observed_maf</span> <span class="ow">in</span> <span class="nb">zip</span><span class="p">(</span><span class="n">expected</span><span class="p">,</span> <span class="n">observed</span><span class="o">.</span><span class="n">maf</span><span class="p">):</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">assertAlmostEqual</span><span class="p">(</span><span class="n">expected_maf</span><span class="p">,</span> <span class="n">observed_maf</span><span class="p">,</span> <span class="n">places</span><span class="o">=</span><span class="mi">10</span><span class="p">)</span>

        <span class="c"># The number of samples</span>
        <span class="n">expected</span> <span class="o">=</span> <span class="p">[</span><span class="mi">5763</span><span class="p">,</span> <span class="mi">5763</span><span class="p">,</span> <span class="mi">5763</span><span class="p">]</span>
        <span class="k">for</span> <span class="n">expected_n</span><span class="p">,</span> <span class="n">observed_n</span> <span class="ow">in</span> <span class="nb">zip</span><span class="p">(</span><span class="n">expected</span><span class="p">,</span> <span class="n">observed</span><span class="o">.</span><span class="n">n</span><span class="p">):</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">assertEqual</span><span class="p">(</span><span class="n">expected_n</span><span class="p">,</span> <span class="n">observed_n</span><span class="p">)</span>

        <span class="c"># The coefficients</span>
        <span class="n">expected</span> <span class="o">=</span> <span class="p">[</span><span class="mf">0.09930262321654575</span><span class="p">,</span> <span class="o">-</span><span class="mf">0.00279702443754753</span><span class="p">,</span>
                    <span class="o">-</span><span class="mf">0.11731595824657762</span><span class="p">]</span>
        <span class="k">for</span> <span class="n">expected_coef</span><span class="p">,</span> <span class="n">observed_coef</span> <span class="ow">in</span> <span class="nb">zip</span><span class="p">(</span><span class="n">expected</span><span class="p">,</span> <span class="n">observed</span><span class="o">.</span><span class="n">coef</span><span class="p">):</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">assertAlmostEqual</span><span class="p">(</span><span class="n">expected_coef</span><span class="p">,</span> <span class="n">observed_coef</span><span class="p">,</span> <span class="n">places</span><span class="o">=</span><span class="mi">10</span><span class="p">)</span>

        <span class="c"># The standard error</span>
        <span class="n">expected</span> <span class="o">=</span> <span class="p">[</span><span class="mf">0.00302135517743109</span><span class="p">,</span> <span class="mf">0.00240385609310785</span><span class="p">,</span>
                    <span class="mf">0.00327175651867383</span><span class="p">]</span>
        <span class="k">for</span> <span class="n">expected_se</span><span class="p">,</span> <span class="n">observed_se</span> <span class="ow">in</span> <span class="nb">zip</span><span class="p">(</span><span class="n">expected</span><span class="p">,</span> <span class="n">observed</span><span class="o">.</span><span class="n">se</span><span class="p">):</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">assertAlmostEqual</span><span class="p">(</span><span class="n">expected_se</span><span class="p">,</span> <span class="n">observed_se</span><span class="p">,</span> <span class="n">places</span><span class="o">=</span><span class="mi">10</span><span class="p">)</span>

        <span class="c"># The lower CI</span>
        <span class="n">expected</span> <span class="o">=</span> <span class="p">[</span><span class="mf">0.09337963040899197</span><span class="p">,</span> <span class="o">-</span><span class="mf">0.0075094867313642991</span><span class="p">,</span>
                    <span class="o">-</span><span class="mf">0.12372983188610413</span><span class="p">]</span>
        <span class="k">for</span> <span class="n">expected_min_ci</span><span class="p">,</span> <span class="n">observed_min_ci</span> <span class="ow">in</span> <span class="nb">zip</span><span class="p">(</span><span class="n">expected</span><span class="p">,</span> <span class="n">observed</span><span class="o">.</span><span class="n">lower</span><span class="p">):</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">assertAlmostEqual</span><span class="p">(</span><span class="n">expected_min_ci</span><span class="p">,</span> <span class="n">observed_min_ci</span><span class="p">,</span> <span class="n">places</span><span class="o">=</span><span class="mi">10</span><span class="p">)</span>

        <span class="c"># The upper CI</span>
        <span class="n">expected</span> <span class="o">=</span> <span class="p">[</span><span class="mf">0.10522561602409949</span><span class="p">,</span> <span class="mf">0.0019154378562692411</span><span class="p">,</span>
                    <span class="o">-</span><span class="mf">0.1109020846070511</span><span class="p">]</span>
        <span class="k">for</span> <span class="n">expected_max_ci</span><span class="p">,</span> <span class="n">observed_max_ci</span> <span class="ow">in</span> <span class="nb">zip</span><span class="p">(</span><span class="n">expected</span><span class="p">,</span> <span class="n">observed</span><span class="o">.</span><span class="n">upper</span><span class="p">):</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">assertAlmostEqual</span><span class="p">(</span><span class="n">expected_max_ci</span><span class="p">,</span> <span class="n">observed_max_ci</span><span class="p">,</span> <span class="n">places</span><span class="o">=</span><span class="mi">10</span><span class="p">)</span>

        <span class="c"># The T statistics</span>
        <span class="n">expected</span> <span class="o">=</span> <span class="p">[</span><span class="mf">32.866914806414108</span><span class="p">,</span> <span class="o">-</span><span class="mf">1.1635573550209353</span><span class="p">,</span>
                    <span class="o">-</span><span class="mf">35.857178728608552</span><span class="p">]</span>
        <span class="k">for</span> <span class="n">expected_t</span><span class="p">,</span> <span class="n">observed_t</span> <span class="ow">in</span> <span class="nb">zip</span><span class="p">(</span><span class="n">expected</span><span class="p">,</span> <span class="n">observed</span><span class="o">.</span><span class="n">t</span><span class="p">):</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">assertAlmostEqual</span><span class="p">(</span><span class="n">expected_t</span><span class="p">,</span> <span class="n">observed_t</span><span class="p">,</span> <span class="n">places</span><span class="o">=</span><span class="mi">10</span><span class="p">)</span>

        <span class="c"># The p values</span>
        <span class="n">expected</span> <span class="o">=</span> <span class="p">[</span><span class="mf">2.7965174627917724e-217</span><span class="p">,</span> <span class="mf">0.24465167231462448</span><span class="p">,</span>
                    <span class="mf">2.4882495142044017e-254</span><span class="p">]</span>
        <span class="k">for</span> <span class="n">expected_p</span><span class="p">,</span> <span class="n">observed_p</span> <span class="ow">in</span> <span class="nb">zip</span><span class="p">(</span><span class="n">expected</span><span class="p">,</span> <span class="n">observed</span><span class="o">.</span><span class="n">p</span><span class="p">):</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">assertAlmostEqual</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">log10</span><span class="p">(</span><span class="n">expected_p</span><span class="p">),</span> <span class="n">np</span><span class="o">.</span><span class="n">log10</span><span class="p">(</span><span class="n">observed_p</span><span class="p">),</span>
                                   <span class="n">places</span><span class="o">=</span><span class="mi">10</span><span class="p">)</span>

    <span class="nd">@unittest.skipIf</span><span class="p">(</span><span class="n">platform</span><span class="o">.</span><span class="n">system</span><span class="p">()</span> <span class="o">==</span> <span class="s">&quot;Darwin&quot;</span><span class="p">,</span></div>
                     <span class="s">&quot;multiprocessing not supported with Mac OS&quot;</span><span class="p">)</span>
    <span class="k">def</span> <span class="nf">test_full_fit_linear_multiprocess</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
<div class="viewcode-block" id="TestImputedStatsLinear.test_full_fit_linear_multiprocess"><a class="viewcode-back" href="../../../module_content/gwip.tests.html#gwip.tests.test_imputed_stats.TestImputedStatsLinear.test_full_fit_linear_multiprocess">[docs]</a>        <span class="sd">&quot;&quot;&quot;Tests the full pipeline for linear regression with &gt;1 processes.&quot;&quot;&quot;</span>
        <span class="c"># Reading the data</span>
        <span class="n">data_filename</span> <span class="o">=</span> <span class="n">resource_filename</span><span class="p">(</span>
            <span class="n">__name__</span><span class="p">,</span>
            <span class="s">&quot;data/regression_sim.txt.bz2&quot;</span><span class="p">,</span>
        <span class="p">)</span>

        <span class="c"># Creating the input files</span>
        <span class="n">o_prefix</span><span class="p">,</span> <span class="n">options</span> <span class="o">=</span> <span class="n">create_input_files</span><span class="p">(</span>
            <span class="n">i_filename</span><span class="o">=</span><span class="n">data_filename</span><span class="p">,</span>
            <span class="n">output_dirname</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">output_dir</span><span class="o">.</span><span class="n">name</span><span class="p">,</span>
            <span class="n">analysis_type</span><span class="o">=</span><span class="s">&quot;linear&quot;</span><span class="p">,</span>
            <span class="n">nb_process</span><span class="o">=</span><span class="mi">2</span><span class="p">,</span>
        <span class="p">)</span>

        <span class="c"># Executing the tool</span>
        <span class="n">main</span><span class="p">(</span><span class="n">args</span><span class="o">=</span><span class="n">options</span><span class="p">)</span>

        <span class="c"># Cleaning the handlers</span>
        <span class="n">clean_logging_handlers</span><span class="p">()</span>

        <span class="c"># Making sure the output file exists</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">assertTrue</span><span class="p">(</span><span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">isfile</span><span class="p">(</span><span class="n">o_prefix</span> <span class="o">+</span> <span class="s">&quot;.linear.dosage&quot;</span><span class="p">))</span>

        <span class="c"># Reading the data</span>
        <span class="n">observed</span> <span class="o">=</span> <span class="n">pd</span><span class="o">.</span><span class="n">read_csv</span><span class="p">(</span><span class="n">o_prefix</span> <span class="o">+</span> <span class="s">&quot;.linear.dosage&quot;</span><span class="p">,</span> <span class="n">sep</span><span class="o">=</span><span class="s">&quot;</span><span class="se">\t</span><span class="s">&quot;</span><span class="p">)</span>

        <span class="c"># Checking all columns are present</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">assertEqual</span><span class="p">([</span><span class="s">&quot;chr&quot;</span><span class="p">,</span> <span class="s">&quot;pos&quot;</span><span class="p">,</span> <span class="s">&quot;snp&quot;</span><span class="p">,</span> <span class="s">&quot;major&quot;</span><span class="p">,</span> <span class="s">&quot;minor&quot;</span><span class="p">,</span> <span class="s">&quot;maf&quot;</span><span class="p">,</span> <span class="s">&quot;n&quot;</span><span class="p">,</span>
                          <span class="s">&quot;coef&quot;</span><span class="p">,</span> <span class="s">&quot;se&quot;</span><span class="p">,</span> <span class="s">&quot;lower&quot;</span><span class="p">,</span> <span class="s">&quot;upper&quot;</span><span class="p">,</span> <span class="s">&quot;t&quot;</span><span class="p">,</span> <span class="s">&quot;p&quot;</span><span class="p">],</span>
                         <span class="nb">list</span><span class="p">(</span><span class="n">observed</span><span class="o">.</span><span class="n">columns</span><span class="p">))</span>

        <span class="c"># Chromosomes</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">assertEqual</span><span class="p">([</span><span class="mi">22</span><span class="p">],</span> <span class="n">observed</span><span class="o">.</span><span class="n">chr</span><span class="o">.</span><span class="n">unique</span><span class="p">())</span>

        <span class="c"># Positions</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">assertEqual</span><span class="p">([</span><span class="mi">1</span><span class="p">,</span> <span class="mi">2</span><span class="p">,</span> <span class="mi">3</span><span class="p">],</span> <span class="nb">list</span><span class="p">(</span><span class="n">observed</span><span class="o">.</span><span class="n">pos</span><span class="p">))</span>

        <span class="c"># Marker names</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">assertEqual</span><span class="p">([</span><span class="s">&quot;marker_1&quot;</span><span class="p">,</span> <span class="s">&quot;marker_2&quot;</span><span class="p">,</span> <span class="s">&quot;marker_3&quot;</span><span class="p">],</span>
                         <span class="nb">list</span><span class="p">(</span><span class="n">observed</span><span class="o">.</span><span class="n">snp</span><span class="p">))</span>

        <span class="c"># Major alleles</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">assertEqual</span><span class="p">([</span><span class="s">&quot;T&quot;</span><span class="p">,</span> <span class="s">&quot;G&quot;</span><span class="p">,</span> <span class="s">&quot;AT&quot;</span><span class="p">],</span> <span class="nb">list</span><span class="p">(</span><span class="n">observed</span><span class="o">.</span><span class="n">major</span><span class="p">))</span>

        <span class="c"># Minor alleles</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">assertEqual</span><span class="p">([</span><span class="s">&quot;C&quot;</span><span class="p">,</span> <span class="s">&quot;A&quot;</span><span class="p">,</span> <span class="s">&quot;A&quot;</span><span class="p">],</span> <span class="nb">list</span><span class="p">(</span><span class="n">observed</span><span class="o">.</span><span class="n">minor</span><span class="p">))</span>

        <span class="c"># Minor allele frequency</span>
        <span class="n">expected</span> <span class="o">=</span> <span class="p">[</span><span class="mi">1724</span> <span class="o">/</span> <span class="mi">11526</span><span class="p">,</span> <span class="mi">4604</span> <span class="o">/</span> <span class="mi">11526</span><span class="p">,</span> <span class="mi">1379</span> <span class="o">/</span> <span class="mi">11526</span><span class="p">]</span>
        <span class="k">for</span> <span class="n">expected_maf</span><span class="p">,</span> <span class="n">observed_maf</span> <span class="ow">in</span> <span class="nb">zip</span><span class="p">(</span><span class="n">expected</span><span class="p">,</span> <span class="n">observed</span><span class="o">.</span><span class="n">maf</span><span class="p">):</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">assertAlmostEqual</span><span class="p">(</span><span class="n">expected_maf</span><span class="p">,</span> <span class="n">observed_maf</span><span class="p">,</span> <span class="n">places</span><span class="o">=</span><span class="mi">10</span><span class="p">)</span>

        <span class="c"># The number of samples</span>
        <span class="n">expected</span> <span class="o">=</span> <span class="p">[</span><span class="mi">5763</span><span class="p">,</span> <span class="mi">5763</span><span class="p">,</span> <span class="mi">5763</span><span class="p">]</span>
        <span class="k">for</span> <span class="n">expected_n</span><span class="p">,</span> <span class="n">observed_n</span> <span class="ow">in</span> <span class="nb">zip</span><span class="p">(</span><span class="n">expected</span><span class="p">,</span> <span class="n">observed</span><span class="o">.</span><span class="n">n</span><span class="p">):</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">assertEqual</span><span class="p">(</span><span class="n">expected_n</span><span class="p">,</span> <span class="n">observed_n</span><span class="p">)</span>

        <span class="c"># The coefficients</span>
        <span class="n">expected</span> <span class="o">=</span> <span class="p">[</span><span class="mf">0.09930262321654575</span><span class="p">,</span> <span class="o">-</span><span class="mf">0.00279702443754753</span><span class="p">,</span>
                    <span class="o">-</span><span class="mf">0.11731595824657762</span><span class="p">]</span>
        <span class="k">for</span> <span class="n">expected_coef</span><span class="p">,</span> <span class="n">observed_coef</span> <span class="ow">in</span> <span class="nb">zip</span><span class="p">(</span><span class="n">expected</span><span class="p">,</span> <span class="n">observed</span><span class="o">.</span><span class="n">coef</span><span class="p">):</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">assertAlmostEqual</span><span class="p">(</span><span class="n">expected_coef</span><span class="p">,</span> <span class="n">observed_coef</span><span class="p">,</span> <span class="n">places</span><span class="o">=</span><span class="mi">10</span><span class="p">)</span>

        <span class="c"># The standard error</span>
        <span class="n">expected</span> <span class="o">=</span> <span class="p">[</span><span class="mf">0.00302135517743109</span><span class="p">,</span> <span class="mf">0.00240385609310785</span><span class="p">,</span>
                    <span class="mf">0.00327175651867383</span><span class="p">]</span>
        <span class="k">for</span> <span class="n">expected_se</span><span class="p">,</span> <span class="n">observed_se</span> <span class="ow">in</span> <span class="nb">zip</span><span class="p">(</span><span class="n">expected</span><span class="p">,</span> <span class="n">observed</span><span class="o">.</span><span class="n">se</span><span class="p">):</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">assertAlmostEqual</span><span class="p">(</span><span class="n">expected_se</span><span class="p">,</span> <span class="n">observed_se</span><span class="p">,</span> <span class="n">places</span><span class="o">=</span><span class="mi">10</span><span class="p">)</span>

        <span class="c"># The lower CI</span>
        <span class="n">expected</span> <span class="o">=</span> <span class="p">[</span><span class="mf">0.09337963040899197</span><span class="p">,</span> <span class="o">-</span><span class="mf">0.0075094867313642991</span><span class="p">,</span>
                    <span class="o">-</span><span class="mf">0.12372983188610413</span><span class="p">]</span>
        <span class="k">for</span> <span class="n">expected_min_ci</span><span class="p">,</span> <span class="n">observed_min_ci</span> <span class="ow">in</span> <span class="nb">zip</span><span class="p">(</span><span class="n">expected</span><span class="p">,</span> <span class="n">observed</span><span class="o">.</span><span class="n">lower</span><span class="p">):</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">assertAlmostEqual</span><span class="p">(</span><span class="n">expected_min_ci</span><span class="p">,</span> <span class="n">observed_min_ci</span><span class="p">,</span> <span class="n">places</span><span class="o">=</span><span class="mi">10</span><span class="p">)</span>

        <span class="c"># The upper CI</span>
        <span class="n">expected</span> <span class="o">=</span> <span class="p">[</span><span class="mf">0.10522561602409949</span><span class="p">,</span> <span class="mf">0.0019154378562692411</span><span class="p">,</span>
                    <span class="o">-</span><span class="mf">0.1109020846070511</span><span class="p">]</span>
        <span class="k">for</span> <span class="n">expected_max_ci</span><span class="p">,</span> <span class="n">observed_max_ci</span> <span class="ow">in</span> <span class="nb">zip</span><span class="p">(</span><span class="n">expected</span><span class="p">,</span> <span class="n">observed</span><span class="o">.</span><span class="n">upper</span><span class="p">):</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">assertAlmostEqual</span><span class="p">(</span><span class="n">expected_max_ci</span><span class="p">,</span> <span class="n">observed_max_ci</span><span class="p">,</span> <span class="n">places</span><span class="o">=</span><span class="mi">10</span><span class="p">)</span>

        <span class="c"># The T statistics</span>
        <span class="n">expected</span> <span class="o">=</span> <span class="p">[</span><span class="mf">32.866914806414108</span><span class="p">,</span> <span class="o">-</span><span class="mf">1.1635573550209353</span><span class="p">,</span>
                    <span class="o">-</span><span class="mf">35.857178728608552</span><span class="p">]</span>
        <span class="k">for</span> <span class="n">expected_t</span><span class="p">,</span> <span class="n">observed_t</span> <span class="ow">in</span> <span class="nb">zip</span><span class="p">(</span><span class="n">expected</span><span class="p">,</span> <span class="n">observed</span><span class="o">.</span><span class="n">t</span><span class="p">):</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">assertAlmostEqual</span><span class="p">(</span><span class="n">expected_t</span><span class="p">,</span> <span class="n">observed_t</span><span class="p">,</span> <span class="n">places</span><span class="o">=</span><span class="mi">10</span><span class="p">)</span>

        <span class="c"># The p values</span>
        <span class="n">expected</span> <span class="o">=</span> <span class="p">[</span><span class="mf">2.7965174627917724e-217</span><span class="p">,</span> <span class="mf">0.24465167231462448</span><span class="p">,</span>
                    <span class="mf">2.4882495142044017e-254</span><span class="p">]</span>
        <span class="k">for</span> <span class="n">expected_p</span><span class="p">,</span> <span class="n">observed_p</span> <span class="ow">in</span> <span class="nb">zip</span><span class="p">(</span><span class="n">expected</span><span class="p">,</span> <span class="n">observed</span><span class="o">.</span><span class="n">p</span><span class="p">):</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">assertAlmostEqual</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">log10</span><span class="p">(</span><span class="n">expected_p</span><span class="p">),</span> <span class="n">np</span><span class="o">.</span><span class="n">log10</span><span class="p">(</span><span class="n">observed_p</span><span class="p">),</span>
                                   <span class="n">places</span><span class="o">=</span><span class="mi">10</span><span class="p">)</span>

    <span class="k">def</span> <span class="nf">test_full_fit_linear_interaction</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span></div>
<div class="viewcode-block" id="TestImputedStatsLinear.test_full_fit_linear_interaction"><a class="viewcode-back" href="../../../module_content/gwip.tests.html#gwip.tests.test_imputed_stats.TestImputedStatsLinear.test_full_fit_linear_interaction">[docs]</a>        <span class="sd">&quot;&quot;&quot;Tests the full pipeline for linear regression with interaction.&quot;&quot;&quot;</span>
        <span class="c"># Reading the data</span>
        <span class="n">data_filename</span> <span class="o">=</span> <span class="n">resource_filename</span><span class="p">(</span>
            <span class="n">__name__</span><span class="p">,</span>
            <span class="s">&quot;data/regression_sim_inter.txt.bz2&quot;</span><span class="p">,</span>
        <span class="p">)</span>

        <span class="c"># Creating the input files</span>
        <span class="n">o_prefix</span><span class="p">,</span> <span class="n">options</span> <span class="o">=</span> <span class="n">create_input_files</span><span class="p">(</span>
            <span class="n">i_filename</span><span class="o">=</span><span class="n">data_filename</span><span class="p">,</span>
            <span class="n">output_dirname</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">output_dir</span><span class="o">.</span><span class="n">name</span><span class="p">,</span>
            <span class="n">analysis_type</span><span class="o">=</span><span class="s">&quot;linear&quot;</span><span class="p">,</span>
            <span class="n">interaction</span><span class="o">=</span><span class="s">&quot;gender&quot;</span><span class="p">,</span>
        <span class="p">)</span>

        <span class="c"># Executing the tool</span>
        <span class="n">main</span><span class="p">(</span><span class="n">args</span><span class="o">=</span><span class="n">options</span><span class="p">)</span>

        <span class="c"># Cleaning the handlers</span>
        <span class="n">clean_logging_handlers</span><span class="p">()</span>

        <span class="c"># Making sure the output file exists</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">assertTrue</span><span class="p">(</span><span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">isfile</span><span class="p">(</span><span class="n">o_prefix</span> <span class="o">+</span> <span class="s">&quot;.linear.dosage&quot;</span><span class="p">))</span>

        <span class="c"># Reading the data</span>
        <span class="n">observed</span> <span class="o">=</span> <span class="n">pd</span><span class="o">.</span><span class="n">read_csv</span><span class="p">(</span><span class="n">o_prefix</span> <span class="o">+</span> <span class="s">&quot;.linear.dosage&quot;</span><span class="p">,</span> <span class="n">sep</span><span class="o">=</span><span class="s">&quot;</span><span class="se">\t</span><span class="s">&quot;</span><span class="p">)</span>

        <span class="c"># Checking all columns are present</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">assertEqual</span><span class="p">([</span><span class="s">&quot;chr&quot;</span><span class="p">,</span> <span class="s">&quot;pos&quot;</span><span class="p">,</span> <span class="s">&quot;snp&quot;</span><span class="p">,</span> <span class="s">&quot;major&quot;</span><span class="p">,</span> <span class="s">&quot;minor&quot;</span><span class="p">,</span> <span class="s">&quot;maf&quot;</span><span class="p">,</span> <span class="s">&quot;n&quot;</span><span class="p">,</span>
                          <span class="s">&quot;coef&quot;</span><span class="p">,</span> <span class="s">&quot;se&quot;</span><span class="p">,</span> <span class="s">&quot;lower&quot;</span><span class="p">,</span> <span class="s">&quot;upper&quot;</span><span class="p">,</span> <span class="s">&quot;t&quot;</span><span class="p">,</span> <span class="s">&quot;p&quot;</span><span class="p">],</span>
                         <span class="nb">list</span><span class="p">(</span><span class="n">observed</span><span class="o">.</span><span class="n">columns</span><span class="p">))</span>

        <span class="c"># Chromosomes</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">assertEqual</span><span class="p">([</span><span class="mi">22</span><span class="p">],</span> <span class="n">observed</span><span class="o">.</span><span class="n">chr</span><span class="o">.</span><span class="n">unique</span><span class="p">())</span>

        <span class="c"># Positions</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">assertEqual</span><span class="p">([</span><span class="mi">1</span><span class="p">,</span> <span class="mi">2</span><span class="p">,</span> <span class="mi">3</span><span class="p">],</span> <span class="nb">list</span><span class="p">(</span><span class="n">observed</span><span class="o">.</span><span class="n">pos</span><span class="p">))</span>

        <span class="c"># Marker names</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">assertEqual</span><span class="p">([</span><span class="s">&quot;marker_1&quot;</span><span class="p">,</span> <span class="s">&quot;marker_2&quot;</span><span class="p">,</span> <span class="s">&quot;marker_3&quot;</span><span class="p">],</span>
                         <span class="nb">list</span><span class="p">(</span><span class="n">observed</span><span class="o">.</span><span class="n">snp</span><span class="p">))</span>

        <span class="c"># Major alleles</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">assertEqual</span><span class="p">([</span><span class="s">&quot;T&quot;</span><span class="p">,</span> <span class="s">&quot;G&quot;</span><span class="p">,</span> <span class="s">&quot;AT&quot;</span><span class="p">],</span> <span class="nb">list</span><span class="p">(</span><span class="n">observed</span><span class="o">.</span><span class="n">major</span><span class="p">))</span>

        <span class="c"># Minor alleles</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">assertEqual</span><span class="p">([</span><span class="s">&quot;C&quot;</span><span class="p">,</span> <span class="s">&quot;A&quot;</span><span class="p">,</span> <span class="s">&quot;A&quot;</span><span class="p">],</span> <span class="nb">list</span><span class="p">(</span><span class="n">observed</span><span class="o">.</span><span class="n">minor</span><span class="p">))</span>

        <span class="c"># Minor allele frequency</span>
        <span class="n">expected</span> <span class="o">=</span> <span class="p">[</span><span class="mi">1724</span> <span class="o">/</span> <span class="mi">11526</span><span class="p">,</span> <span class="mi">4604</span> <span class="o">/</span> <span class="mi">11526</span><span class="p">,</span> <span class="mi">1379</span> <span class="o">/</span> <span class="mi">11526</span><span class="p">]</span>
        <span class="k">for</span> <span class="n">expected_maf</span><span class="p">,</span> <span class="n">observed_maf</span> <span class="ow">in</span> <span class="nb">zip</span><span class="p">(</span><span class="n">expected</span><span class="p">,</span> <span class="n">observed</span><span class="o">.</span><span class="n">maf</span><span class="p">):</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">assertAlmostEqual</span><span class="p">(</span><span class="n">expected_maf</span><span class="p">,</span> <span class="n">observed_maf</span><span class="p">,</span> <span class="n">places</span><span class="o">=</span><span class="mi">10</span><span class="p">)</span>

        <span class="c"># The number of samples</span>
        <span class="n">expected</span> <span class="o">=</span> <span class="p">[</span><span class="mi">5763</span><span class="p">,</span> <span class="mi">5763</span><span class="p">,</span> <span class="mi">5763</span><span class="p">]</span>
        <span class="k">for</span> <span class="n">expected_n</span><span class="p">,</span> <span class="n">observed_n</span> <span class="ow">in</span> <span class="nb">zip</span><span class="p">(</span><span class="n">expected</span><span class="p">,</span> <span class="n">observed</span><span class="o">.</span><span class="n">n</span><span class="p">):</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">assertEqual</span><span class="p">(</span><span class="n">expected_n</span><span class="p">,</span> <span class="n">observed_n</span><span class="p">)</span>

        <span class="c"># The coefficients</span>
        <span class="n">expected</span> <span class="o">=</span> <span class="p">[</span><span class="mf">0.1019595708452171734</span><span class="p">,</span> <span class="o">-</span><span class="mf">0.010917110807672320352</span><span class="p">,</span>
                    <span class="mf">0.02657634353683377762</span><span class="p">]</span>
        <span class="k">for</span> <span class="n">expected_coef</span><span class="p">,</span> <span class="n">observed_coef</span> <span class="ow">in</span> <span class="nb">zip</span><span class="p">(</span><span class="n">expected</span><span class="p">,</span> <span class="n">observed</span><span class="o">.</span><span class="n">coef</span><span class="p">):</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">assertAlmostEqual</span><span class="p">(</span><span class="n">expected_coef</span><span class="p">,</span> <span class="n">observed_coef</span><span class="p">,</span> <span class="n">places</span><span class="o">=</span><span class="mi">10</span><span class="p">)</span>

        <span class="c"># The standard error</span>
        <span class="n">expected</span> <span class="o">=</span> <span class="p">[</span><span class="mf">0.005887641303827159493</span><span class="p">,</span> <span class="mf">0.006578361146066042525</span><span class="p">,</span>
                    <span class="mf">0.009435607764482155033</span><span class="p">]</span>
        <span class="k">for</span> <span class="n">expected_se</span><span class="p">,</span> <span class="n">observed_se</span> <span class="ow">in</span> <span class="nb">zip</span><span class="p">(</span><span class="n">expected</span><span class="p">,</span> <span class="n">observed</span><span class="o">.</span><span class="n">se</span><span class="p">):</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">assertAlmostEqual</span><span class="p">(</span><span class="n">expected_se</span><span class="p">,</span> <span class="n">observed_se</span><span class="p">,</span> <span class="n">places</span><span class="o">=</span><span class="mi">10</span><span class="p">)</span>

        <span class="c"># The lower CI</span>
        <span class="n">expected</span> <span class="o">=</span> <span class="p">[</span><span class="mf">0.0904175784866360355</span><span class="p">,</span> <span class="o">-</span><span class="mf">0.0238131739612693419</span><span class="p">,</span>
                    <span class="mf">0.00807900188569928013</span><span class="p">]</span>
        <span class="k">for</span> <span class="n">expected_min_ci</span><span class="p">,</span> <span class="n">observed_min_ci</span> <span class="ow">in</span> <span class="nb">zip</span><span class="p">(</span><span class="n">expected</span><span class="p">,</span> <span class="n">observed</span><span class="o">.</span><span class="n">lower</span><span class="p">):</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">assertAlmostEqual</span><span class="p">(</span><span class="n">expected_min_ci</span><span class="p">,</span> <span class="n">observed_min_ci</span><span class="p">,</span> <span class="n">places</span><span class="o">=</span><span class="mi">10</span><span class="p">)</span>

        <span class="c"># The upper CI</span>
        <span class="n">expected</span> <span class="o">=</span> <span class="p">[</span><span class="mf">0.113501563203798311</span><span class="p">,</span> <span class="mf">0.00197895234592469944</span><span class="p">,</span>
                    <span class="mf">0.0450736851879682751</span><span class="p">]</span>
        <span class="k">for</span> <span class="n">expected_max_ci</span><span class="p">,</span> <span class="n">observed_max_ci</span> <span class="ow">in</span> <span class="nb">zip</span><span class="p">(</span><span class="n">expected</span><span class="p">,</span> <span class="n">observed</span><span class="o">.</span><span class="n">upper</span><span class="p">):</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">assertAlmostEqual</span><span class="p">(</span><span class="n">expected_max_ci</span><span class="p">,</span> <span class="n">observed_max_ci</span><span class="p">,</span> <span class="n">places</span><span class="o">=</span><span class="mi">10</span><span class="p">)</span>

        <span class="c"># The T statistics</span>
        <span class="n">expected</span> <span class="o">=</span> <span class="p">[</span><span class="mf">17.31755818394373136</span><span class="p">,</span> <span class="o">-</span><span class="mf">1.65954871817898208519</span><span class="p">,</span>
                    <span class="mf">2.816601134785761129</span><span class="p">]</span>
        <span class="k">for</span> <span class="n">expected_t</span><span class="p">,</span> <span class="n">observed_t</span> <span class="ow">in</span> <span class="nb">zip</span><span class="p">(</span><span class="n">expected</span><span class="p">,</span> <span class="n">observed</span><span class="o">.</span><span class="n">t</span><span class="p">):</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">assertAlmostEqual</span><span class="p">(</span><span class="n">expected_t</span><span class="p">,</span> <span class="n">observed_t</span><span class="p">,</span> <span class="n">places</span><span class="o">=</span><span class="mi">10</span><span class="p">)</span>

        <span class="c"># The p values</span>
        <span class="n">expected</span> <span class="o">=</span> <span class="p">[</span><span class="mf">1.55270881064789290e-65</span><span class="p">,</span> <span class="mf">9.70597574168038796e-02</span><span class="p">,</span>
                    <span class="mf">4.87000487450673421e-03</span><span class="p">]</span>
        <span class="k">for</span> <span class="n">expected_p</span><span class="p">,</span> <span class="n">observed_p</span> <span class="ow">in</span> <span class="nb">zip</span><span class="p">(</span><span class="n">expected</span><span class="p">,</span> <span class="n">observed</span><span class="o">.</span><span class="n">p</span><span class="p">):</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">assertAlmostEqual</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">log10</span><span class="p">(</span><span class="n">expected_p</span><span class="p">),</span> <span class="n">np</span><span class="o">.</span><span class="n">log10</span><span class="p">(</span><span class="n">observed_p</span><span class="p">),</span>
                                   <span class="n">places</span><span class="o">=</span><span class="mi">10</span><span class="p">)</span>


<span class="nd">@unittest.skipIf</span><span class="p">(</span><span class="ow">not</span> <span class="n">HAS_STATSMODELS</span><span class="p">,</span></div></div>
                 <span class="s">&quot;optional requirement (statsmodels) not satisfied&quot;</span><span class="p">)</span>
<span class="k">class</span> <span class="nc">TestImputedStatsLogistic</span><span class="p">(</span><span class="n">unittest</span><span class="o">.</span><span class="n">TestCase</span><span class="p">):</span>
<div class="viewcode-block" id="TestImputedStatsLogistic"><a class="viewcode-back" href="../../../module_content/gwip.tests.html#gwip.tests.test_imputed_stats.TestImputedStatsLogistic">[docs]</a>
    <span class="k">def</span> <span class="nf">setUp</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
<div class="viewcode-block" id="TestImputedStatsLogistic.setUp"><a class="viewcode-back" href="../../../module_content/gwip.tests.html#gwip.tests.test_imputed_stats.TestImputedStatsLogistic.setUp">[docs]</a>        <span class="sd">&quot;&quot;&quot;Setup the tests.&quot;&quot;&quot;</span>
        <span class="c"># Creating the temporary directory</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">output_dir</span> <span class="o">=</span> <span class="n">TemporaryDirectory</span><span class="p">(</span><span class="n">prefix</span><span class="o">=</span><span class="s">&quot;gwip_test_&quot;</span><span class="p">)</span>

    <span class="k">def</span> <span class="nf">tearDown</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span></div>
<div class="viewcode-block" id="TestImputedStatsLogistic.tearDown"><a class="viewcode-back" href="../../../module_content/gwip.tests.html#gwip.tests.test_imputed_stats.TestImputedStatsLogistic.tearDown">[docs]</a>        <span class="sd">&quot;&quot;&quot;Finishes the test.&quot;&quot;&quot;</span>
        <span class="c"># Deleting the output directory</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">output_dir</span><span class="o">.</span><span class="n">cleanup</span><span class="p">()</span>

    <span class="k">def</span> <span class="nf">test_fit_logistic</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span></div>
<div class="viewcode-block" id="TestImputedStatsLogistic.test_fit_logistic"><a class="viewcode-back" href="../../../module_content/gwip.tests.html#gwip.tests.test_imputed_stats.TestImputedStatsLogistic.test_fit_logistic">[docs]</a>        <span class="sd">&quot;&quot;&quot;Tests the &#39;fit_logistic&#39; function.&quot;&quot;&quot;</span>
        <span class="c"># Reading the data</span>
        <span class="n">data_filename</span> <span class="o">=</span> <span class="n">resource_filename</span><span class="p">(</span>
            <span class="n">__name__</span><span class="p">,</span>
            <span class="s">&quot;data/regression_sim.txt.bz2&quot;</span><span class="p">,</span>
        <span class="p">)</span>

        <span class="c"># This dataset contains 3 markers + 5 covariables</span>
        <span class="n">data</span> <span class="o">=</span> <span class="n">pd</span><span class="o">.</span><span class="n">read_csv</span><span class="p">(</span><span class="n">data_filename</span><span class="p">,</span> <span class="n">sep</span><span class="o">=</span><span class="s">&quot;</span><span class="se">\t</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">compression</span><span class="o">=</span><span class="s">&quot;bz2&quot;</span><span class="p">)</span>

        <span class="c"># The formula for the first marker</span>
        <span class="n">formula</span> <span class="o">=</span> <span class="s">&quot;y_d ~ snp1 + C1 + C2 + C3 + age + gender&quot;</span>
        <span class="n">columns_to_keep</span> <span class="o">=</span> <span class="p">[</span><span class="s">&quot;y_d&quot;</span><span class="p">,</span> <span class="s">&quot;snp1&quot;</span><span class="p">,</span> <span class="s">&quot;C1&quot;</span><span class="p">,</span> <span class="s">&quot;C2&quot;</span><span class="p">,</span> <span class="s">&quot;C3&quot;</span><span class="p">,</span> <span class="s">&quot;age&quot;</span><span class="p">,</span> <span class="s">&quot;gender&quot;</span><span class="p">]</span>

        <span class="c"># The expected results for the first marker (according to R)</span>
        <span class="n">expected_coef</span> <span class="o">=</span> <span class="o">-</span><span class="mf">0.514309712761157334</span>
        <span class="n">expected_se</span> <span class="o">=</span> <span class="mf">0.1148545370213162609</span>
        <span class="n">expected_min_ci</span> <span class="o">=</span> <span class="o">-</span><span class="mf">0.741288870474147710</span>
        <span class="n">expected_max_ci</span> <span class="o">=</span> <span class="o">-</span><span class="mf">0.290848443930784406</span>
        <span class="n">expected_z</span> <span class="o">=</span> <span class="o">-</span><span class="mf">4.477922475676383129</span>
        <span class="n">expected_p</span> <span class="o">=</span> <span class="mf">7.53729612963228856e-06</span>

        <span class="c"># The observed results for the first marker</span>
        <span class="n">observed</span> <span class="o">=</span> <span class="n">fit_logistic</span><span class="p">(</span>
            <span class="n">data</span><span class="o">=</span><span class="n">data</span><span class="p">[</span><span class="n">columns_to_keep</span><span class="p">]</span><span class="o">.</span><span class="n">dropna</span><span class="p">(</span><span class="n">axis</span><span class="o">=</span><span class="mi">0</span><span class="p">),</span>
            <span class="n">formula</span><span class="o">=</span><span class="n">formula</span><span class="p">,</span>
            <span class="n">result_col</span><span class="o">=</span><span class="s">&quot;snp1&quot;</span><span class="p">,</span>
        <span class="p">)</span>
        <span class="n">observed_coef</span><span class="p">,</span> <span class="n">observed_se</span><span class="p">,</span> <span class="n">observed_min_ci</span><span class="p">,</span> <span class="n">observed_max_ci</span><span class="p">,</span> \
            <span class="n">observed_z</span><span class="p">,</span> <span class="n">observed_p</span><span class="p">,</span> <span class="o">=</span> <span class="n">observed</span>

        <span class="c"># Comparing the results</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">assertAlmostEqual</span><span class="p">(</span><span class="n">expected_coef</span><span class="p">,</span> <span class="n">observed_coef</span><span class="p">,</span> <span class="n">places</span><span class="o">=</span><span class="mi">10</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">assertAlmostEqual</span><span class="p">(</span><span class="n">expected_se</span><span class="p">,</span> <span class="n">observed_se</span><span class="p">,</span> <span class="n">places</span><span class="o">=</span><span class="mi">7</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">assertAlmostEqual</span><span class="p">(</span><span class="n">expected_min_ci</span><span class="p">,</span> <span class="n">observed_min_ci</span><span class="p">,</span> <span class="n">places</span><span class="o">=</span><span class="mi">2</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">assertAlmostEqual</span><span class="p">(</span><span class="n">expected_max_ci</span><span class="p">,</span> <span class="n">observed_max_ci</span><span class="p">,</span> <span class="n">places</span><span class="o">=</span><span class="mi">2</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">assertAlmostEqual</span><span class="p">(</span><span class="n">expected_z</span><span class="p">,</span> <span class="n">observed_z</span><span class="p">,</span> <span class="n">places</span><span class="o">=</span><span class="mi">6</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">assertAlmostEqual</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">log10</span><span class="p">(</span><span class="n">expected_p</span><span class="p">),</span> <span class="n">np</span><span class="o">.</span><span class="n">log10</span><span class="p">(</span><span class="n">observed_p</span><span class="p">),</span>
                               <span class="n">places</span><span class="o">=</span><span class="mi">5</span><span class="p">)</span>

        <span class="c"># The formula for the second marker</span>
        <span class="n">formula</span> <span class="o">=</span> <span class="s">&quot;y_d ~ snp2 + C1 + C2 + C3 + age + gender&quot;</span>
        <span class="n">columns_to_keep</span> <span class="o">=</span> <span class="p">[</span><span class="s">&quot;y_d&quot;</span><span class="p">,</span> <span class="s">&quot;snp2&quot;</span><span class="p">,</span> <span class="s">&quot;C1&quot;</span><span class="p">,</span> <span class="s">&quot;C2&quot;</span><span class="p">,</span> <span class="s">&quot;C3&quot;</span><span class="p">,</span> <span class="s">&quot;age&quot;</span><span class="p">,</span> <span class="s">&quot;gender&quot;</span><span class="p">]</span>

        <span class="c"># The expected results for the second marker (according to R)</span>
        <span class="n">expected_coef</span> <span class="o">=</span> <span class="o">-</span><span class="mf">0.0409615621727592721</span>
        <span class="n">expected_se</span> <span class="o">=</span> <span class="mf">0.0898086129043482589</span>
        <span class="n">expected_min_ci</span> <span class="o">=</span> <span class="o">-</span><span class="mf">0.217201661656268197</span>
        <span class="n">expected_max_ci</span> <span class="o">=</span> <span class="mf">0.135039323830941221</span>
        <span class="n">expected_z</span> <span class="o">=</span> <span class="o">-</span><span class="mf">0.456098372395372320</span>
        <span class="n">expected_p</span> <span class="o">=</span> <span class="mf">6.48319240531225471e-01</span>

        <span class="c"># The observed results for the first marker</span>
        <span class="n">observed</span> <span class="o">=</span> <span class="n">fit_logistic</span><span class="p">(</span>
            <span class="n">data</span><span class="o">=</span><span class="n">data</span><span class="p">[</span><span class="n">columns_to_keep</span><span class="p">]</span><span class="o">.</span><span class="n">dropna</span><span class="p">(</span><span class="n">axis</span><span class="o">=</span><span class="mi">0</span><span class="p">),</span>
            <span class="n">formula</span><span class="o">=</span><span class="n">formula</span><span class="p">,</span>
            <span class="n">result_col</span><span class="o">=</span><span class="s">&quot;snp2&quot;</span><span class="p">,</span>
        <span class="p">)</span>
        <span class="n">observed_coef</span><span class="p">,</span> <span class="n">observed_se</span><span class="p">,</span> <span class="n">observed_min_ci</span><span class="p">,</span> <span class="n">observed_max_ci</span><span class="p">,</span> \
            <span class="n">observed_z</span><span class="p">,</span> <span class="n">observed_p</span><span class="p">,</span> <span class="o">=</span> <span class="n">observed</span>

        <span class="c"># Comparing the results</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">assertAlmostEqual</span><span class="p">(</span><span class="n">expected_coef</span><span class="p">,</span> <span class="n">observed_coef</span><span class="p">,</span> <span class="n">places</span><span class="o">=</span><span class="mi">9</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">assertAlmostEqual</span><span class="p">(</span><span class="n">expected_se</span><span class="p">,</span> <span class="n">observed_se</span><span class="p">,</span> <span class="n">places</span><span class="o">=</span><span class="mi">5</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">assertAlmostEqual</span><span class="p">(</span><span class="n">expected_min_ci</span><span class="p">,</span> <span class="n">observed_min_ci</span><span class="p">,</span> <span class="n">places</span><span class="o">=</span><span class="mi">3</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">assertAlmostEqual</span><span class="p">(</span><span class="n">expected_max_ci</span><span class="p">,</span> <span class="n">observed_max_ci</span><span class="p">,</span> <span class="n">places</span><span class="o">=</span><span class="mi">3</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">assertAlmostEqual</span><span class="p">(</span><span class="n">expected_z</span><span class="p">,</span> <span class="n">observed_z</span><span class="p">,</span> <span class="n">places</span><span class="o">=</span><span class="mi">4</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">assertAlmostEqual</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">log10</span><span class="p">(</span><span class="n">expected_p</span><span class="p">),</span> <span class="n">np</span><span class="o">.</span><span class="n">log10</span><span class="p">(</span><span class="n">observed_p</span><span class="p">),</span>
                               <span class="n">places</span><span class="o">=</span><span class="mi">5</span><span class="p">)</span>

        <span class="c"># The formula for the third (and last) marker</span>
        <span class="n">formula</span> <span class="o">=</span> <span class="s">&quot;y_d ~ snp3 + C1 + C2 + C3 + age + gender&quot;</span>
        <span class="n">columns_to_keep</span> <span class="o">=</span> <span class="p">[</span><span class="s">&quot;y_d&quot;</span><span class="p">,</span> <span class="s">&quot;snp3&quot;</span><span class="p">,</span> <span class="s">&quot;C1&quot;</span><span class="p">,</span> <span class="s">&quot;C2&quot;</span><span class="p">,</span> <span class="s">&quot;C3&quot;</span><span class="p">,</span> <span class="s">&quot;age&quot;</span><span class="p">,</span> <span class="s">&quot;gender&quot;</span><span class="p">]</span>

        <span class="c"># The expected results for the second marker (according to R)</span>
        <span class="n">expected_coef</span> <span class="o">=</span> <span class="mf">0.6806154974808061864</span>
        <span class="n">expected_se</span> <span class="o">=</span> <span class="mf">0.1216909125194588076</span>
        <span class="n">expected_min_ci</span> <span class="o">=</span> <span class="mf">0.442504664626330035</span>
        <span class="n">expected_max_ci</span> <span class="o">=</span> <span class="mf">0.919770526738653338</span>
        <span class="n">expected_z</span> <span class="o">=</span> <span class="mf">5.5929854036715633825</span>
        <span class="n">expected_p</span> <span class="o">=</span> <span class="mf">2.23198061422542684e-08</span>

        <span class="c"># The observed results for the first marker</span>
        <span class="n">observed</span> <span class="o">=</span> <span class="n">fit_logistic</span><span class="p">(</span>
            <span class="n">data</span><span class="o">=</span><span class="n">data</span><span class="p">[</span><span class="n">columns_to_keep</span><span class="p">]</span><span class="o">.</span><span class="n">dropna</span><span class="p">(</span><span class="n">axis</span><span class="o">=</span><span class="mi">0</span><span class="p">),</span>
            <span class="n">formula</span><span class="o">=</span><span class="n">formula</span><span class="p">,</span>
            <span class="n">result_col</span><span class="o">=</span><span class="s">&quot;snp3&quot;</span><span class="p">,</span>
        <span class="p">)</span>
        <span class="n">observed_coef</span><span class="p">,</span> <span class="n">observed_se</span><span class="p">,</span> <span class="n">observed_min_ci</span><span class="p">,</span> <span class="n">observed_max_ci</span><span class="p">,</span> \
            <span class="n">observed_z</span><span class="p">,</span> <span class="n">observed_p</span><span class="p">,</span> <span class="o">=</span> <span class="n">observed</span>

        <span class="c"># Comparing the results</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">assertAlmostEqual</span><span class="p">(</span><span class="n">expected_coef</span><span class="p">,</span> <span class="n">observed_coef</span><span class="p">,</span> <span class="n">places</span><span class="o">=</span><span class="mi">10</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">assertAlmostEqual</span><span class="p">(</span><span class="n">expected_se</span><span class="p">,</span> <span class="n">observed_se</span><span class="p">,</span> <span class="n">places</span><span class="o">=</span><span class="mi">7</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">assertAlmostEqual</span><span class="p">(</span><span class="n">expected_min_ci</span><span class="p">,</span> <span class="n">observed_min_ci</span><span class="p">,</span> <span class="n">places</span><span class="o">=</span><span class="mi">3</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">assertAlmostEqual</span><span class="p">(</span><span class="n">expected_max_ci</span><span class="p">,</span> <span class="n">observed_max_ci</span><span class="p">,</span> <span class="n">places</span><span class="o">=</span><span class="mi">2</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">assertAlmostEqual</span><span class="p">(</span><span class="n">expected_z</span><span class="p">,</span> <span class="n">observed_z</span><span class="p">,</span> <span class="n">places</span><span class="o">=</span><span class="mi">5</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">assertAlmostEqual</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">log10</span><span class="p">(</span><span class="n">expected_p</span><span class="p">),</span> <span class="n">np</span><span class="o">.</span><span class="n">log10</span><span class="p">(</span><span class="n">observed_p</span><span class="p">),</span>
                               <span class="n">places</span><span class="o">=</span><span class="mi">5</span><span class="p">)</span>

        <span class="c"># Asking for an invalid column should raise a KeyError</span>
        <span class="k">with</span> <span class="bp">self</span><span class="o">.</span><span class="n">assertRaises</span><span class="p">(</span><span class="ne">KeyError</span><span class="p">)</span> <span class="k">as</span> <span class="n">cm</span><span class="p">:</span>
            <span class="n">fit_logistic</span><span class="p">(</span>
                <span class="n">data</span><span class="o">=</span><span class="n">data</span><span class="p">[</span><span class="n">columns_to_keep</span><span class="p">]</span><span class="o">.</span><span class="n">dropna</span><span class="p">(</span><span class="n">axis</span><span class="o">=</span><span class="mi">0</span><span class="p">),</span>
                <span class="n">formula</span><span class="o">=</span><span class="n">formula</span><span class="p">,</span>
                <span class="n">result_col</span><span class="o">=</span><span class="s">&quot;unknown&quot;</span><span class="p">,</span>
            <span class="p">)</span>

        <span class="k">with</span> <span class="bp">self</span><span class="o">.</span><span class="n">assertRaises</span><span class="p">(</span><span class="n">patsy</span><span class="o">.</span><span class="n">PatsyError</span><span class="p">)</span> <span class="k">as</span> <span class="n">cm</span><span class="p">:</span>
            <span class="n">fit_logistic</span><span class="p">(</span>
                <span class="n">data</span><span class="o">=</span><span class="n">data</span><span class="p">[</span><span class="n">columns_to_keep</span><span class="p">]</span><span class="o">.</span><span class="n">dropna</span><span class="p">(</span><span class="n">axis</span><span class="o">=</span><span class="mi">0</span><span class="p">),</span>
                <span class="n">formula</span><span class="o">=</span><span class="n">formula</span> <span class="o">+</span> <span class="s">&quot; + unknown&quot;</span><span class="p">,</span>
                <span class="n">result_col</span><span class="o">=</span><span class="s">&quot;snp4&quot;</span><span class="p">,</span>
            <span class="p">)</span>

    <span class="k">def</span> <span class="nf">test_fit_logistic_interaction</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span></div>
<div class="viewcode-block" id="TestImputedStatsLogistic.test_fit_logistic_interaction"><a class="viewcode-back" href="../../../module_content/gwip.tests.html#gwip.tests.test_imputed_stats.TestImputedStatsLogistic.test_fit_logistic_interaction">[docs]</a>        <span class="sd">&quot;&quot;&quot;Tests the &#39;fit_logistic&#39; function with interaction.&quot;&quot;&quot;</span>
        <span class="c"># Reading the data</span>
        <span class="n">data_filename</span> <span class="o">=</span> <span class="n">resource_filename</span><span class="p">(</span>
            <span class="n">__name__</span><span class="p">,</span>
            <span class="s">&quot;data/regression_sim_inter.txt.bz2&quot;</span><span class="p">,</span>
        <span class="p">)</span>

        <span class="c"># This dataset contains 3 markers + 5 covariables</span>
        <span class="n">data</span> <span class="o">=</span> <span class="n">pd</span><span class="o">.</span><span class="n">read_csv</span><span class="p">(</span><span class="n">data_filename</span><span class="p">,</span> <span class="n">sep</span><span class="o">=</span><span class="s">&quot;</span><span class="se">\t</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">compression</span><span class="o">=</span><span class="s">&quot;bz2&quot;</span><span class="p">)</span>

        <span class="c"># The formula for the first marker</span>
        <span class="n">formula</span> <span class="o">=</span> <span class="s">&quot;y_d ~ snp1 + C1 + C2 + C3 + age + gender + snp1*gender&quot;</span>
        <span class="n">columns_to_keep</span> <span class="o">=</span> <span class="p">[</span><span class="s">&quot;y_d&quot;</span><span class="p">,</span> <span class="s">&quot;snp1&quot;</span><span class="p">,</span> <span class="s">&quot;C1&quot;</span><span class="p">,</span> <span class="s">&quot;C2&quot;</span><span class="p">,</span> <span class="s">&quot;C3&quot;</span><span class="p">,</span> <span class="s">&quot;age&quot;</span><span class="p">,</span> <span class="s">&quot;gender&quot;</span><span class="p">]</span>

        <span class="c"># The expected results for the first marker (according to R)</span>
        <span class="n">expected_coef</span> <span class="o">=</span> <span class="o">-</span><span class="mf">0.4998229445983128905</span>
        <span class="n">expected_se</span> <span class="o">=</span> <span class="mf">0.2425924038476814093</span>
        <span class="n">expected_min_ci</span> <span class="o">=</span> <span class="o">-</span><span class="mf">0.9779101205637230620</span>
        <span class="n">expected_max_ci</span> <span class="o">=</span> <span class="o">-</span><span class="mf">0.0263169240328645603</span>
        <span class="n">expected_z</span> <span class="o">=</span> <span class="o">-</span><span class="mf">2.0603404586078508665</span>
        <span class="n">expected_p</span> <span class="o">=</span> <span class="mf">3.93660046768015970e-02</span>

        <span class="c"># The observed results</span>
        <span class="n">observed</span> <span class="o">=</span> <span class="n">fit_logistic</span><span class="p">(</span>
            <span class="n">data</span><span class="o">=</span><span class="n">data</span><span class="p">[</span><span class="n">columns_to_keep</span><span class="p">],</span>
            <span class="n">formula</span><span class="o">=</span><span class="n">formula</span><span class="p">,</span>
            <span class="n">result_col</span><span class="o">=</span><span class="s">&quot;snp1:gender&quot;</span><span class="p">,</span>
        <span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">assertEqual</span><span class="p">(</span><span class="mi">6</span><span class="p">,</span> <span class="nb">len</span><span class="p">(</span><span class="n">observed</span><span class="p">))</span>
        <span class="n">observed_coef</span><span class="p">,</span> <span class="n">observed_se</span><span class="p">,</span> <span class="n">observed_min_ci</span><span class="p">,</span> <span class="n">observed_max_ci</span><span class="p">,</span> \
            <span class="n">observed_z</span><span class="p">,</span> <span class="n">observed_p</span> <span class="o">=</span> <span class="n">observed</span>

        <span class="c"># Comparing the results</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">assertAlmostEqual</span><span class="p">(</span><span class="n">expected_coef</span><span class="p">,</span> <span class="n">observed_coef</span><span class="p">,</span> <span class="n">places</span><span class="o">=</span><span class="mi">10</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">assertAlmostEqual</span><span class="p">(</span><span class="n">expected_se</span><span class="p">,</span> <span class="n">observed_se</span><span class="p">,</span> <span class="n">places</span><span class="o">=</span><span class="mi">7</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">assertAlmostEqual</span><span class="p">(</span><span class="n">expected_min_ci</span><span class="p">,</span> <span class="n">observed_min_ci</span><span class="p">,</span> <span class="n">places</span><span class="o">=</span><span class="mi">2</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">assertAlmostEqual</span><span class="p">(</span><span class="n">expected_max_ci</span><span class="p">,</span> <span class="n">observed_max_ci</span><span class="p">,</span> <span class="n">places</span><span class="o">=</span><span class="mi">2</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">assertAlmostEqual</span><span class="p">(</span><span class="n">expected_z</span><span class="p">,</span> <span class="n">observed_z</span><span class="p">,</span> <span class="n">places</span><span class="o">=</span><span class="mi">6</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">assertAlmostEqual</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">log10</span><span class="p">(</span><span class="n">expected_p</span><span class="p">),</span> <span class="n">np</span><span class="o">.</span><span class="n">log10</span><span class="p">(</span><span class="n">observed_p</span><span class="p">),</span>
                               <span class="n">places</span><span class="o">=</span><span class="mi">6</span><span class="p">)</span>

    <span class="k">def</span> <span class="nf">test_full_fit_logistic</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span></div>
<div class="viewcode-block" id="TestImputedStatsLogistic.test_full_fit_logistic"><a class="viewcode-back" href="../../../module_content/gwip.tests.html#gwip.tests.test_imputed_stats.TestImputedStatsLogistic.test_full_fit_logistic">[docs]</a>        <span class="sd">&quot;&quot;&quot;Tests the full pipeline for logistic regression.&quot;&quot;&quot;</span>
        <span class="c"># Reading the data</span>
        <span class="n">data_filename</span> <span class="o">=</span> <span class="n">resource_filename</span><span class="p">(</span>
            <span class="n">__name__</span><span class="p">,</span>
            <span class="s">&quot;data/regression_sim.txt.bz2&quot;</span><span class="p">,</span>
        <span class="p">)</span>

        <span class="c"># Creating the input files</span>
        <span class="n">o_prefix</span><span class="p">,</span> <span class="n">options</span> <span class="o">=</span> <span class="n">create_input_files</span><span class="p">(</span>
            <span class="n">i_filename</span><span class="o">=</span><span class="n">data_filename</span><span class="p">,</span>
            <span class="n">output_dirname</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">output_dir</span><span class="o">.</span><span class="n">name</span><span class="p">,</span>
            <span class="n">analysis_type</span><span class="o">=</span><span class="s">&quot;logistic&quot;</span><span class="p">,</span>
            <span class="n">pheno_name</span><span class="o">=</span><span class="s">&quot;y_d&quot;</span><span class="p">,</span>
        <span class="p">)</span>

        <span class="c"># Executing the tool</span>
        <span class="n">main</span><span class="p">(</span><span class="n">args</span><span class="o">=</span><span class="n">options</span><span class="p">)</span>

        <span class="c"># Cleaning the handlers</span>
        <span class="n">clean_logging_handlers</span><span class="p">()</span>

        <span class="c"># Making sure the output file exists</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">assertTrue</span><span class="p">(</span><span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">isfile</span><span class="p">(</span><span class="n">o_prefix</span> <span class="o">+</span> <span class="s">&quot;.logistic.dosage&quot;</span><span class="p">))</span>

        <span class="c"># Reading the data</span>
        <span class="n">observed</span> <span class="o">=</span> <span class="n">pd</span><span class="o">.</span><span class="n">read_csv</span><span class="p">(</span><span class="n">o_prefix</span> <span class="o">+</span> <span class="s">&quot;.logistic.dosage&quot;</span><span class="p">,</span> <span class="n">sep</span><span class="o">=</span><span class="s">&quot;</span><span class="se">\t</span><span class="s">&quot;</span><span class="p">)</span>

        <span class="c"># Checking all columns are present</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">assertEqual</span><span class="p">([</span><span class="s">&quot;chr&quot;</span><span class="p">,</span> <span class="s">&quot;pos&quot;</span><span class="p">,</span> <span class="s">&quot;snp&quot;</span><span class="p">,</span> <span class="s">&quot;major&quot;</span><span class="p">,</span> <span class="s">&quot;minor&quot;</span><span class="p">,</span> <span class="s">&quot;maf&quot;</span><span class="p">,</span> <span class="s">&quot;n&quot;</span><span class="p">,</span>
                          <span class="s">&quot;coef&quot;</span><span class="p">,</span> <span class="s">&quot;se&quot;</span><span class="p">,</span> <span class="s">&quot;lower&quot;</span><span class="p">,</span> <span class="s">&quot;upper&quot;</span><span class="p">,</span> <span class="s">&quot;z&quot;</span><span class="p">,</span> <span class="s">&quot;p&quot;</span><span class="p">],</span>
                         <span class="nb">list</span><span class="p">(</span><span class="n">observed</span><span class="o">.</span><span class="n">columns</span><span class="p">))</span>

        <span class="c"># Chromosomes</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">assertEqual</span><span class="p">([</span><span class="mi">22</span><span class="p">],</span> <span class="n">observed</span><span class="o">.</span><span class="n">chr</span><span class="o">.</span><span class="n">unique</span><span class="p">())</span>

        <span class="c"># Positions</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">assertEqual</span><span class="p">([</span><span class="mi">1</span><span class="p">,</span> <span class="mi">2</span><span class="p">,</span> <span class="mi">3</span><span class="p">],</span> <span class="nb">list</span><span class="p">(</span><span class="n">observed</span><span class="o">.</span><span class="n">pos</span><span class="p">))</span>

        <span class="c"># Marker names</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">assertEqual</span><span class="p">([</span><span class="s">&quot;marker_1&quot;</span><span class="p">,</span> <span class="s">&quot;marker_2&quot;</span><span class="p">,</span> <span class="s">&quot;marker_3&quot;</span><span class="p">],</span>
                         <span class="nb">list</span><span class="p">(</span><span class="n">observed</span><span class="o">.</span><span class="n">snp</span><span class="p">))</span>

        <span class="c"># Major alleles</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">assertEqual</span><span class="p">([</span><span class="s">&quot;T&quot;</span><span class="p">,</span> <span class="s">&quot;G&quot;</span><span class="p">,</span> <span class="s">&quot;AT&quot;</span><span class="p">],</span> <span class="nb">list</span><span class="p">(</span><span class="n">observed</span><span class="o">.</span><span class="n">major</span><span class="p">))</span>

        <span class="c"># Minor alleles</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">assertEqual</span><span class="p">([</span><span class="s">&quot;C&quot;</span><span class="p">,</span> <span class="s">&quot;A&quot;</span><span class="p">,</span> <span class="s">&quot;A&quot;</span><span class="p">],</span> <span class="nb">list</span><span class="p">(</span><span class="n">observed</span><span class="o">.</span><span class="n">minor</span><span class="p">))</span>

        <span class="c"># Minor allele frequency</span>
        <span class="n">expected</span> <span class="o">=</span> <span class="p">[</span><span class="mi">1778</span> <span class="o">/</span> <span class="mi">11880</span><span class="p">,</span> <span class="mi">4703</span> <span class="o">/</span> <span class="mi">11760</span><span class="p">,</span> <span class="mi">1427</span> <span class="o">/</span> <span class="mi">11880</span><span class="p">]</span>
        <span class="k">for</span> <span class="n">expected_maf</span><span class="p">,</span> <span class="n">observed_maf</span> <span class="ow">in</span> <span class="nb">zip</span><span class="p">(</span><span class="n">expected</span><span class="p">,</span> <span class="n">observed</span><span class="o">.</span><span class="n">maf</span><span class="p">):</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">assertAlmostEqual</span><span class="p">(</span><span class="n">expected_maf</span><span class="p">,</span> <span class="n">observed_maf</span><span class="p">,</span> <span class="n">places</span><span class="o">=</span><span class="mi">10</span><span class="p">)</span>

        <span class="c"># The number of samples</span>
        <span class="n">expected</span> <span class="o">=</span> <span class="p">[</span><span class="mi">5940</span><span class="p">,</span> <span class="mi">5880</span><span class="p">,</span> <span class="mi">5940</span><span class="p">]</span>
        <span class="k">for</span> <span class="n">expected_n</span><span class="p">,</span> <span class="n">observed_n</span> <span class="ow">in</span> <span class="nb">zip</span><span class="p">(</span><span class="n">expected</span><span class="p">,</span> <span class="n">observed</span><span class="o">.</span><span class="n">n</span><span class="p">):</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">assertEqual</span><span class="p">(</span><span class="n">expected_n</span><span class="p">,</span> <span class="n">observed_n</span><span class="p">)</span>

        <span class="c"># The coefficients</span>
        <span class="n">expected</span> <span class="o">=</span> <span class="p">[</span><span class="o">-</span><span class="mf">0.514309712761163662</span><span class="p">,</span> <span class="o">-</span><span class="mf">0.0409615621727604101</span><span class="p">,</span>
                    <span class="mf">0.6806154974808032998</span><span class="p">]</span>
        <span class="n">places</span> <span class="o">=</span> <span class="p">[</span><span class="mi">10</span><span class="p">,</span> <span class="mi">9</span><span class="p">,</span> <span class="mi">10</span><span class="p">]</span>
        <span class="n">zipped</span> <span class="o">=</span> <span class="nb">zip</span><span class="p">(</span><span class="n">expected</span><span class="p">,</span> <span class="n">observed</span><span class="o">.</span><span class="n">coef</span><span class="p">,</span> <span class="n">places</span><span class="p">)</span>
        <span class="k">for</span> <span class="n">expected_coef</span><span class="p">,</span> <span class="n">observed_coef</span><span class="p">,</span> <span class="n">place</span> <span class="ow">in</span> <span class="n">zipped</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">assertAlmostEqual</span><span class="p">(</span><span class="n">expected_coef</span><span class="p">,</span> <span class="n">observed_coef</span><span class="p">,</span> <span class="n">places</span><span class="o">=</span><span class="n">place</span><span class="p">)</span>

        <span class="c"># The standard error</span>
        <span class="n">expected</span> <span class="o">=</span> <span class="p">[</span><span class="mf">0.1148545370213169270</span><span class="p">,</span> <span class="mf">0.0898086129043478426</span><span class="p">,</span>
                    <span class="mf">0.1216909125194589325</span><span class="p">]</span>
        <span class="n">places</span> <span class="o">=</span> <span class="p">[</span><span class="mi">7</span><span class="p">,</span> <span class="mi">5</span><span class="p">,</span> <span class="mi">7</span><span class="p">]</span>
        <span class="n">zipped</span> <span class="o">=</span> <span class="nb">zip</span><span class="p">(</span><span class="n">expected</span><span class="p">,</span> <span class="n">observed</span><span class="o">.</span><span class="n">se</span><span class="p">,</span> <span class="n">places</span><span class="p">)</span>
        <span class="k">for</span> <span class="n">expected_se</span><span class="p">,</span> <span class="n">observed_se</span><span class="p">,</span> <span class="n">place</span> <span class="ow">in</span> <span class="n">zipped</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">assertAlmostEqual</span><span class="p">(</span><span class="n">expected_se</span><span class="p">,</span> <span class="n">observed_se</span><span class="p">,</span> <span class="n">places</span><span class="o">=</span><span class="n">place</span><span class="p">)</span>

        <span class="c"># The lower CI</span>
        <span class="n">expected</span> <span class="o">=</span> <span class="p">[</span><span class="o">-</span><span class="mf">0.741288870474143935</span><span class="p">,</span> <span class="o">-</span><span class="mf">0.217201661656271972</span><span class="p">,</span>
                    <span class="mf">0.442504664626339528</span><span class="p">]</span>
        <span class="n">places</span> <span class="o">=</span> <span class="p">[</span><span class="mi">2</span><span class="p">,</span> <span class="mi">3</span><span class="p">,</span> <span class="mi">3</span><span class="p">]</span>
        <span class="n">zipped</span> <span class="o">=</span> <span class="nb">zip</span><span class="p">(</span><span class="n">expected</span><span class="p">,</span> <span class="n">observed</span><span class="o">.</span><span class="n">lower</span><span class="p">,</span> <span class="n">places</span><span class="p">)</span>
        <span class="k">for</span> <span class="n">expected_min_ci</span><span class="p">,</span> <span class="n">observed_min_ci</span><span class="p">,</span> <span class="n">place</span> <span class="ow">in</span> <span class="n">zipped</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">assertAlmostEqual</span><span class="p">(</span><span class="n">expected_min_ci</span><span class="p">,</span> <span class="n">observed_min_ci</span><span class="p">,</span>
                                   <span class="n">places</span><span class="o">=</span><span class="n">place</span><span class="p">)</span>

        <span class="c"># The upper CI</span>
        <span class="n">expected</span> <span class="o">=</span> <span class="p">[</span><span class="o">-</span><span class="mf">0.290848443930769640</span><span class="p">,</span> <span class="mf">0.135039323830934560</span><span class="p">,</span>
                    <span class="mf">0.919770526738648897</span><span class="p">]</span>
        <span class="n">places</span> <span class="o">=</span> <span class="p">[</span><span class="mi">2</span><span class="p">,</span> <span class="mi">3</span><span class="p">,</span> <span class="mi">2</span><span class="p">]</span>
        <span class="n">zipped</span> <span class="o">=</span> <span class="nb">zip</span><span class="p">(</span><span class="n">expected</span><span class="p">,</span> <span class="n">observed</span><span class="o">.</span><span class="n">upper</span><span class="p">,</span> <span class="n">places</span><span class="p">)</span>
        <span class="k">for</span> <span class="n">expected_max_ci</span><span class="p">,</span> <span class="n">observed_max_ci</span><span class="p">,</span> <span class="n">place</span> <span class="ow">in</span> <span class="n">zipped</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">assertAlmostEqual</span><span class="p">(</span><span class="n">expected_max_ci</span><span class="p">,</span> <span class="n">observed_max_ci</span><span class="p">,</span>
                                   <span class="n">places</span><span class="o">=</span><span class="n">place</span><span class="p">)</span>

        <span class="c"># The Z statistics</span>
        <span class="n">expected</span> <span class="o">=</span> <span class="p">[</span><span class="o">-</span><span class="mf">4.477922475676412439</span><span class="p">,</span> <span class="o">-</span><span class="mf">0.456098372395387086</span><span class="p">,</span>
                    <span class="mf">5.592985403671533184</span><span class="p">]</span>
        <span class="n">places</span> <span class="o">=</span> <span class="p">[</span><span class="mi">6</span><span class="p">,</span> <span class="mi">4</span><span class="p">,</span> <span class="mi">5</span><span class="p">]</span>
        <span class="n">zipped</span> <span class="o">=</span> <span class="nb">zip</span><span class="p">(</span><span class="n">expected</span><span class="p">,</span> <span class="n">observed</span><span class="o">.</span><span class="n">z</span><span class="p">,</span> <span class="n">places</span><span class="p">)</span>
        <span class="k">for</span> <span class="n">expected_z</span><span class="p">,</span> <span class="n">observed_z</span><span class="p">,</span> <span class="n">place</span> <span class="ow">in</span> <span class="n">zipped</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">assertAlmostEqual</span><span class="p">(</span><span class="n">expected_z</span><span class="p">,</span> <span class="n">observed_z</span><span class="p">,</span> <span class="n">places</span><span class="o">=</span><span class="n">place</span><span class="p">)</span>

        <span class="c"># The p values</span>
        <span class="n">expected</span> <span class="o">=</span> <span class="p">[</span><span class="mf">7.53729612963125518e-06</span><span class="p">,</span> <span class="mf">6.48319240531214813e-01</span><span class="p">,</span>
                    <span class="mf">2.23198061422581463e-08</span><span class="p">]</span>
        <span class="n">places</span> <span class="o">=</span> <span class="p">[</span><span class="mi">5</span><span class="p">,</span> <span class="mi">5</span><span class="p">,</span> <span class="mi">5</span><span class="p">]</span>
        <span class="n">zipped</span> <span class="o">=</span> <span class="nb">zip</span><span class="p">(</span><span class="n">expected</span><span class="p">,</span> <span class="n">observed</span><span class="o">.</span><span class="n">p</span><span class="p">,</span> <span class="n">places</span><span class="p">)</span>
        <span class="k">for</span> <span class="n">expected_p</span><span class="p">,</span> <span class="n">observed_p</span><span class="p">,</span> <span class="n">place</span> <span class="ow">in</span> <span class="n">zipped</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">assertAlmostEqual</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">log10</span><span class="p">(</span><span class="n">expected_p</span><span class="p">),</span> <span class="n">np</span><span class="o">.</span><span class="n">log10</span><span class="p">(</span><span class="n">observed_p</span><span class="p">),</span>
                                   <span class="n">places</span><span class="o">=</span><span class="n">place</span><span class="p">)</span>

    <span class="nd">@unittest.skipIf</span><span class="p">(</span><span class="n">platform</span><span class="o">.</span><span class="n">system</span><span class="p">()</span> <span class="o">==</span> <span class="s">&quot;Darwin&quot;</span><span class="p">,</span></div>
                     <span class="s">&quot;multiprocessing not supported with Mac OS&quot;</span><span class="p">)</span>
    <span class="k">def</span> <span class="nf">test_full_fit_logistic_multiprocess</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
<div class="viewcode-block" id="TestImputedStatsLogistic.test_full_fit_logistic_multiprocess"><a class="viewcode-back" href="../../../module_content/gwip.tests.html#gwip.tests.test_imputed_stats.TestImputedStatsLogistic.test_full_fit_logistic_multiprocess">[docs]</a>        <span class="sd">&quot;&quot;&quot;Tests the full pipeline, logistic regression with &gt;1 processes.&quot;&quot;&quot;</span>
        <span class="c"># Reading the data</span>
        <span class="n">data_filename</span> <span class="o">=</span> <span class="n">resource_filename</span><span class="p">(</span>
            <span class="n">__name__</span><span class="p">,</span>
            <span class="s">&quot;data/regression_sim.txt.bz2&quot;</span><span class="p">,</span>
        <span class="p">)</span>

        <span class="c"># Creating the input files</span>
        <span class="n">o_prefix</span><span class="p">,</span> <span class="n">options</span> <span class="o">=</span> <span class="n">create_input_files</span><span class="p">(</span>
            <span class="n">i_filename</span><span class="o">=</span><span class="n">data_filename</span><span class="p">,</span>
            <span class="n">output_dirname</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">output_dir</span><span class="o">.</span><span class="n">name</span><span class="p">,</span>
            <span class="n">analysis_type</span><span class="o">=</span><span class="s">&quot;logistic&quot;</span><span class="p">,</span>
            <span class="n">pheno_name</span><span class="o">=</span><span class="s">&quot;y_d&quot;</span><span class="p">,</span>
            <span class="n">nb_process</span><span class="o">=</span><span class="mi">2</span><span class="p">,</span>
        <span class="p">)</span>

        <span class="c"># Executing the tool</span>
        <span class="n">main</span><span class="p">(</span><span class="n">args</span><span class="o">=</span><span class="n">options</span><span class="p">)</span>

        <span class="c"># Cleaning the handlers</span>
        <span class="n">clean_logging_handlers</span><span class="p">()</span>

        <span class="c"># Making sure the output file exists</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">assertTrue</span><span class="p">(</span><span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">isfile</span><span class="p">(</span><span class="n">o_prefix</span> <span class="o">+</span> <span class="s">&quot;.logistic.dosage&quot;</span><span class="p">))</span>

        <span class="c"># Reading the data</span>
        <span class="n">observed</span> <span class="o">=</span> <span class="n">pd</span><span class="o">.</span><span class="n">read_csv</span><span class="p">(</span><span class="n">o_prefix</span> <span class="o">+</span> <span class="s">&quot;.logistic.dosage&quot;</span><span class="p">,</span> <span class="n">sep</span><span class="o">=</span><span class="s">&quot;</span><span class="se">\t</span><span class="s">&quot;</span><span class="p">)</span>

        <span class="c"># Checking all columns are present</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">assertEqual</span><span class="p">([</span><span class="s">&quot;chr&quot;</span><span class="p">,</span> <span class="s">&quot;pos&quot;</span><span class="p">,</span> <span class="s">&quot;snp&quot;</span><span class="p">,</span> <span class="s">&quot;major&quot;</span><span class="p">,</span> <span class="s">&quot;minor&quot;</span><span class="p">,</span> <span class="s">&quot;maf&quot;</span><span class="p">,</span> <span class="s">&quot;n&quot;</span><span class="p">,</span>
                          <span class="s">&quot;coef&quot;</span><span class="p">,</span> <span class="s">&quot;se&quot;</span><span class="p">,</span> <span class="s">&quot;lower&quot;</span><span class="p">,</span> <span class="s">&quot;upper&quot;</span><span class="p">,</span> <span class="s">&quot;z&quot;</span><span class="p">,</span> <span class="s">&quot;p&quot;</span><span class="p">],</span>
                         <span class="nb">list</span><span class="p">(</span><span class="n">observed</span><span class="o">.</span><span class="n">columns</span><span class="p">))</span>

        <span class="c"># Chromosomes</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">assertEqual</span><span class="p">([</span><span class="mi">22</span><span class="p">],</span> <span class="n">observed</span><span class="o">.</span><span class="n">chr</span><span class="o">.</span><span class="n">unique</span><span class="p">())</span>

        <span class="c"># Positions</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">assertEqual</span><span class="p">([</span><span class="mi">1</span><span class="p">,</span> <span class="mi">2</span><span class="p">,</span> <span class="mi">3</span><span class="p">],</span> <span class="nb">list</span><span class="p">(</span><span class="n">observed</span><span class="o">.</span><span class="n">pos</span><span class="p">))</span>

        <span class="c"># Marker names</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">assertEqual</span><span class="p">([</span><span class="s">&quot;marker_1&quot;</span><span class="p">,</span> <span class="s">&quot;marker_2&quot;</span><span class="p">,</span> <span class="s">&quot;marker_3&quot;</span><span class="p">],</span>
                         <span class="nb">list</span><span class="p">(</span><span class="n">observed</span><span class="o">.</span><span class="n">snp</span><span class="p">))</span>

        <span class="c"># Major alleles</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">assertEqual</span><span class="p">([</span><span class="s">&quot;T&quot;</span><span class="p">,</span> <span class="s">&quot;G&quot;</span><span class="p">,</span> <span class="s">&quot;AT&quot;</span><span class="p">],</span> <span class="nb">list</span><span class="p">(</span><span class="n">observed</span><span class="o">.</span><span class="n">major</span><span class="p">))</span>

        <span class="c"># Minor alleles</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">assertEqual</span><span class="p">([</span><span class="s">&quot;C&quot;</span><span class="p">,</span> <span class="s">&quot;A&quot;</span><span class="p">,</span> <span class="s">&quot;A&quot;</span><span class="p">],</span> <span class="nb">list</span><span class="p">(</span><span class="n">observed</span><span class="o">.</span><span class="n">minor</span><span class="p">))</span>

        <span class="c"># Minor allele frequency</span>
        <span class="n">expected</span> <span class="o">=</span> <span class="p">[</span><span class="mi">1778</span> <span class="o">/</span> <span class="mi">11880</span><span class="p">,</span> <span class="mi">4703</span> <span class="o">/</span> <span class="mi">11760</span><span class="p">,</span> <span class="mi">1427</span> <span class="o">/</span> <span class="mi">11880</span><span class="p">]</span>
        <span class="k">for</span> <span class="n">expected_maf</span><span class="p">,</span> <span class="n">observed_maf</span> <span class="ow">in</span> <span class="nb">zip</span><span class="p">(</span><span class="n">expected</span><span class="p">,</span> <span class="n">observed</span><span class="o">.</span><span class="n">maf</span><span class="p">):</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">assertAlmostEqual</span><span class="p">(</span><span class="n">expected_maf</span><span class="p">,</span> <span class="n">observed_maf</span><span class="p">,</span> <span class="n">places</span><span class="o">=</span><span class="mi">10</span><span class="p">)</span>

        <span class="c"># The number of samples</span>
        <span class="n">expected</span> <span class="o">=</span> <span class="p">[</span><span class="mi">5940</span><span class="p">,</span> <span class="mi">5880</span><span class="p">,</span> <span class="mi">5940</span><span class="p">]</span>
        <span class="k">for</span> <span class="n">expected_n</span><span class="p">,</span> <span class="n">observed_n</span> <span class="ow">in</span> <span class="nb">zip</span><span class="p">(</span><span class="n">expected</span><span class="p">,</span> <span class="n">observed</span><span class="o">.</span><span class="n">n</span><span class="p">):</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">assertEqual</span><span class="p">(</span><span class="n">expected_n</span><span class="p">,</span> <span class="n">observed_n</span><span class="p">)</span>

        <span class="c"># The coefficients</span>
        <span class="n">expected</span> <span class="o">=</span> <span class="p">[</span><span class="o">-</span><span class="mf">0.514309712761163662</span><span class="p">,</span> <span class="o">-</span><span class="mf">0.0409615621727604101</span><span class="p">,</span>
                    <span class="mf">0.6806154974808032998</span><span class="p">]</span>
        <span class="n">places</span> <span class="o">=</span> <span class="p">[</span><span class="mi">10</span><span class="p">,</span> <span class="mi">9</span><span class="p">,</span> <span class="mi">10</span><span class="p">]</span>
        <span class="n">zipped</span> <span class="o">=</span> <span class="nb">zip</span><span class="p">(</span><span class="n">expected</span><span class="p">,</span> <span class="n">observed</span><span class="o">.</span><span class="n">coef</span><span class="p">,</span> <span class="n">places</span><span class="p">)</span>
        <span class="k">for</span> <span class="n">expected_coef</span><span class="p">,</span> <span class="n">observed_coef</span><span class="p">,</span> <span class="n">place</span> <span class="ow">in</span> <span class="n">zipped</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">assertAlmostEqual</span><span class="p">(</span><span class="n">expected_coef</span><span class="p">,</span> <span class="n">observed_coef</span><span class="p">,</span> <span class="n">places</span><span class="o">=</span><span class="n">place</span><span class="p">)</span>

        <span class="c"># The standard error</span>
        <span class="n">expected</span> <span class="o">=</span> <span class="p">[</span><span class="mf">0.1148545370213169270</span><span class="p">,</span> <span class="mf">0.0898086129043478426</span><span class="p">,</span>
                    <span class="mf">0.1216909125194589325</span><span class="p">]</span>
        <span class="n">places</span> <span class="o">=</span> <span class="p">[</span><span class="mi">7</span><span class="p">,</span> <span class="mi">5</span><span class="p">,</span> <span class="mi">7</span><span class="p">]</span>
        <span class="n">zipped</span> <span class="o">=</span> <span class="nb">zip</span><span class="p">(</span><span class="n">expected</span><span class="p">,</span> <span class="n">observed</span><span class="o">.</span><span class="n">se</span><span class="p">,</span> <span class="n">places</span><span class="p">)</span>
        <span class="k">for</span> <span class="n">expected_se</span><span class="p">,</span> <span class="n">observed_se</span><span class="p">,</span> <span class="n">place</span> <span class="ow">in</span> <span class="n">zipped</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">assertAlmostEqual</span><span class="p">(</span><span class="n">expected_se</span><span class="p">,</span> <span class="n">observed_se</span><span class="p">,</span> <span class="n">places</span><span class="o">=</span><span class="n">place</span><span class="p">)</span>

        <span class="c"># The lower CI</span>
        <span class="n">expected</span> <span class="o">=</span> <span class="p">[</span><span class="o">-</span><span class="mf">0.741288870474143935</span><span class="p">,</span> <span class="o">-</span><span class="mf">0.217201661656271972</span><span class="p">,</span>
                    <span class="mf">0.442504664626339528</span><span class="p">]</span>
        <span class="n">places</span> <span class="o">=</span> <span class="p">[</span><span class="mi">2</span><span class="p">,</span> <span class="mi">3</span><span class="p">,</span> <span class="mi">3</span><span class="p">]</span>
        <span class="n">zipped</span> <span class="o">=</span> <span class="nb">zip</span><span class="p">(</span><span class="n">expected</span><span class="p">,</span> <span class="n">observed</span><span class="o">.</span><span class="n">lower</span><span class="p">,</span> <span class="n">places</span><span class="p">)</span>
        <span class="k">for</span> <span class="n">expected_min_ci</span><span class="p">,</span> <span class="n">observed_min_ci</span><span class="p">,</span> <span class="n">place</span> <span class="ow">in</span> <span class="n">zipped</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">assertAlmostEqual</span><span class="p">(</span><span class="n">expected_min_ci</span><span class="p">,</span> <span class="n">observed_min_ci</span><span class="p">,</span>
                                   <span class="n">places</span><span class="o">=</span><span class="n">place</span><span class="p">)</span>

        <span class="c"># The upper CI</span>
        <span class="n">expected</span> <span class="o">=</span> <span class="p">[</span><span class="o">-</span><span class="mf">0.290848443930769640</span><span class="p">,</span> <span class="mf">0.135039323830934560</span><span class="p">,</span>
                    <span class="mf">0.919770526738648897</span><span class="p">]</span>
        <span class="n">places</span> <span class="o">=</span> <span class="p">[</span><span class="mi">2</span><span class="p">,</span> <span class="mi">3</span><span class="p">,</span> <span class="mi">2</span><span class="p">]</span>
        <span class="n">zipped</span> <span class="o">=</span> <span class="nb">zip</span><span class="p">(</span><span class="n">expected</span><span class="p">,</span> <span class="n">observed</span><span class="o">.</span><span class="n">upper</span><span class="p">,</span> <span class="n">places</span><span class="p">)</span>
        <span class="k">for</span> <span class="n">expected_max_ci</span><span class="p">,</span> <span class="n">observed_max_ci</span><span class="p">,</span> <span class="n">place</span> <span class="ow">in</span> <span class="n">zipped</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">assertAlmostEqual</span><span class="p">(</span><span class="n">expected_max_ci</span><span class="p">,</span> <span class="n">observed_max_ci</span><span class="p">,</span>
                                   <span class="n">places</span><span class="o">=</span><span class="n">place</span><span class="p">)</span>

        <span class="c"># The Z statistics</span>
        <span class="n">expected</span> <span class="o">=</span> <span class="p">[</span><span class="o">-</span><span class="mf">4.477922475676412439</span><span class="p">,</span> <span class="o">-</span><span class="mf">0.456098372395387086</span><span class="p">,</span>
                    <span class="mf">5.592985403671533184</span><span class="p">]</span>
        <span class="n">places</span> <span class="o">=</span> <span class="p">[</span><span class="mi">6</span><span class="p">,</span> <span class="mi">4</span><span class="p">,</span> <span class="mi">5</span><span class="p">]</span>
        <span class="n">zipped</span> <span class="o">=</span> <span class="nb">zip</span><span class="p">(</span><span class="n">expected</span><span class="p">,</span> <span class="n">observed</span><span class="o">.</span><span class="n">z</span><span class="p">,</span> <span class="n">places</span><span class="p">)</span>
        <span class="k">for</span> <span class="n">expected_z</span><span class="p">,</span> <span class="n">observed_z</span><span class="p">,</span> <span class="n">place</span> <span class="ow">in</span> <span class="n">zipped</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">assertAlmostEqual</span><span class="p">(</span><span class="n">expected_z</span><span class="p">,</span> <span class="n">observed_z</span><span class="p">,</span> <span class="n">places</span><span class="o">=</span><span class="n">place</span><span class="p">)</span>

        <span class="c"># The p values</span>
        <span class="n">expected</span> <span class="o">=</span> <span class="p">[</span><span class="mf">7.53729612963125518e-06</span><span class="p">,</span> <span class="mf">6.48319240531214813e-01</span><span class="p">,</span>
                    <span class="mf">2.23198061422581463e-08</span><span class="p">]</span>
        <span class="n">places</span> <span class="o">=</span> <span class="p">[</span><span class="mi">5</span><span class="p">,</span> <span class="mi">5</span><span class="p">,</span> <span class="mi">5</span><span class="p">]</span>
        <span class="n">zipped</span> <span class="o">=</span> <span class="nb">zip</span><span class="p">(</span><span class="n">expected</span><span class="p">,</span> <span class="n">observed</span><span class="o">.</span><span class="n">p</span><span class="p">,</span> <span class="n">places</span><span class="p">)</span>
        <span class="k">for</span> <span class="n">expected_p</span><span class="p">,</span> <span class="n">observed_p</span><span class="p">,</span> <span class="n">place</span> <span class="ow">in</span> <span class="n">zipped</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">assertAlmostEqual</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">log10</span><span class="p">(</span><span class="n">expected_p</span><span class="p">),</span> <span class="n">np</span><span class="o">.</span><span class="n">log10</span><span class="p">(</span><span class="n">observed_p</span><span class="p">),</span>
                                   <span class="n">places</span><span class="o">=</span><span class="n">place</span><span class="p">)</span>

    <span class="k">def</span> <span class="nf">test_full_fit_logistic_interaction</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span></div>
<div class="viewcode-block" id="TestImputedStatsLogistic.test_full_fit_logistic_interaction"><a class="viewcode-back" href="../../../module_content/gwip.tests.html#gwip.tests.test_imputed_stats.TestImputedStatsLogistic.test_full_fit_logistic_interaction">[docs]</a>        <span class="sd">&quot;&quot;&quot;Tests the full pipeline for logistic regression with interaction.&quot;&quot;&quot;</span>
        <span class="c"># Reading the data</span>
        <span class="n">data_filename</span> <span class="o">=</span> <span class="n">resource_filename</span><span class="p">(</span>
            <span class="n">__name__</span><span class="p">,</span>
            <span class="s">&quot;data/regression_sim_inter.txt.bz2&quot;</span><span class="p">,</span>
        <span class="p">)</span>

        <span class="c"># Creating the input files</span>
        <span class="n">o_prefix</span><span class="p">,</span> <span class="n">options</span> <span class="o">=</span> <span class="n">create_input_files</span><span class="p">(</span>
            <span class="n">i_filename</span><span class="o">=</span><span class="n">data_filename</span><span class="p">,</span>
            <span class="n">output_dirname</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">output_dir</span><span class="o">.</span><span class="n">name</span><span class="p">,</span>
            <span class="n">analysis_type</span><span class="o">=</span><span class="s">&quot;logistic&quot;</span><span class="p">,</span>
            <span class="n">pheno_name</span><span class="o">=</span><span class="s">&quot;y_d&quot;</span><span class="p">,</span>
            <span class="n">interaction</span><span class="o">=</span><span class="s">&quot;gender&quot;</span><span class="p">,</span>
        <span class="p">)</span>

        <span class="c"># Executing the tool</span>
        <span class="n">main</span><span class="p">(</span><span class="n">args</span><span class="o">=</span><span class="n">options</span><span class="p">)</span>

        <span class="c"># Cleaning the handlers</span>
        <span class="n">clean_logging_handlers</span><span class="p">()</span>

        <span class="c"># Making sure the output file exists</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">assertTrue</span><span class="p">(</span><span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">isfile</span><span class="p">(</span><span class="n">o_prefix</span> <span class="o">+</span> <span class="s">&quot;.logistic.dosage&quot;</span><span class="p">))</span>

        <span class="c"># Reading the data</span>
        <span class="n">observed</span> <span class="o">=</span> <span class="n">pd</span><span class="o">.</span><span class="n">read_csv</span><span class="p">(</span><span class="n">o_prefix</span> <span class="o">+</span> <span class="s">&quot;.logistic.dosage&quot;</span><span class="p">,</span> <span class="n">sep</span><span class="o">=</span><span class="s">&quot;</span><span class="se">\t</span><span class="s">&quot;</span><span class="p">)</span>

        <span class="c"># Checking all columns are present</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">assertEqual</span><span class="p">([</span><span class="s">&quot;chr&quot;</span><span class="p">,</span> <span class="s">&quot;pos&quot;</span><span class="p">,</span> <span class="s">&quot;snp&quot;</span><span class="p">,</span> <span class="s">&quot;major&quot;</span><span class="p">,</span> <span class="s">&quot;minor&quot;</span><span class="p">,</span> <span class="s">&quot;maf&quot;</span><span class="p">,</span> <span class="s">&quot;n&quot;</span><span class="p">,</span>
                          <span class="s">&quot;coef&quot;</span><span class="p">,</span> <span class="s">&quot;se&quot;</span><span class="p">,</span> <span class="s">&quot;lower&quot;</span><span class="p">,</span> <span class="s">&quot;upper&quot;</span><span class="p">,</span> <span class="s">&quot;z&quot;</span><span class="p">,</span> <span class="s">&quot;p&quot;</span><span class="p">],</span>
                         <span class="nb">list</span><span class="p">(</span><span class="n">observed</span><span class="o">.</span><span class="n">columns</span><span class="p">))</span>

        <span class="c"># Chromosomes</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">assertEqual</span><span class="p">([</span><span class="mi">22</span><span class="p">],</span> <span class="n">observed</span><span class="o">.</span><span class="n">chr</span><span class="o">.</span><span class="n">unique</span><span class="p">())</span>

        <span class="c"># Positions</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">assertEqual</span><span class="p">([</span><span class="mi">1</span><span class="p">,</span> <span class="mi">2</span><span class="p">,</span> <span class="mi">3</span><span class="p">],</span> <span class="nb">list</span><span class="p">(</span><span class="n">observed</span><span class="o">.</span><span class="n">pos</span><span class="p">))</span>

        <span class="c"># Marker names</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">assertEqual</span><span class="p">([</span><span class="s">&quot;marker_1&quot;</span><span class="p">,</span> <span class="s">&quot;marker_2&quot;</span><span class="p">,</span> <span class="s">&quot;marker_3&quot;</span><span class="p">],</span>
                         <span class="nb">list</span><span class="p">(</span><span class="n">observed</span><span class="o">.</span><span class="n">snp</span><span class="p">))</span>

        <span class="c"># Major alleles</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">assertEqual</span><span class="p">([</span><span class="s">&quot;T&quot;</span><span class="p">,</span> <span class="s">&quot;G&quot;</span><span class="p">,</span> <span class="s">&quot;AT&quot;</span><span class="p">],</span> <span class="nb">list</span><span class="p">(</span><span class="n">observed</span><span class="o">.</span><span class="n">major</span><span class="p">))</span>

        <span class="c"># Minor alleles</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">assertEqual</span><span class="p">([</span><span class="s">&quot;C&quot;</span><span class="p">,</span> <span class="s">&quot;A&quot;</span><span class="p">,</span> <span class="s">&quot;A&quot;</span><span class="p">],</span> <span class="nb">list</span><span class="p">(</span><span class="n">observed</span><span class="o">.</span><span class="n">minor</span><span class="p">))</span>

        <span class="c"># Minor allele frequency</span>
        <span class="n">expected</span> <span class="o">=</span> <span class="p">[</span><span class="mi">1778</span> <span class="o">/</span> <span class="mi">11880</span><span class="p">,</span> <span class="mi">4703</span> <span class="o">/</span> <span class="mi">11760</span><span class="p">,</span> <span class="mi">1427</span> <span class="o">/</span> <span class="mi">11880</span><span class="p">]</span>
        <span class="k">for</span> <span class="n">expected_maf</span><span class="p">,</span> <span class="n">observed_maf</span> <span class="ow">in</span> <span class="nb">zip</span><span class="p">(</span><span class="n">expected</span><span class="p">,</span> <span class="n">observed</span><span class="o">.</span><span class="n">maf</span><span class="p">):</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">assertAlmostEqual</span><span class="p">(</span><span class="n">expected_maf</span><span class="p">,</span> <span class="n">observed_maf</span><span class="p">,</span> <span class="n">places</span><span class="o">=</span><span class="mi">10</span><span class="p">)</span>

        <span class="c"># The number of samples</span>
        <span class="n">expected</span> <span class="o">=</span> <span class="p">[</span><span class="mi">5940</span><span class="p">,</span> <span class="mi">5880</span><span class="p">,</span> <span class="mi">5940</span><span class="p">]</span>
        <span class="k">for</span> <span class="n">expected_n</span><span class="p">,</span> <span class="n">observed_n</span> <span class="ow">in</span> <span class="nb">zip</span><span class="p">(</span><span class="n">expected</span><span class="p">,</span> <span class="n">observed</span><span class="o">.</span><span class="n">n</span><span class="p">):</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">assertEqual</span><span class="p">(</span><span class="n">expected_n</span><span class="p">,</span> <span class="n">observed_n</span><span class="p">)</span>

        <span class="c"># The coefficients</span>
        <span class="n">expected</span> <span class="o">=</span> <span class="p">[</span><span class="o">-</span><span class="mf">0.4998229445983128905</span><span class="p">,</span> <span class="mf">0.479196060192496665</span><span class="p">,</span>
                    <span class="o">-</span><span class="mf">0.081500925621293116</span><span class="p">]</span>
        <span class="n">places</span> <span class="o">=</span> <span class="p">[</span><span class="mi">10</span><span class="p">,</span> <span class="mi">9</span><span class="p">,</span> <span class="mi">10</span><span class="p">]</span>
        <span class="n">zipped</span> <span class="o">=</span> <span class="nb">zip</span><span class="p">(</span><span class="n">expected</span><span class="p">,</span> <span class="n">observed</span><span class="o">.</span><span class="n">coef</span><span class="p">,</span> <span class="n">places</span><span class="p">)</span>
        <span class="k">for</span> <span class="n">expected_coef</span><span class="p">,</span> <span class="n">observed_coef</span><span class="p">,</span> <span class="n">place</span> <span class="ow">in</span> <span class="n">zipped</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">assertAlmostEqual</span><span class="p">(</span><span class="n">expected_coef</span><span class="p">,</span> <span class="n">observed_coef</span><span class="p">,</span> <span class="n">places</span><span class="o">=</span><span class="n">place</span><span class="p">)</span>

        <span class="c"># The standard error</span>
        <span class="n">expected</span> <span class="o">=</span> <span class="p">[</span><span class="mf">0.2425924038476814093</span><span class="p">,</span> <span class="mf">0.1732540442374335965</span><span class="p">,</span>
                    <span class="mf">0.236081283702105793</span><span class="p">]</span>
        <span class="n">places</span> <span class="o">=</span> <span class="p">[</span><span class="mi">7</span><span class="p">,</span> <span class="mi">6</span><span class="p">,</span> <span class="mi">7</span><span class="p">]</span>
        <span class="n">zipped</span> <span class="o">=</span> <span class="nb">zip</span><span class="p">(</span><span class="n">expected</span><span class="p">,</span> <span class="n">observed</span><span class="o">.</span><span class="n">se</span><span class="p">,</span> <span class="n">places</span><span class="p">)</span>
        <span class="k">for</span> <span class="n">expected_se</span><span class="p">,</span> <span class="n">observed_se</span><span class="p">,</span> <span class="n">place</span> <span class="ow">in</span> <span class="n">zipped</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">assertAlmostEqual</span><span class="p">(</span><span class="n">expected_se</span><span class="p">,</span> <span class="n">observed_se</span><span class="p">,</span> <span class="n">places</span><span class="o">=</span><span class="n">place</span><span class="p">)</span>

        <span class="c"># The lower CI</span>
        <span class="n">expected</span> <span class="o">=</span> <span class="p">[</span><span class="o">-</span><span class="mf">0.9779101205637230620</span><span class="p">,</span> <span class="mf">0.140220059149237547</span><span class="p">,</span>
                    <span class="o">-</span><span class="mf">0.544942749175234886</span><span class="p">]</span>
        <span class="n">places</span> <span class="o">=</span> <span class="p">[</span><span class="mi">2</span><span class="p">,</span> <span class="mi">2</span><span class="p">,</span> <span class="mi">2</span><span class="p">]</span>
        <span class="n">zipped</span> <span class="o">=</span> <span class="nb">zip</span><span class="p">(</span><span class="n">expected</span><span class="p">,</span> <span class="n">observed</span><span class="o">.</span><span class="n">lower</span><span class="p">,</span> <span class="n">places</span><span class="p">)</span>
        <span class="k">for</span> <span class="n">expected_min_ci</span><span class="p">,</span> <span class="n">observed_min_ci</span><span class="p">,</span> <span class="n">place</span> <span class="ow">in</span> <span class="n">zipped</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">assertAlmostEqual</span><span class="p">(</span><span class="n">expected_min_ci</span><span class="p">,</span> <span class="n">observed_min_ci</span><span class="p">,</span>
                                   <span class="n">places</span><span class="o">=</span><span class="n">place</span><span class="p">)</span>

        <span class="c"># The upper CI</span>
        <span class="n">expected</span> <span class="o">=</span> <span class="p">[</span><span class="o">-</span><span class="mf">0.0263169240328645603</span><span class="p">,</span> <span class="mf">0.819710161131259829</span><span class="p">,</span>
                    <span class="mf">0.380931176186822595</span><span class="p">]</span>
        <span class="n">places</span> <span class="o">=</span> <span class="p">[</span><span class="mi">2</span><span class="p">,</span> <span class="mi">2</span><span class="p">,</span> <span class="mi">3</span><span class="p">]</span>
        <span class="n">zipped</span> <span class="o">=</span> <span class="nb">zip</span><span class="p">(</span><span class="n">expected</span><span class="p">,</span> <span class="n">observed</span><span class="o">.</span><span class="n">upper</span><span class="p">,</span> <span class="n">places</span><span class="p">)</span>
        <span class="k">for</span> <span class="n">expected_max_ci</span><span class="p">,</span> <span class="n">observed_max_ci</span><span class="p">,</span> <span class="n">place</span> <span class="ow">in</span> <span class="n">zipped</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">assertAlmostEqual</span><span class="p">(</span><span class="n">expected_max_ci</span><span class="p">,</span> <span class="n">observed_max_ci</span><span class="p">,</span>
                                   <span class="n">places</span><span class="o">=</span><span class="n">place</span><span class="p">)</span>

        <span class="c"># The Z statistics</span>
        <span class="n">expected</span> <span class="o">=</span> <span class="p">[</span><span class="o">-</span><span class="mf">2.0603404586078508665</span><span class="p">,</span> <span class="mf">2.765857860932753098</span><span class="p">,</span>
                    <span class="o">-</span><span class="mf">0.345224002272595865</span><span class="p">]</span>
        <span class="n">places</span> <span class="o">=</span> <span class="p">[</span><span class="mi">6</span><span class="p">,</span> <span class="mi">4</span><span class="p">,</span> <span class="mi">7</span><span class="p">]</span>
        <span class="n">zipped</span> <span class="o">=</span> <span class="nb">zip</span><span class="p">(</span><span class="n">expected</span><span class="p">,</span> <span class="n">observed</span><span class="o">.</span><span class="n">z</span><span class="p">,</span> <span class="n">places</span><span class="p">)</span>
        <span class="k">for</span> <span class="n">expected_z</span><span class="p">,</span> <span class="n">observed_z</span><span class="p">,</span> <span class="n">place</span> <span class="ow">in</span> <span class="n">zipped</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">assertAlmostEqual</span><span class="p">(</span><span class="n">expected_z</span><span class="p">,</span> <span class="n">observed_z</span><span class="p">,</span> <span class="n">places</span><span class="o">=</span><span class="n">place</span><span class="p">)</span>

        <span class="c"># The p values</span>
        <span class="n">expected</span> <span class="o">=</span> <span class="p">[</span><span class="mf">3.93660046768015970e-02</span><span class="p">,</span> <span class="mf">5.67732747277691768e-03</span><span class="p">,</span>
                    <span class="mf">7.29925975515044678e-01</span><span class="p">]</span>
        <span class="n">places</span> <span class="o">=</span> <span class="p">[</span><span class="mi">6</span><span class="p">,</span> <span class="mi">4</span><span class="p">,</span> <span class="mi">7</span><span class="p">]</span>
        <span class="n">zipped</span> <span class="o">=</span> <span class="nb">zip</span><span class="p">(</span><span class="n">expected</span><span class="p">,</span> <span class="n">observed</span><span class="o">.</span><span class="n">p</span><span class="p">,</span> <span class="n">places</span><span class="p">)</span>
        <span class="k">for</span> <span class="n">expected_p</span><span class="p">,</span> <span class="n">observed_p</span><span class="p">,</span> <span class="n">place</span> <span class="ow">in</span> <span class="n">zipped</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">assertAlmostEqual</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">log10</span><span class="p">(</span><span class="n">expected_p</span><span class="p">),</span> <span class="n">np</span><span class="o">.</span><span class="n">log10</span><span class="p">(</span><span class="n">observed_p</span><span class="p">),</span>
                                   <span class="n">places</span><span class="o">=</span><span class="n">place</span><span class="p">)</span>


<span class="nd">@unittest.skipIf</span><span class="p">(</span><span class="ow">not</span> <span class="n">HAS_SKAT</span><span class="p">,</span> <span class="s">&quot;SKAT is not installed&quot;</span><span class="p">)</span></div></div>
<span class="k">class</span> <span class="nc">TestImputedStatsSkat</span><span class="p">(</span><span class="n">unittest</span><span class="o">.</span><span class="n">TestCase</span><span class="p">):</span>

    <span class="n">tmp_dir</span> <span class="o">=</span> <span class="bp">None</span>
    <span class="n">args</span> <span class="o">=</span> <span class="bp">None</span>

    <span class="nd">@classmethod</span>
    <span class="k">def</span> <span class="nf">setUpClass</span><span class="p">(</span><span class="n">cls</span><span class="p">):</span>
        <span class="n">cls</span><span class="o">.</span><span class="n">tmp_dir</span> <span class="o">=</span> <span class="n">TemporaryDirectory</span><span class="p">(</span><span class="n">prefix</span><span class="o">=</span><span class="s">&quot;gwip_test_&quot;</span><span class="p">)</span>
        <span class="n">cls</span><span class="o">.</span><span class="n">args</span> <span class="o">=</span> <span class="n">cls</span><span class="o">.</span><span class="n">setup_skat_files</span><span class="p">(</span><span class="n">cls</span><span class="o">.</span><span class="n">tmp_dir</span><span class="o">.</span><span class="n">name</span><span class="p">)</span>

    <span class="nd">@classmethod</span>
    <span class="k">def</span> <span class="nf">tearDownClass</span><span class="p">(</span><span class="n">cls</span><span class="p">):</span>
        <span class="c"># Cleaning the temporary directory</span>
        <span class="n">cls</span><span class="o">.</span><span class="n">tmp_dir</span><span class="o">.</span><span class="n">cleanup</span><span class="p">()</span>

    <span class="k">def</span> <span class="nf">test_continuous</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="n">o_prefix</span> <span class="o">=</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">tmp_dir</span><span class="o">.</span><span class="n">name</span><span class="p">,</span> <span class="s">&quot;skat_test_continuous&quot;</span><span class="p">)</span>
        <span class="n">args</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">args</span> <span class="o">+</span> <span class="p">[</span>
            <span class="s">&quot;--pheno-name&quot;</span><span class="p">,</span> <span class="s">&quot;outcome_continuous&quot;</span><span class="p">,</span>
            <span class="s">&quot;--outcome-type&quot;</span><span class="p">,</span> <span class="s">&quot;continuous&quot;</span><span class="p">,</span>
            <span class="s">&quot;--out&quot;</span><span class="p">,</span> <span class="n">o_prefix</span><span class="p">,</span>
        <span class="p">]</span>

        <span class="c"># Executing the tool</span>
        <span class="n">main</span><span class="p">(</span><span class="n">args</span><span class="o">=</span><span class="n">args</span><span class="p">)</span>

        <span class="c"># Cleaning the handlers</span>
        <span class="n">clean_logging_handlers</span><span class="p">()</span>

        <span class="c"># The observed values</span>
        <span class="n">results_filename</span> <span class="o">=</span> <span class="n">o_prefix</span> <span class="o">+</span> <span class="s">&quot;.skat.dosage&quot;</span>
        <span class="n">observed</span> <span class="o">=</span> <span class="n">pd</span><span class="o">.</span><span class="n">read_csv</span><span class="p">(</span><span class="n">results_filename</span><span class="p">,</span> <span class="n">header</span><span class="o">=</span><span class="mi">0</span><span class="p">,</span> <span class="n">sep</span><span class="o">=</span><span class="s">&quot;</span><span class="se">\t</span><span class="s">&quot;</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">assertEqual</span><span class="p">((</span><span class="mi">3</span><span class="p">,</span> <span class="mi">3</span><span class="p">),</span> <span class="n">observed</span><span class="o">.</span><span class="n">shape</span><span class="p">)</span>

        <span class="c"># The SNP set ID</span>
        <span class="n">expected</span> <span class="o">=</span> <span class="p">[</span><span class="s">&quot;set1&quot;</span><span class="p">,</span> <span class="s">&quot;set2&quot;</span><span class="p">,</span> <span class="s">&quot;set3&quot;</span><span class="p">]</span>
        <span class="k">for</span> <span class="n">expected_id</span><span class="p">,</span> <span class="n">observed_id</span> <span class="ow">in</span> <span class="nb">zip</span><span class="p">(</span><span class="n">expected</span><span class="p">,</span> <span class="n">observed</span><span class="o">.</span><span class="n">snp_set_id</span><span class="p">):</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">assertEqual</span><span class="p">(</span><span class="n">expected_id</span><span class="p">,</span> <span class="n">observed_id</span><span class="p">)</span>

        <span class="c"># The p values</span>
        <span class="n">expected</span> <span class="o">=</span> <span class="p">[</span><span class="mf">0.002877041</span><span class="p">,</span> <span class="mf">0.09319144</span><span class="p">,</span> <span class="mf">0.002877041</span><span class="p">]</span>
        <span class="k">for</span> <span class="n">expected_p</span><span class="p">,</span> <span class="n">observed_p</span> <span class="ow">in</span> <span class="nb">zip</span><span class="p">(</span><span class="n">expected</span><span class="p">,</span> <span class="n">observed</span><span class="o">.</span><span class="n">p_value</span><span class="p">):</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">assertAlmostEqual</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">log10</span><span class="p">(</span><span class="n">expected_p</span><span class="p">),</span> <span class="n">np</span><span class="o">.</span><span class="n">log10</span><span class="p">(</span><span class="n">observed_p</span><span class="p">),</span>
                                   <span class="n">places</span><span class="o">=</span><span class="mi">10</span><span class="p">)</span>

        <span class="c"># The Q statistics</span>
        <span class="n">expected</span> <span class="o">=</span> <span class="p">[</span><span class="mf">298041.5</span><span class="p">,</span> <span class="mf">24870.14</span><span class="p">,</span> <span class="mf">298041.5</span><span class="p">]</span>
        <span class="k">for</span> <span class="n">expected_q</span><span class="p">,</span> <span class="n">observed_q</span> <span class="ow">in</span> <span class="nb">zip</span><span class="p">(</span><span class="n">expected</span><span class="p">,</span> <span class="n">observed</span><span class="o">.</span><span class="n">q_value</span><span class="p">):</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">assertAlmostEqual</span><span class="p">(</span><span class="n">expected_q</span><span class="p">,</span> <span class="n">observed_q</span><span class="p">,</span> <span class="n">places</span><span class="o">=</span><span class="mi">10</span><span class="p">)</span>

    <span class="k">def</span> <span class="nf">test_discrete</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="n">o_prefix</span> <span class="o">=</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">tmp_dir</span><span class="o">.</span><span class="n">name</span><span class="p">,</span> <span class="s">&quot;skat_test_discrete&quot;</span><span class="p">)</span>
        <span class="n">args</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">args</span> <span class="o">+</span> <span class="p">[</span>
            <span class="s">&quot;--pheno-name&quot;</span><span class="p">,</span> <span class="s">&quot;outcome_discrete&quot;</span><span class="p">,</span>
            <span class="s">&quot;--outcome-type&quot;</span><span class="p">,</span> <span class="s">&quot;discrete&quot;</span><span class="p">,</span>
            <span class="s">&quot;--out&quot;</span><span class="p">,</span> <span class="n">o_prefix</span><span class="p">,</span>
        <span class="p">]</span>

        <span class="c"># Executing the tool</span>
        <span class="n">main</span><span class="p">(</span><span class="n">args</span><span class="o">=</span><span class="n">args</span><span class="p">)</span>

        <span class="c"># Cleaning the handlers</span>
        <span class="n">clean_logging_handlers</span><span class="p">()</span>

        <span class="c"># The observed values</span>
        <span class="n">results_filename</span> <span class="o">=</span> <span class="n">o_prefix</span> <span class="o">+</span> <span class="s">&quot;.skat.dosage&quot;</span>
        <span class="n">observed</span> <span class="o">=</span> <span class="n">pd</span><span class="o">.</span><span class="n">read_csv</span><span class="p">(</span><span class="n">results_filename</span><span class="p">,</span> <span class="n">header</span><span class="o">=</span><span class="mi">0</span><span class="p">,</span> <span class="n">sep</span><span class="o">=</span><span class="s">&quot;</span><span class="se">\t</span><span class="s">&quot;</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">assertEqual</span><span class="p">((</span><span class="mi">3</span><span class="p">,</span> <span class="mi">3</span><span class="p">),</span> <span class="n">observed</span><span class="o">.</span><span class="n">shape</span><span class="p">)</span>

        <span class="c"># The SNP set ID</span>
        <span class="n">expected</span> <span class="o">=</span> <span class="p">[</span><span class="s">&quot;set1&quot;</span><span class="p">,</span> <span class="s">&quot;set2&quot;</span><span class="p">,</span> <span class="s">&quot;set3&quot;</span><span class="p">]</span>
        <span class="k">for</span> <span class="n">expected_id</span><span class="p">,</span> <span class="n">observed_id</span> <span class="ow">in</span> <span class="nb">zip</span><span class="p">(</span><span class="n">expected</span><span class="p">,</span> <span class="n">observed</span><span class="o">.</span><span class="n">snp_set_id</span><span class="p">):</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">assertEqual</span><span class="p">(</span><span class="n">expected_id</span><span class="p">,</span> <span class="n">observed_id</span><span class="p">)</span>

        <span class="c"># The p values</span>
        <span class="n">expected</span> <span class="o">=</span> <span class="p">[</span><span class="mf">0.1401991</span><span class="p">,</span> <span class="mf">0.5868036</span><span class="p">,</span> <span class="mf">0.1401991</span><span class="p">]</span>
        <span class="k">for</span> <span class="n">expected_p</span><span class="p">,</span> <span class="n">observed_p</span> <span class="ow">in</span> <span class="nb">zip</span><span class="p">(</span><span class="n">expected</span><span class="p">,</span> <span class="n">observed</span><span class="o">.</span><span class="n">p_value</span><span class="p">):</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">assertAlmostEqual</span><span class="p">(</span><span class="n">expected_p</span><span class="p">,</span> <span class="n">observed_p</span><span class="p">,</span> <span class="n">places</span><span class="o">=</span><span class="mi">10</span><span class="p">)</span>

        <span class="c"># The Q statistics</span>
        <span class="n">expected</span> <span class="o">=</span> <span class="p">[</span><span class="mf">34934.79</span><span class="p">,</span> <span class="mf">2776.797</span><span class="p">,</span> <span class="mf">34934.79</span><span class="p">]</span>
        <span class="k">for</span> <span class="n">expected_q</span><span class="p">,</span> <span class="n">observed_q</span> <span class="ow">in</span> <span class="nb">zip</span><span class="p">(</span><span class="n">expected</span><span class="p">,</span> <span class="n">observed</span><span class="o">.</span><span class="n">q_value</span><span class="p">):</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">assertAlmostEqual</span><span class="p">(</span><span class="n">expected_q</span><span class="p">,</span> <span class="n">observed_q</span><span class="p">,</span> <span class="n">places</span><span class="o">=</span><span class="mi">10</span><span class="p">)</span>

    <span class="k">def</span> <span class="nf">test_continuous_multiprocess</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="n">o_prefix</span> <span class="o">=</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">tmp_dir</span><span class="o">.</span><span class="n">name</span><span class="p">,</span> <span class="s">&quot;skat_test_continuous_mp&quot;</span><span class="p">)</span>
        <span class="n">args</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">args</span> <span class="o">+</span> <span class="p">[</span>
            <span class="s">&quot;--pheno-name&quot;</span><span class="p">,</span> <span class="s">&quot;outcome_continuous&quot;</span><span class="p">,</span>
            <span class="s">&quot;--outcome-type&quot;</span><span class="p">,</span> <span class="s">&quot;continuous&quot;</span><span class="p">,</span>
            <span class="s">&quot;--nb-process&quot;</span><span class="p">,</span> <span class="s">&quot;2&quot;</span><span class="p">,</span>
            <span class="s">&quot;--out&quot;</span><span class="p">,</span> <span class="n">o_prefix</span><span class="p">,</span>
        <span class="p">]</span>

        <span class="c"># Executing the tool</span>
        <span class="n">main</span><span class="p">(</span><span class="n">args</span><span class="o">=</span><span class="n">args</span><span class="p">)</span>

        <span class="c"># Cleaning the handlers</span>
        <span class="n">clean_logging_handlers</span><span class="p">()</span>

        <span class="c"># The observed values</span>
        <span class="n">results_filename</span> <span class="o">=</span> <span class="n">o_prefix</span> <span class="o">+</span> <span class="s">&quot;.skat.dosage&quot;</span>
        <span class="n">observed</span> <span class="o">=</span> <span class="n">pd</span><span class="o">.</span><span class="n">read_csv</span><span class="p">(</span><span class="n">results_filename</span><span class="p">,</span> <span class="n">header</span><span class="o">=</span><span class="mi">0</span><span class="p">,</span> <span class="n">sep</span><span class="o">=</span><span class="s">&quot;</span><span class="se">\t</span><span class="s">&quot;</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">assertEqual</span><span class="p">((</span><span class="mi">3</span><span class="p">,</span> <span class="mi">3</span><span class="p">),</span> <span class="n">observed</span><span class="o">.</span><span class="n">shape</span><span class="p">)</span>

        <span class="c"># The SNP set ID</span>
        <span class="n">expected</span> <span class="o">=</span> <span class="p">[</span><span class="s">&quot;set1&quot;</span><span class="p">,</span> <span class="s">&quot;set2&quot;</span><span class="p">,</span> <span class="s">&quot;set3&quot;</span><span class="p">]</span>
        <span class="k">for</span> <span class="n">expected_id</span><span class="p">,</span> <span class="n">observed_id</span> <span class="ow">in</span> <span class="nb">zip</span><span class="p">(</span><span class="n">expected</span><span class="p">,</span> <span class="n">observed</span><span class="o">.</span><span class="n">snp_set_id</span><span class="p">):</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">assertEqual</span><span class="p">(</span><span class="n">expected_id</span><span class="p">,</span> <span class="n">observed_id</span><span class="p">)</span>

        <span class="c"># The p values</span>
        <span class="n">expected</span> <span class="o">=</span> <span class="p">[</span><span class="mf">0.002877041</span><span class="p">,</span> <span class="mf">0.09319144</span><span class="p">,</span> <span class="mf">0.002877041</span><span class="p">]</span>
        <span class="k">for</span> <span class="n">expected_p</span><span class="p">,</span> <span class="n">observed_p</span> <span class="ow">in</span> <span class="nb">zip</span><span class="p">(</span><span class="n">expected</span><span class="p">,</span> <span class="n">observed</span><span class="o">.</span><span class="n">p_value</span><span class="p">):</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">assertAlmostEqual</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">log10</span><span class="p">(</span><span class="n">expected_p</span><span class="p">),</span> <span class="n">np</span><span class="o">.</span><span class="n">log10</span><span class="p">(</span><span class="n">observed_p</span><span class="p">),</span>
                                   <span class="n">places</span><span class="o">=</span><span class="mi">10</span><span class="p">)</span>

        <span class="c"># The Q statistics</span>
        <span class="n">expected</span> <span class="o">=</span> <span class="p">[</span><span class="mf">298041.5</span><span class="p">,</span> <span class="mf">24870.14</span><span class="p">,</span> <span class="mf">298041.5</span><span class="p">]</span>
        <span class="k">for</span> <span class="n">expected_q</span><span class="p">,</span> <span class="n">observed_q</span> <span class="ow">in</span> <span class="nb">zip</span><span class="p">(</span><span class="n">expected</span><span class="p">,</span> <span class="n">observed</span><span class="o">.</span><span class="n">q_value</span><span class="p">):</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">assertAlmostEqual</span><span class="p">(</span><span class="n">expected_q</span><span class="p">,</span> <span class="n">observed_q</span><span class="p">,</span> <span class="n">places</span><span class="o">=</span><span class="mi">10</span><span class="p">)</span>

    <span class="k">def</span> <span class="nf">test_discrete_multiprocess</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="n">o_prefix</span> <span class="o">=</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">tmp_dir</span><span class="o">.</span><span class="n">name</span><span class="p">,</span> <span class="s">&quot;skat_test_discrete_mp&quot;</span><span class="p">)</span>
        <span class="n">args</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">args</span> <span class="o">+</span> <span class="p">[</span>
            <span class="s">&quot;--pheno-name&quot;</span><span class="p">,</span> <span class="s">&quot;outcome_discrete&quot;</span><span class="p">,</span>
            <span class="s">&quot;--outcome-type&quot;</span><span class="p">,</span> <span class="s">&quot;discrete&quot;</span><span class="p">,</span>
            <span class="s">&quot;--nb-process&quot;</span><span class="p">,</span> <span class="s">&quot;2&quot;</span><span class="p">,</span>
            <span class="s">&quot;--out&quot;</span><span class="p">,</span> <span class="n">o_prefix</span><span class="p">,</span>
        <span class="p">]</span>

        <span class="c"># Executing the tool</span>
        <span class="n">main</span><span class="p">(</span><span class="n">args</span><span class="o">=</span><span class="n">args</span><span class="p">)</span>

        <span class="c"># Cleaning the handlers</span>
        <span class="n">clean_logging_handlers</span><span class="p">()</span>

        <span class="c"># The observed values</span>
        <span class="n">results_filename</span> <span class="o">=</span> <span class="n">o_prefix</span> <span class="o">+</span> <span class="s">&quot;.skat.dosage&quot;</span>
        <span class="n">observed</span> <span class="o">=</span> <span class="n">pd</span><span class="o">.</span><span class="n">read_csv</span><span class="p">(</span><span class="n">results_filename</span><span class="p">,</span> <span class="n">header</span><span class="o">=</span><span class="mi">0</span><span class="p">,</span> <span class="n">sep</span><span class="o">=</span><span class="s">&quot;</span><span class="se">\t</span><span class="s">&quot;</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">assertEqual</span><span class="p">((</span><span class="mi">3</span><span class="p">,</span> <span class="mi">3</span><span class="p">),</span> <span class="n">observed</span><span class="o">.</span><span class="n">shape</span><span class="p">)</span>

        <span class="c"># The SNP set ID</span>
        <span class="n">expected</span> <span class="o">=</span> <span class="p">[</span><span class="s">&quot;set1&quot;</span><span class="p">,</span> <span class="s">&quot;set2&quot;</span><span class="p">,</span> <span class="s">&quot;set3&quot;</span><span class="p">]</span>
        <span class="k">for</span> <span class="n">expected_id</span><span class="p">,</span> <span class="n">observed_id</span> <span class="ow">in</span> <span class="nb">zip</span><span class="p">(</span><span class="n">expected</span><span class="p">,</span> <span class="n">observed</span><span class="o">.</span><span class="n">snp_set_id</span><span class="p">):</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">assertEqual</span><span class="p">(</span><span class="n">expected_id</span><span class="p">,</span> <span class="n">observed_id</span><span class="p">)</span>

        <span class="c"># The p values</span>
        <span class="n">expected</span> <span class="o">=</span> <span class="p">[</span><span class="mf">0.1401991</span><span class="p">,</span> <span class="mf">0.5868036</span><span class="p">,</span> <span class="mf">0.1401991</span><span class="p">]</span>
        <span class="k">for</span> <span class="n">expected_p</span><span class="p">,</span> <span class="n">observed_p</span> <span class="ow">in</span> <span class="nb">zip</span><span class="p">(</span><span class="n">expected</span><span class="p">,</span> <span class="n">observed</span><span class="o">.</span><span class="n">p_value</span><span class="p">):</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">assertAlmostEqual</span><span class="p">(</span><span class="n">expected_p</span><span class="p">,</span> <span class="n">observed_p</span><span class="p">,</span> <span class="n">places</span><span class="o">=</span><span class="mi">10</span><span class="p">)</span>

        <span class="c"># The Q statistics</span>
        <span class="n">expected</span> <span class="o">=</span> <span class="p">[</span><span class="mf">34934.79</span><span class="p">,</span> <span class="mf">2776.797</span><span class="p">,</span> <span class="mf">34934.79</span><span class="p">]</span>
        <span class="k">for</span> <span class="n">expected_q</span><span class="p">,</span> <span class="n">observed_q</span> <span class="ow">in</span> <span class="nb">zip</span><span class="p">(</span><span class="n">expected</span><span class="p">,</span> <span class="n">observed</span><span class="o">.</span><span class="n">q_value</span><span class="p">):</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">assertAlmostEqual</span><span class="p">(</span><span class="n">expected_q</span><span class="p">,</span> <span class="n">observed_q</span><span class="p">,</span> <span class="n">places</span><span class="o">=</span><span class="mi">10</span><span class="p">)</span>

    <span class="nd">@staticmethod</span>
    <span class="k">def</span> <span class="nf">setup_skat_files</span><span class="p">(</span><span class="n">out_directory</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;Parses the SKAT example files into the format expected by gwip.&quot;&quot;&quot;</span>
        <span class="c"># Read the SKAT example files.</span>
        <span class="n">skat_x</span> <span class="o">=</span> <span class="n">pd</span><span class="o">.</span><span class="n">read_csv</span><span class="p">(</span>  <span class="c"># Covariates</span>
            <span class="n">resource_filename</span><span class="p">(</span>
                <span class="n">__name__</span><span class="p">,</span>
                <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="s">&quot;data&quot;</span><span class="p">,</span> <span class="s">&quot;skat_x_matrix.csv.bz2&quot;</span><span class="p">),</span>
            <span class="p">),</span>
            <span class="n">sep</span><span class="o">=</span><span class="s">&quot;,&quot;</span><span class="p">,</span>
            <span class="n">compression</span><span class="o">=</span><span class="s">&quot;bz2&quot;</span><span class="p">,</span>
            <span class="n">header</span><span class="o">=</span><span class="bp">None</span><span class="p">,</span>
            <span class="n">names</span><span class="o">=</span><span class="p">(</span><span class="s">&quot;covar_discrete&quot;</span><span class="p">,</span> <span class="s">&quot;covar_continuous&quot;</span><span class="p">),</span>
        <span class="p">)</span>

        <span class="n">skat_z</span> <span class="o">=</span> <span class="n">pd</span><span class="o">.</span><span class="n">read_csv</span><span class="p">(</span>  <span class="c"># Genotypes</span>
            <span class="n">resource_filename</span><span class="p">(</span>
                <span class="n">__name__</span><span class="p">,</span>
                <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="s">&quot;data&quot;</span><span class="p">,</span> <span class="s">&quot;skat_z_matrix.csv.bz2&quot;</span><span class="p">),</span>
            <span class="p">),</span>
            <span class="n">sep</span><span class="o">=</span><span class="s">&quot;,&quot;</span><span class="p">,</span>
            <span class="n">compression</span><span class="o">=</span><span class="s">&quot;bz2&quot;</span><span class="p">,</span>
            <span class="n">header</span><span class="o">=</span><span class="bp">None</span><span class="p">,</span>
        <span class="p">)</span>

        <span class="n">skat_y_continuous</span> <span class="o">=</span> <span class="n">pd</span><span class="o">.</span><span class="n">read_csv</span><span class="p">(</span>  <span class="c"># Outcome, continuous</span>
            <span class="n">resource_filename</span><span class="p">(</span>
                <span class="n">__name__</span><span class="p">,</span>
                <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="s">&quot;data&quot;</span><span class="p">,</span> <span class="s">&quot;skat_y_continuous_vector.csv.bz2&quot;</span><span class="p">),</span>
            <span class="p">),</span>
            <span class="n">sep</span><span class="o">=</span><span class="s">&quot;,&quot;</span><span class="p">,</span>
            <span class="n">compression</span><span class="o">=</span><span class="s">&quot;bz2&quot;</span><span class="p">,</span>
            <span class="n">header</span><span class="o">=</span><span class="bp">None</span><span class="p">,</span>
            <span class="n">names</span><span class="o">=</span><span class="p">(</span><span class="s">&quot;outcome_continuous&quot;</span><span class="p">,</span> <span class="p">),</span>
        <span class="p">)</span>

        <span class="n">skat_y_discrete</span> <span class="o">=</span> <span class="n">pd</span><span class="o">.</span><span class="n">read_csv</span><span class="p">(</span>  <span class="c"># Outcome, discrete</span>
            <span class="n">resource_filename</span><span class="p">(</span>
                <span class="n">__name__</span><span class="p">,</span>
                <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="s">&quot;data&quot;</span><span class="p">,</span> <span class="s">&quot;skat_y_discrete_vector.csv.bz2&quot;</span><span class="p">),</span>
            <span class="p">),</span>
            <span class="n">sep</span><span class="o">=</span><span class="s">&quot;,&quot;</span><span class="p">,</span>
            <span class="n">compression</span><span class="o">=</span><span class="s">&quot;bz2&quot;</span><span class="p">,</span>
            <span class="n">header</span><span class="o">=</span><span class="bp">None</span><span class="p">,</span>
            <span class="n">names</span><span class="o">=</span><span class="p">(</span><span class="s">&quot;outcome_discrete&quot;</span><span class="p">,</span> <span class="p">),</span>
        <span class="p">)</span>

        <span class="c"># Write the Impute2 file.</span>
        <span class="n">filename</span> <span class="o">=</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">out_directory</span><span class="p">,</span> <span class="s">&quot;impute2.txt&quot;</span><span class="p">)</span>
        <span class="n">variants</span> <span class="o">=</span> <span class="p">[]</span>
        <span class="k">with</span> <span class="nb">open</span><span class="p">(</span><span class="n">filename</span><span class="p">,</span> <span class="s">&quot;w&quot;</span><span class="p">)</span> <span class="k">as</span> <span class="n">output_file</span><span class="p">:</span>
            <span class="k">for</span> <span class="n">col_idx</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="n">skat_z</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">1</span><span class="p">]):</span>

                <span class="n">chrom</span> <span class="o">=</span> <span class="n">random</span><span class="o">.</span><span class="n">randint</span><span class="p">(</span><span class="mi">1</span><span class="p">,</span> <span class="mi">22</span><span class="p">)</span>
                <span class="n">pos</span> <span class="o">=</span> <span class="n">random</span><span class="o">.</span><span class="n">randint</span><span class="p">(</span><span class="mi">1000</span><span class="p">,</span> <span class="mi">90000000</span><span class="p">)</span>
                <span class="n">a1</span><span class="p">,</span> <span class="n">a2</span> <span class="o">=</span> <span class="n">random</span><span class="o">.</span><span class="n">sample</span><span class="p">(</span><span class="s">&quot;ATGC&quot;</span><span class="p">,</span> <span class="mi">2</span><span class="p">)</span>

                <span class="n">variant_name</span> <span class="o">=</span> <span class="s">&quot;{chrom}:{pos}:{a2}&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span>
                    <span class="n">chrom</span><span class="o">=</span><span class="n">chrom</span><span class="p">,</span> <span class="n">pos</span><span class="o">=</span><span class="n">pos</span><span class="p">,</span> <span class="n">a2</span><span class="o">=</span><span class="n">a2</span>
                <span class="p">)</span>
                <span class="n">variants</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">variant_name</span><span class="p">)</span>

                <span class="n">row</span> <span class="o">=</span> <span class="s">&quot;{chrom} {name} {pos} {a1} {a2}&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span>
                    <span class="n">chrom</span><span class="o">=</span><span class="n">chrom</span><span class="p">,</span> <span class="n">name</span><span class="o">=</span><span class="n">variant_name</span><span class="p">,</span> <span class="n">pos</span><span class="o">=</span><span class="n">pos</span><span class="p">,</span> <span class="n">a1</span><span class="o">=</span><span class="n">a1</span><span class="p">,</span> <span class="n">a2</span><span class="o">=</span><span class="n">a2</span><span class="p">,</span>
                <span class="p">)</span>

                <span class="n">dosage_list</span> <span class="o">=</span> <span class="p">[]</span>
                <span class="k">for</span> <span class="n">sample_idx</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="n">skat_z</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">0</span><span class="p">]):</span>
                    <span class="n">dosage</span> <span class="o">=</span> <span class="n">reverse_dosage</span><span class="p">(</span>
                        <span class="n">skat_z</span><span class="o">.</span><span class="n">iloc</span><span class="p">[</span><span class="n">sample_idx</span><span class="p">,</span> <span class="n">col_idx</span><span class="p">]</span>
                    <span class="p">)</span>

                    <span class="n">dosage_list</span><span class="o">.</span><span class="n">extend</span><span class="p">(</span><span class="n">dosage</span><span class="p">)</span>

                <span class="c"># Make sure all the probabilities are in the [0, 1] interval.</span>
                <span class="k">for</span> <span class="n">i</span><span class="p">,</span> <span class="n">proba</span> <span class="ow">in</span> <span class="nb">enumerate</span><span class="p">(</span><span class="n">dosage_list</span><span class="p">):</span>
                    <span class="k">if</span> <span class="n">proba</span> <span class="o">&lt;</span> <span class="mi">0</span><span class="p">:</span>
                        <span class="n">dosage_list</span><span class="p">[</span><span class="n">i</span><span class="p">]</span> <span class="o">=</span> <span class="mi">0</span>
                    <span class="k">elif</span> <span class="n">proba</span> <span class="o">&gt;</span> <span class="mi">1</span><span class="p">:</span>
                        <span class="n">dosage_list</span><span class="p">[</span><span class="n">i</span><span class="p">]</span> <span class="o">=</span> <span class="mi">1</span>

                <span class="k">print</span><span class="p">(</span><span class="n">row</span><span class="p">,</span> <span class="o">*</span><span class="n">dosage_list</span><span class="p">,</span> <span class="n">sep</span><span class="o">=</span><span class="s">&quot; &quot;</span><span class="p">,</span> <span class="nb">file</span><span class="o">=</span><span class="n">output_file</span><span class="p">)</span>

        <span class="c"># Create the snp set file.</span>
        <span class="n">filename</span> <span class="o">=</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">out_directory</span><span class="p">,</span> <span class="s">&quot;snp_sets.txt&quot;</span><span class="p">)</span>
        <span class="k">with</span> <span class="nb">open</span><span class="p">(</span><span class="n">filename</span><span class="p">,</span> <span class="s">&quot;w&quot;</span><span class="p">)</span> <span class="k">as</span> <span class="n">output_file</span><span class="p">:</span>
            <span class="k">print</span><span class="p">(</span><span class="s">&quot;variant&quot;</span><span class="p">,</span> <span class="s">&quot;snp_set&quot;</span><span class="p">,</span> <span class="n">sep</span><span class="o">=</span><span class="s">&quot;</span><span class="se">\t</span><span class="s">&quot;</span><span class="p">,</span> <span class="nb">file</span><span class="o">=</span><span class="n">output_file</span><span class="p">)</span>
            <span class="c"># The first SNP set</span>
            <span class="k">for</span> <span class="n">variant</span> <span class="ow">in</span> <span class="n">variants</span><span class="p">:</span>
                <span class="k">print</span><span class="p">(</span><span class="n">variant</span><span class="p">,</span> <span class="s">&quot;set1&quot;</span><span class="p">,</span> <span class="n">sep</span><span class="o">=</span><span class="s">&quot;</span><span class="se">\t</span><span class="s">&quot;</span><span class="p">,</span> <span class="nb">file</span><span class="o">=</span><span class="n">output_file</span><span class="p">)</span>

            <span class="c"># The second SNP set (which contains only the first 10 markers, and</span>
            <span class="c"># the last 10)</span>
            <span class="k">for</span> <span class="n">variant</span> <span class="ow">in</span> <span class="n">variants</span><span class="p">[:</span><span class="mi">10</span><span class="p">]</span> <span class="o">+</span> <span class="p">[</span><span class="n">variants</span><span class="p">[</span><span class="mi">30</span><span class="p">]]</span> <span class="o">+</span> <span class="n">variants</span><span class="p">[</span><span class="o">-</span><span class="mi">10</span><span class="p">:]:</span>
                <span class="k">print</span><span class="p">(</span><span class="n">variant</span><span class="p">,</span> <span class="s">&quot;set2&quot;</span><span class="p">,</span> <span class="n">sep</span><span class="o">=</span><span class="s">&quot;</span><span class="se">\t</span><span class="s">&quot;</span><span class="p">,</span> <span class="nb">file</span><span class="o">=</span><span class="n">output_file</span><span class="p">)</span>

            <span class="c"># The last SNP set (which is the same as the first one)</span>
            <span class="k">for</span> <span class="n">variant</span> <span class="ow">in</span> <span class="n">variants</span><span class="p">:</span>
                <span class="k">print</span><span class="p">(</span><span class="n">variant</span><span class="p">,</span> <span class="s">&quot;set3&quot;</span><span class="p">,</span> <span class="n">sep</span><span class="o">=</span><span class="s">&quot;</span><span class="se">\t</span><span class="s">&quot;</span><span class="p">,</span> <span class="nb">file</span><span class="o">=</span><span class="n">output_file</span><span class="p">)</span>

        <span class="c"># Create a list of samples.</span>
        <span class="n">samples</span> <span class="o">=</span> <span class="p">[</span><span class="s">&quot;sample_{}&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">i</span> <span class="o">+</span> <span class="mi">1</span><span class="p">)</span> <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="n">skat_z</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">0</span><span class="p">])]</span>

        <span class="c"># Get the filename for the phenotype file.</span>
        <span class="n">filename</span> <span class="o">=</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">out_directory</span><span class="p">,</span> <span class="s">&quot;phenotypes.txt&quot;</span><span class="p">)</span>

        <span class="c"># Before we can write it, we need to add a samples column.</span>
        <span class="n">skat_x</span><span class="p">[</span><span class="s">&quot;sample&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="n">samples</span>
        <span class="n">skat_x</span> <span class="o">=</span> <span class="n">skat_x</span><span class="p">[[</span><span class="s">&quot;sample&quot;</span><span class="p">,</span> <span class="s">&quot;covar_discrete&quot;</span><span class="p">,</span> <span class="s">&quot;covar_continuous&quot;</span><span class="p">]]</span>

        <span class="c"># We also add the outcomes to this (gwip uses a single file for both</span>
        <span class="c"># the outcome and the covariates).</span>
        <span class="n">skat_x</span><span class="p">[</span><span class="s">&quot;outcome_continuous&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="n">skat_y_continuous</span><span class="o">.</span><span class="n">values</span>
        <span class="n">skat_x</span><span class="p">[</span><span class="s">&quot;outcome_discrete&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="n">skat_y_discrete</span><span class="o">.</span><span class="n">values</span>

        <span class="c"># Write the phenotype file.</span>
        <span class="n">skat_x</span><span class="o">.</span><span class="n">to_csv</span><span class="p">(</span><span class="n">filename</span><span class="p">,</span> <span class="n">sep</span><span class="o">=</span><span class="s">&quot;</span><span class="se">\t</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">index</span><span class="o">=</span><span class="bp">False</span><span class="p">)</span>

        <span class="c"># Get the filename for the samples file.</span>
        <span class="n">filename</span> <span class="o">=</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">out_directory</span><span class="p">,</span> <span class="s">&quot;samples.txt&quot;</span><span class="p">)</span>

        <span class="c"># Now we write the samples file by imitating the Impute2 format.</span>
        <span class="k">with</span> <span class="nb">open</span><span class="p">(</span><span class="n">filename</span><span class="p">,</span> <span class="s">&quot;w&quot;</span><span class="p">)</span> <span class="k">as</span> <span class="n">f</span><span class="p">:</span>
            <span class="k">print</span><span class="p">(</span><span class="s">&quot;ID_1 ID_2 missing father mother sex phenotype&quot;</span><span class="p">,</span> <span class="nb">file</span><span class="o">=</span><span class="n">f</span><span class="p">)</span>
            <span class="k">print</span><span class="p">(</span><span class="s">&quot;0 0 0 D D D B&quot;</span><span class="p">,</span> <span class="nb">file</span><span class="o">=</span><span class="n">f</span><span class="p">)</span>
            <span class="k">for</span> <span class="n">sample</span> <span class="ow">in</span> <span class="n">samples</span><span class="p">:</span>
                <span class="k">print</span><span class="p">(</span><span class="n">sample</span><span class="p">,</span> <span class="n">sample</span><span class="p">,</span> <span class="s">&quot;0&quot;</span><span class="p">,</span> <span class="s">&quot;0&quot;</span><span class="p">,</span> <span class="s">&quot;0&quot;</span><span class="p">,</span> <span class="n">random</span><span class="o">.</span><span class="n">choice</span><span class="p">([</span><span class="mi">1</span><span class="p">,</span> <span class="mi">2</span><span class="p">]),</span>
                      <span class="s">&quot;-9&quot;</span><span class="p">,</span> <span class="nb">file</span><span class="o">=</span><span class="n">f</span><span class="p">,</span> <span class="n">sep</span><span class="o">=</span><span class="s">&quot; &quot;</span><span class="p">)</span>

        <span class="c"># Finally, prepare the arguments for the script.</span>
        <span class="n">args</span> <span class="o">=</span> <span class="p">[</span>
            <span class="s">&quot;skat&quot;</span><span class="p">,</span>
            <span class="s">&quot;--impute2&quot;</span><span class="p">,</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">out_directory</span><span class="p">,</span> <span class="s">&quot;impute2.txt&quot;</span><span class="p">),</span>
            <span class="s">&quot;--sample&quot;</span><span class="p">,</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">out_directory</span><span class="p">,</span> <span class="s">&quot;samples.txt&quot;</span><span class="p">),</span>
            <span class="s">&quot;--pheno&quot;</span><span class="p">,</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">out_directory</span><span class="p">,</span> <span class="s">&quot;phenotypes.txt&quot;</span><span class="p">),</span>
            <span class="s">&quot;--snp-set&quot;</span><span class="p">,</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">out_directory</span><span class="p">,</span> <span class="s">&quot;snp_sets.txt&quot;</span><span class="p">),</span>
            <span class="s">&quot;--covar&quot;</span><span class="p">,</span> <span class="s">&quot;covar_discrete,covar_continuous&quot;</span><span class="p">,</span>
            <span class="s">&quot;--sample-column&quot;</span><span class="p">,</span> <span class="s">&quot;sample&quot;</span><span class="p">,</span>
            <span class="s">&quot;--gender-column&quot;</span><span class="p">,</span> <span class="s">&quot;None&quot;</span><span class="p">,</span>
        <span class="p">]</span>

        <span class="k">return</span> <span class="n">args</span>
</pre></div>

          </div>
        </div>
      </div>
      <div class="clearer"></div>
    </div>
    <div class="related" role="navigation" aria-label="related navigation">
      <h3>Navigation</h3>
      <ul>
        <li class="right" style="margin-right: 10px">
          <a href="../../../genindex.html" title="General Index"
             >index</a></li>
        <li class="right" >
          <a href="../../../py-modindex.html" title="Python Module Index"
             >modules</a> |</li>
        <li class="nav-item nav-item-0"><a href="../../../index.html">gwip 1.0.0 documentation</a> &raquo;</li>
          <li class="nav-item nav-item-1"><a href="../../index.html" >Module code</a> &raquo;</li>
          <li class="nav-item nav-item-2"><a href="../../gwip.html" >gwip</a> &raquo;</li> 
      </ul>
    </div>
    <div class="footer" role="contentinfo">
        &copy; Copyright 2015, Beaulieu-Saucier Pharmacogenomics Centre.
      Created using <a href="http://sphinx-doc.org/">Sphinx</a> 1.3.1.
    </div>
  </body>
</html>